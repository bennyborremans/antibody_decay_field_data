---
title: "Inferring time of infection from field data using dynamic models of antibody decay"
author:
- Benny Borremans$^{1,2,3}$
- Riley O Mummah$^1$
- Angela H Guglielmino$^1$
- Renee L Galloway$^4$
- Niel Hens$^{2,5}$
- K C Prager$^1$
- James O Lloyd-Smith$^1$
date:  $^1$Ecology and Evolutionary Biology Department, University of California Los Angeles, United States \newline 
       $^2$I-BioStat, Data Science Institute, Hasselt University, Belgium \newline   
       $^3$Evolutionary Ecology Group, University of Antwerp, Belgium \newline   
       $^4$Centers for Disease Control and Prevention, United States \newline   
       $^5$Centre for Health Economic Research and Modelling Infectious Diseases, Vaccine & Infectious Disease Institute, University of Antwerp, Belgium \newline   
output:
  html_document: 
    code_folding: hide
    number_sections: yes
    theme: united
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r global_options, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(ggplot2)  # figures
library(kableExtra)   # tables
library(dplyr)  # data handling
library(RColorBrewer)  # figures
library(parallel)   # parallel processing mclapply function
library(ggmcmc)  # plotting functions
library(bayesplot)   # plotting functions
library(coda)   # mcmc diagnostics and plotting functions
library(patchwork)   # to plot figures as panels
library(rjags)  # jags from R
library(R2OpenBUGS)  # functions for handling rjags
library(loo)  #calculate WAIC
library(ggridges)  # figures
library(brms)   # bayesian regression using stan

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))  # set file folder as working directory, must save file first

# load functions   

# function to convert a list of chains to a dataframe, for better plotting
mcmclist.to.dataframe=function(mcmclist){
       
       output=as.data.frame(as.matrix(mcmclist[[1]]))
       output$chain=1
       output$iteration=attributes(mcmclist[[1]])$mcpar[1]:attributes(mcmclist[[1]])$mcpar[2]
       if(length(mcmclist)>1){
              for(i in 2:length(mcmclist)){
                     chain.df=as.data.frame(as.matrix(mcmclist[[i]]))
                     chain.df$chain=i
                     chain.df$iteration=attributes(mcmclist[[i]])$mcpar[1]:attributes(mcmclist[[i]])$mcpar[2]
                     output=rbind(output,chain.df)
              }
       }
       
       return(output)
}



# function to plot cross-correlation densities with heatmap
# source: https://slowkow.com/notes/ggplot2-color-by-density/
# Get density of points in 2 dimensions.
# @param x A numeric vector.
# @param y A numeric vector.
# @param n Create a square n by n grid to compute density.
# @return The density within each square.
get_density <- function(x, y, ...) {
       dens <- MASS::kde2d(x, y, ...)
       ix <- findInterval(x, dens$x)
       iy <- findInterval(y, dens$y)
       ii <- cbind(ix, iy)
       return(dens$z[ii])
}


# function to calculate the maximum posterior density of peak antibody level time
max.dens.fun = function(x, neg.interval) {
       density(x,bw = 5,from = neg.interval,to=0)$x[which.max(density(x)$y)]
}





# wrapper plotting function chains
plot.MCMC.chains = function(input.data, column.to.plot,y.axis.label,thinning=10,title="") {
       
       curdat = data.frame(posterior.dat = input.data[,column.to.plot],iteration =input.data[,"iteration"],chain =input.data[,"chain"])
       
       dens = density(curdat$posterior.dat)
       posterior.maxdens.overall=round(dens$x[which.max(dens$y)],10)
       posterior.mean.overall = mean(curdat$posterior.dat)
       hpd.int.toi = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
       
       iterations.to.keep.after.thinning = seq(0,nrow(curdat),thinning)
       
       curdat = curdat[iterations.to.keep.after.thinning,]
       
       plot1 = ggplot(data=curdat,aes(y=posterior.dat,x=iteration,col=chain,group=chain)) +
              geom_line(alpha=0.7) +
              scale_color_gradientn(colours = brewer.pal(11,"Spectral")) +
              geom_hline(yintercept=posterior.maxdens.overall,col="black",size=1) +
              geom_hline(yintercept=hpd.int.toi[1],col="black",size=1,linetype="dotted",alpha=0.7) +
              geom_hline(yintercept=hpd.int.toi[2],col="black",size=1,linetype="dotted",alpha=0.7) +
              ggtitle(title) +
              ylab(y.axis.label) +
              xlab("Iteration") +
              theme_light(base_family = "Avenir Next") +
              theme(plot.title = element_text(size = 11),
                    text=element_text(size=11),
                    axis.text=element_text(size=10),
                    axis.title.y = element_text(margin = ggplot2::margin(r=10)),
                    legend.position = "none"
              )
       plot1
}


RMSE.fun.linear.individual.decay = function(peak.titers,slopes,observed.data) {
       
       pred.vals = numeric(length(observed.data$log.titer))
       
       for(i in 1:length(unique(observed.data$id))){
              
              idx.current = which(observed.data$id == unique(observed.data$id)[i])
              
              pred.vals[idx.current] = linear.fun(peak.titer = peak.titers[i], slope = -slopes[i], time = observed.data$time.since.infection[idx.current])
              
       }
       
       
       N = nrow(observed.data)
       MSE = sum((observed.data$log.titer - pred.vals)^2)/N
       RMSE = sqrt(MSE)
       return(RMSE)
}

# calculate root mean square error 
RMSE.fun.double.exp.individual.decay = function(peak.titers,decay.rates,observed.data) {
       
       pred.vals = numeric(length(observed.data$titer))
       
       for(i in 1:length(unique(observed.data$id))){
              
              idx.current = which(observed.data$id == unique(observed.data$id)[i])
              
              pred.vals[idx.current] = exp.fun(start.titer = peak.titers[i], rate = decay.rates[i], time = observed.data$time.since.peak[idx.current])
              
       }
       
       
       N = nrow(observed.data)
       MSE = sum((observed.data$titer - pred.vals)^2)/N
       RMSE = sqrt(MSE)
       return(RMSE)
}



RMSE.fun.power.individual.decay = function(peak.titers,shapes,scales,observed.data) {
       
       pred.vals = numeric(length(observed.data$titer))
       
       for(i in 1:length(unique(observed.data$id))){
              
              idx.current = which(observed.data$id == unique(observed.data$id)[i])
              
              pred.vals[idx.current] = power.fun(peak.titer = peak.titers[i], shape = shapes[i], scale = scales[i], time = observed.data$time.since.infection[idx.current])
              
       }
       
       N = nrow(observed.data)
       MSE = sum((observed.data$titer - pred.vals)^2)/N
       RMSE = sqrt(MSE)
       return(RMSE)
}


# function to calculate titers following an exponential function
exp.fun = function(start.titer,rate,time) start.titer*exp(rate*time)



# function to calculate titers following a power function
# power function with shape parameter = 1 is the same as an exponential function.
# scale parameter is then decay rate:
power.fun = function(peak.titer, shape, scale, time){
       # enter peak titer as 1+log2(titer/100)
       peak.titer.log.e = log(100*2^(peak.titer-1))
       out.log.e = 1/(1-shape)*(log(exp(peak.titer.log.e)^(1-shape)-(1-shape)*scale*(time)))
       out.exp = exp(out.log.e)
       out.log.2 = 1+ log2(out.exp/100)
       return(out.log.2)
}



# function to calculate titers following a linear function
linear.fun = function(peak.titer, slope, time) peak.titer + slope*time



# calculate X% equal tailed credible interval for posterior mean
mean.eti = function(x,perc = 0.95) {
       lower.eti = x[order(x)][round(((1-perc)/2)*length(x))]
       upper.eti = x[order(x)][round(((perc)/2)*length(x))]
       
       return(data.frame(lower.eti = lower.eti, upper.eti = upper.eti))
}



#  calculate relative entropy / Kullback-Leibler divergence
#  measure of how much information has been gained
kl.divergence = function(prior.values,posterior.values) {
       prior.values.cut = cut(prior.values,breaks = seq(prior.values[1],0,1))
       probs.prior = as.data.frame(table(prior.values.cut))[,2]/length(prior.values.cut)
       
       posterior.values.cut = cut(posterior.values,breaks = seq(prior.values[1],0,1))
       probs.posterior = as.data.frame(table(posterior.values.cut))[,2]/length(posterior.values.cut)
       
       #remove zeros
       probs.prior = probs.prior[which(probs.posterior>0)]
       probs.posterior = probs.posterior[which(probs.posterior>0)]
       log.prior.post.ratio = log2(probs.posterior/probs.prior)
       
       
       kl.divergence.out = sum(probs.posterior * log.prior.post.ratio)
       
       return(kl.divergence.out)
}



# function to calculate the Gelman Rubin diagnostic    
gelman.fun = function(x,chains,iterations) {
       
       # following Brooks & Gelman 1998
       n = length(unique(iterations))
       m = length(unique(chains))
       
       
       # calculate variance between the chain means
       within.means = c()
       for(i in 1:m) within.means = c(within.means,mean(x[which(chains==unique(chains)[i])]))
       Bn = var(within.means)/(m-1)
       B = Bn*n
       
       # calculate within-chain variance
       within.var = c()
       for(i in 1:m) within.var = c(within.var,var(x[which(chains==unique(chains)[i])]))
       W = mean(within.var)
       
       # calculate mean of stationary distribution
       mu.hat = mean(x)
       
       # calculate variation of the stationary distribution
       sigma.hat2 = (n-1)*W/n + B/n
       
       # calculate pooled posterior variance
       V.hat = sigma.hat2 + B/(mu.hat*n)
       
       # calculate the variance of V.hat
       var.V.hat = ((n-1)/n)^2 * var(within.var)/m + ((m+1)/(m*n))^2 * (2/(m-1))*B^2 + 2*(m+1)*(n-1)/(m*n^2) * (n/m)*(cov(within.var,within.means^2)-(2*mu.hat*cov(within.var,within.means)))
       
       # calculate degrees of freedom using method of moments
       d = (2*V.hat)/var.V.hat
       
       # calculate convergence diagnostic
       
       R = ((d+3)/(d+1))*(V.hat/W)
       
       
       return(R)
}

```

[bennyborremans\@gmail.com](mailto:bennyborremans@gmail.com){.email}

------------------------------------------------------------------------


This document provides code used to generate results and figures shown in the paper "Inferring time of infection from field data using dynamic models of antibody decay".   
For more information and details, please see the paper and the supporting information document.   



------------------------------------------------------------------------

# Import and prepare data

```{r}

observed.data.for.fitting = readRDS("Antibody_decay_data.RDS")
observed.data.for.fitting.incl.neg = readRDS("Antibody_decay_data_incl_neg.RDS")

neg.intervals = observed.data.for.fitting.incl.neg$time[which(observed.data.for.fitting.incl.neg$seroconversion.interval==T)]


kbl(observed.data.for.fitting) %>%
       kable_classic(bootstrap_options  =  c("striped", "hover","condensed"), full_width=F,html_font="Cambria",fixed_thead=T) %>%
       scroll_box(height="400px")


```

## Observed data

N individuals = `r  length(unique(observed.data.for.fitting$id))`    
N samples = `r  nrow(observed.data.for.fitting)`

### Pomona

```{r fig.height = 4,fig.width = 6}

ggplot() +
       geom_line(data = observed.data.for.fitting.incl.neg,aes(x = time,y = titer.pomona,col = id,group = id),alpha = 0.4,size = 1,color="#9E0142") +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_classic(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 24),
             text = element_text(size = 11),
             axis.ticks = element_blank(),
             axis.text = element_blank(),
             axis.title  =  element_text(size=30,margin  =  ggplot2::margin(r = 10)),
             legend.position  =  "none")+
       xlab("Time since first positive") +
       ylab("Ab level (log2)")

ggplot() +
       geom_line(data = observed.data.for.fitting.incl.neg[1:400,],aes(x = time,y = titer.pomona,col = id,group = id),alpha = 0.4,size = 1,color="#9E0142") +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_classic(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 24),
             text = element_text(size = 11),
             axis.ticks = element_blank(),
             axis.text = element_blank(),
             axis.title  =  element_text(size=30,margin  =  ggplot2::margin(r = 10)),
             legend.position  =  "none")+
       xlab("Time since first positive") +
       ylab("Ab level (log2)")

ggplot() +
       geom_line(data = observed.data.for.fitting,aes(x = time,y = titer.pomona,col = id,group = id),alpha = 0.4,size = 0.6) +
       geom_point(data = observed.data.for.fitting,aes(x = time,y = titer.pomona,col = id,group = id),size=1.2,alpha = 0.9) +
       scale_color_gradientn(colours  =  brewer.pal(4,"Spectral")) +
       # scale_y_continuous(limits = c(2,10),breaks = 2:10) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 24),
             text = element_text(size = 11),
             axis.text = element_text(size = 10),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             legend.position  =  "none")+
       xlab("Time since first positive sample") +
       ylab("Antibody level (log2) Pomona")



```

### Autumnalis

```{r fig.height = 4,fig.width = 6}

ggplot() +
       geom_line(data = observed.data.for.fitting.incl.neg,aes(x = time,y = titer.aut,col = id,group = id),alpha = 0.4,size = 1,color="#9E0142") +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_classic(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 24),
             text = element_text(size = 11),
             axis.ticks = element_blank(),
             axis.text = element_blank(),
             axis.title  =  element_text(size=30,margin  =  ggplot2::margin(r = 10)),
             legend.position  =  "none")+
       xlab("Time since first positive") +
       ylab("Ab level (log2)")



ggplot() +
       geom_line(data = observed.data.for.fitting,aes(x = time,y = titer.aut,col = id,group = id),alpha = 0.4,size = 0.6) +
       geom_point(data = observed.data.for.fitting,aes(x = time,y = titer.aut,col = id,group = id),size=1.2,alpha = 0.9) +
       scale_color_gradientn(colours  =  brewer.pal(4,"Spectral")) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 24),
             text = element_text(size = 11),
             axis.text = element_text(size = 10),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             legend.position  =  "none")+
       xlab("Time since first positive sample") +
       ylab("Antibody level (log2) Autumnalis")



```

### Combined

```{r fig.height = 4, fig.width = 6}
plot.temp.dat = gather(observed.data.for.fitting,serovar,titer,c("titer.pomona","titer.aut"))
plot.temp.dat$id = paste0(plot.temp.dat$serovar,plot.temp.dat$id)

ggplot() +
       geom_line(data = plot.temp.dat,aes(x = time,y = titer,col = serovar,group = id),alpha = 0.3,size = 0.7) +
       #geom_point(data = observed.data.for.fitting.incl.neg,aes(x = time,y = titer.pomona,col = id,group = id),size=1.2,alpha = 0.9,col="grey") +
       #geom_point(data = observed.data.for.fitting.incl.neg,aes(x = time,y = titer.aut,col = id,group = id),size=1.2,alpha = 0.9,col="darkred") +
       #scale_color_gradientn(colours  =  brewer.pal(4,"Spectral")) +
       scale_color_manual(values = brewer.pal(11,"Spectral")[c(2,10)],labels = c("Autumnalis","Pomona"),name="Serovar") +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 24),
             text = element_text(size = 11),
             axis.text = element_text(size = 10),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             legend.position  =  c(0.75,0.75),
             legend.background = element_rect(colour = "transparent", fill = "transparent"))+
       xlab("Time since first positive sample") +
       ylab("Antibody level (log)")
```

Autumnalis levels increased by 0.2 for plotting purposes.

```{r fig.height = 4, fig.width = 6}
plot.temp.dat$titer[which(plot.temp.dat$serovar=="titer.aut")] = plot.temp.dat$titer[which(plot.temp.dat$serovar=="titer.aut")] + 0.2

ggplot() +
       #geom_line(data = plot.temp.dat,aes(x = time,y = titer,col = serovar,group = id),alpha = 0.3,size = 0.7) +
       geom_point(data = plot.temp.dat,aes(x = time,y = titer,col = serovar,group = id),alpha = 0.4,size = 0.7) +
       #geom_point(data = observed.data.for.fitting.incl.neg,aes(x = time,y = titer.aut,col = id,group = id),size=1.2,alpha = 0.9,col="darkred") +
       #scale_color_gradientn(colours  =  brewer.pal(4,"Spectral")) +
       scale_color_manual(values = brewer.pal(5,"Spectral")[c(1,5)],labels = c("Autumnalis","Pomona"),name="Serovar") +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 24),
             text = element_text(size = 11),
             axis.text = element_text(size = 10),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             legend.position  =  c(0.75,0.75),
             legend.background = element_rect(colour = "transparent", fill = "transparent"))+
       xlab("Time since first positive sample") +
       ylab("Antibody level (log)")


```


# Fit model parameters    

## Double exponential    

<br>

```{r}
# set prior parameters

peak.titer.mean.prior.mean.pomona = 7
peak.titer.mean.prior.sd.pomona = 2

peak.titer.sd.prior.pomona = 2.5  # for multivariate normal prior

peak.titer.mean.prior.mean.aut = 7.5
peak.titer.mean.prior.sd.aut = 2

peak.titer.sd.prior.aut = 3  # for multivariate normal prior


decay.rate.mean.prior.shape.pomona = 1
decay.rate.mean.prior.rate.pomona = 20

decay.rate.sd.prior.shape.pomona = 2   # 7
decay.rate.sd.prior.rate.pomona = 3   # 20000

decay.rate.mean.prior.shape.aut = 1
decay.rate.mean.prior.rate.aut = 20

decay.rate.sd.prior.shape.aut = 2  # 7
decay.rate.sd.prior.rate.aut = 3   # 20000

# parameters:
# 1 = error.sd, individual (log) normal error
# 2 : 1+N.inds = time of infection, individual, as time before first positive     
# 2+N.inds : 2+N.inds+N.inds = peak titer individual

N.inds = length(unique(observed.data.for.fitting$id))

uid = unique(observed.data.for.fitting$id)

# burn.in = 40000
# iterations = 50000  # = after burn in


burn.in = 10000
iterations = 50000  # = after burn in



run.mcmc=F


if(run.mcmc==T){
       
       model1.mod = function(){
              
              # priors
              for(j in 1:length(neg.int)){
                     
                     
                     # multivariate distribution for pom and aut peak titers
                     mu_pom_aut[j,1:2] ~ dmnorm(mu_pom_aut_mean,mu_pom_aut_precision)
                     
                     # extract mean peak levels for pom and aut
                     mu_pomona[j] <- mu_pom_aut[j,1]
                     mu_aut[j] <- mu_pom_aut[j,2]
                     
                     # decay rates pom and aut
                     decay_pomona[j] ~ dnorm(decay_overall_pomona,decay_tau_overall_pomona)
                     decay_aut[j] ~ dnorm(decay_overall_aut,decay_tau_overall_aut)
                     
                     # time between peak level and first positive, shared between pom and aut
                     theta[j] ~ dunif(neg.int[j],0)
              }
              
              sigma_pomona ~ dunif(0,50)
              tau_pomona <- 1/(sigma_pomona*sigma_pomona)
              
              sigma_aut ~ dunif(0,50)
              tau_aut <- 1/(sigma_aut*sigma_aut)
              
              lab_effect ~ dnorm(0,0.01)
              
              #hyper priors
              
              # multivariate pom aut mean and sd
              mu_pom_aut_mean ~ dmnorm(mu_means,tau_means)
              mu_pom_aut_precision ~ dwish(omega,wishdf)
              
              # extract individual means peak level
              mu_overall_pomona <- mu_pom_aut_mean[1]
              mu_overall_aut <- mu_pom_aut_mean[2]
              
              # multivariate precision matrix
              inverse_mu_pom_aut_precision <- inverse(mu_pom_aut_precision)
              sigma_overall_pomona <- inverse_mu_pom_aut_precision[1,1]^(1/2)
              sigma_overall_aut <- inverse_mu_pom_aut_precision[2,2]^(1/2)
              
              # decay rates            
              
              decay_overall_pomona ~ dgamma(decay.rate.mean.prior.shape.pomona,decay.rate.mean.prior.rate.pomona)
              decay_sigma_overall_pomona ~ dgamma(decay.rate.sd.prior.shape.pomona,decay.rate.sd.prior.rate.pomona)
              decay_tau_overall_pomona <- 1/(decay_sigma_overall_pomona*decay_sigma_overall_pomona)
              
              decay_overall_aut ~ dgamma(decay.rate.mean.prior.shape.aut,decay.rate.mean.prior.rate.aut)
              decay_sigma_overall_aut ~ dgamma(decay.rate.sd.prior.shape.aut,decay.rate.sd.prior.rate.aut)
              decay_tau_overall_aut <- 1/(decay_sigma_overall_aut*decay_sigma_overall_aut)
              
              
              # likelihood
              for(i in 1:length(time)){
                     # predicted level pomona
                     titer_pred_pomona[i] <- lab_effect*lab[i] + mu_pomona[id[i]]*exp(-decay_pomona[id[i]]*(time[i]-theta[id[i]]))
                     
                     true_titer_pomona[i] ~ dnorm(titer_pred_pomona[i],tau_pomona)
                     # interval censoring
                     titer_pomona[i] ~ dinterval(true_titer_pomona[i], c(1,2,3,4,5,6,7,8,9,10,11,12,13))
                     
                     # predicted level aut
                     titer_pred_aut[i] <- lab_effect*lab[i] + mu_aut[id[i]]*exp(-decay_aut[id[i]]*(time[i]-theta[id[i]]))
                     
                     true_titer_aut[i] ~ dnorm(titer_pred_aut[i],tau_aut)
                     # interval censoring
                     titer_aut[i] ~ dinterval(true_titer_aut[i], c(1,2,3,4,5,6,7,8,9,10,11,12,13))
                     
                     # store sum loglikelihood as parameter for WAIC calculation
                     LogLik[i] = log(dnorm(titer_pomona[i],true_titer_pomona[i],tau_pomona)) + log(dnorm(titer_aut[i],true_titer_aut[i],tau_aut))
              }
       }
       
       
       model.file = "jags_model.txt"
       write.model(model1.mod,model.file)
       
       
       model.jags = jags.model(model.file,
                               data=list('titer_pomona'=observed.data.for.fitting$titer.pomona,
                                         'titer_aut'=observed.data.for.fitting$titer.aut,
                                         'time'=observed.data.for.fitting$time,
                                         'id'=observed.data.for.fitting$id,
                                         'neg.int'=neg.intervals,
                                         'lab'=observed.data.for.fitting$lab,
                                         'mu_means' = c(peak.titer.mean.prior.mean.pomona,peak.titer.mean.prior.mean.aut),
                                         'tau_means' = diag(c((1/(peak.titer.mean.prior.sd.pomona^2)),(1/(peak.titer.mean.prior.sd.aut^2)))),
                                         'omega' = diag(c((1/(peak.titer.sd.prior.pomona^2)),(1/(peak.titer.sd.prior.aut^2)))),
                                         'wishdf' = 2,
                                         'decay.rate.mean.prior.shape.pomona' = decay.rate.mean.prior.shape.pomona,
                                         'decay.rate.mean.prior.rate.pomona' = decay.rate.mean.prior.rate.pomona,
                                         "decay.rate.sd.prior.shape.pomona" = decay.rate.sd.prior.shape.pomona,
                                         "decay.rate.sd.prior.rate.pomona" = decay.rate.sd.prior.rate.pomona,
                                         'decay.rate.mean.prior.shape.aut' = decay.rate.mean.prior.shape.aut,
                                         'decay.rate.mean.prior.rate.aut' = decay.rate.mean.prior.rate.aut,
                                         "decay.rate.sd.prior.shape.aut" = decay.rate.sd.prior.shape.aut,
                                         "decay.rate.sd.prior.rate.aut" = decay.rate.sd.prior.rate.aut
                                         
                               ),
                               #inits=list('beta0'=-1),
                               n.chains=6,
                               n.adapt = 1000)
       
       
       # burn in
       update(model.jags, n.iter = burn.in, by = 1)
       
       
       
       # draw samples
       post = coda.samples(model.jags, c("mu_overall_pomona","sigma_overall_pomona","decay_overall_pomona","decay_sigma_overall_pomona","decay_pomona","mu_overall_aut","sigma_overall_aut","decay_overall_aut","decay_sigma_overall_aut","decay_aut","theta","mu_pomona","mu_aut","LogLik","mu_pom_aut_mean","mu_pom_aut_precision","lab_effect"), n.iter = iterations, thin = 1)
       
       chains.burn.df = mcmclist.to.dataframe(post)
       
       rm(post)
       
       
       # save output, needs existing MCMC_runs folder in working directory
       filename = "MCMC_antibody_decay_double_exponential.RDS"
       print(filename)
       saveRDS(chains.burn.df,filename)
       
       
       
} else {
       # load previous output if not re-running model, speeds up markdown knitting
       chains.burn.df=readRDS("MCMC_antibody_decay_double_exponential.RDS")
}


chains.burn.df.original = chains.burn.df
# only keep last 20000 iterations for each chain
chains.burn.df = chains.burn.df  %>% 
       filter(iteration > (max(iteration)-20000))

parnames = c(paste0("LogLik",1:nrow(observed.data.for.fitting)),paste0("decay.rate.aut.",uid),"decay.rate.overall.aut","decay.rate.overall.pomona",paste0("decay.rate.pomona.",uid),"decay.rate.sd.overall.aut","decay.rate.sd.overall.pomona","lab.effect",paste0("peak.titer.aut.",uid),"peak.titer.overall.aut","peak.titer.overall.pomona",paste0("mu_pom_aut_mean_pom_",1:2),paste0("mu_pom_aut_precision_",1:4),paste0("peak.titer.pomona.",uid),"peak.titer.sd.overall.aut","peak.titer.sd.overall.pomona",paste0("toi.",uid),"chain","iteration")
       
colnames(chains.burn.df) = parnames
       

```


```{r}
# gelman rubin diagnostics, uncomment to run   

# gel.rub.apply.fun = function(x) gelman.fun(x = x,chains=chains.burn.df$chain,iterations = chains.burn.df$iteration)
# R.vals = gel.rub.apply.fun(chains.burn.df[,1])
# # 
# gel.rub = data.frame(variable = colnames(chains.burn.df)[-which(colnames(chains.burn.df) %in% c("chain","iteration"))],
#                      R = apply(chains.burn.df[-which(colnames(chains.burn.df) %in% c("chain","iteration"))],2,gel.rub.apply.fun))
# 

```


```{r}

# get posterior estimates of multivariate mean and precision matrix

mnorm_means = c(mean(chains.burn.df$mu_pom_aut_mean_pom_1),mean(chains.burn.df$mu_pom_aut_mean_pom_2))

precision_matrix = matrix(data = c(
       median(chains.burn.df$mu_pom_aut_precision_1),
       median(chains.burn.df$mu_pom_aut_precision_2),
       median(chains.burn.df$mu_pom_aut_precision_3),
       median(chains.burn.df$mu_pom_aut_precision_4)),ncol=2)


```

## Adjust time since first positive sample to estimated time since peak level

```{r}
observed.data.for.fitting$time.since.peak = NA

for(i in 1:length(uid)){
       idx.current = which(observed.data.for.fitting$id == uid[i])
       peak.titer.time = round(max.dens.fun(x = chains.burn.df[,paste0("toi.",i)],neg.interval = neg.intervals[i]))
       observed.data.for.fitting$time.since.peak[idx.current] = observed.data.for.fitting$time[idx.current] - peak.titer.time
}
```



## Single exponential

```{r}



if(run.mcmc==T){
       
       
       # set prior parameters
       
       peak.titer.mean.prior.mean.pomona = 7.5
       peak.titer.mean.prior.sd.pomona = 0.7
       
       peak.titer.sd.prior.pomona = 3  # for multivariate normal prior
       
       peak.titer.mean.prior.mean.aut = 7
       peak.titer.mean.prior.sd.aut = 0.7
       
       peak.titer.sd.prior.aut = 3  # for multivariate normal prior
       
       
       decay.rate.mean.prior.mean.pomona = 0.0009
       decay.rate.mean.prior.sd.pomona = 0.0001
       decay.rate.sd.prior.shape.pomona = 7
       decay.rate.sd.prior.rate.pomona = 20000
       
       decay.rate.mean.prior.mean.aut = 0.0009
       decay.rate.mean.prior.sd.aut = 0.0001
       decay.rate.sd.prior.shape.aut = 7
       decay.rate.sd.prior.rate.aut = 20000
       
       # parameters:
       # 1 = error.sd, individual (log) normal error
       # 2 : 1+N.inds = time of infection, individual, as time before first positive     
       # 2+N.inds : 2+N.inds+N.inds = peak titer individual
       
       N.inds = length(unique(observed.data.for.fitting$id))
       
       uid = unique(observed.data.for.fitting$id)
       
       burn.in = 40000
       iterations = 50000  # = after burn in
       
       
       model1.mod = function(){
              
              # priors
              for(j in 1:length(neg.int)){
                     
                     
                     # multivariate distribution for pom and aut peak titers
                     mu_pom_aut[j,1:2] ~ dmnorm(mu_pom_aut_mean,mu_pom_aut_precision)
                     
                     # extract mean peak levels for pom and aut
                     mu_pomona[j] <- mu_pom_aut[j,1]
                     mu_aut[j] <- mu_pom_aut[j,2]
                     
                     # decay rates pom and aut
                     decay_pomona[j] ~ dnorm(decay_overall_pomona,decay_tau_overall_pomona)
                     decay_aut[j] ~ dnorm(decay_overall_aut,decay_tau_overall_aut)
                     
                     # time between peak level and first positive, shared between pom and aut
                     theta[j] ~ dunif(neg.int[j],0)
              }
              
              sigma_pomona ~ dunif(0,50)
              tau_pomona <- 1/(sigma_pomona*sigma_pomona)
              
              sigma_aut ~ dunif(0,50)
              tau_aut <- 1/(sigma_aut*sigma_aut)
              
              lab_effect ~ dnorm(0,0.01)
              
              #hyper priors
              
              # multivariate pom aut mean and sd
              mu_pom_aut_mean ~ dmnorm(mu_means,tau_means)
              mu_pom_aut_precision ~ dwish(omega,wishdf)
              
              # extract individual means peak level
              mu_overall_pomona <- mu_pom_aut_mean[1]
              mu_overall_aut <- mu_pom_aut_mean[2]
              
              # multivariate precision matrix
              inverse_mu_pom_aut_precision <- inverse(mu_pom_aut_precision)
              sigma_overall_pomona <- inverse_mu_pom_aut_precision[1,1]^(1/2)
              sigma_overall_aut <- inverse_mu_pom_aut_precision[2,2]^(1/2)
              
              # decay rates            
              decay_overall_pomona ~ dnorm(decay.rate.mean.prior.mean.pomona,1/(decay.rate.mean.prior.sd.pomona*decay.rate.mean.prior.sd.pomona))
              decay_sigma_overall_pomona ~ dgamma(decay.rate.sd.prior.shape.pomona,decay.rate.sd.prior.rate.pomona)
              decay_tau_overall_pomona <- 1/(decay_sigma_overall_pomona*decay_sigma_overall_pomona)
              
              decay_overall_aut ~ dnorm(decay.rate.mean.prior.mean.aut,1/(decay.rate.mean.prior.sd.aut*decay.rate.mean.prior.sd.aut))
              decay_sigma_overall_aut ~ dgamma(decay.rate.sd.prior.shape.aut,decay.rate.sd.prior.rate.aut)
              decay_tau_overall_aut <- 1/(decay_sigma_overall_aut*decay_sigma_overall_aut)
              
              
              # likelihood
              for(i in 1:length(time)){
                     # predicted level pomona
                     
                     titer_pred_pomona[i] <- lab_effect*lab[i] +mu_pomona[id[i]] - decay_pomona[id[i]]*(time[i]-theta[id[i]])
                     true_titer_pomona[i] ~ dnorm(titer_pred_pomona[i],tau_pomona)
                     # interval censoring
                     titer_pomona[i] ~ dinterval(true_titer_pomona[i], c(1,2,3,4,5,6,7,8,9,10,11,12,13))
                     
                     # predicted level aut
                     titer_pred_aut[i] <- lab_effect*lab[i] +mu_aut[id[i]] - decay_aut[id[i]]*(time[i]-theta[id[i]])
                     true_titer_aut[i] ~ dnorm(titer_pred_aut[i],tau_aut)
                     # interval censoring
                     titer_aut[i] ~ dinterval(true_titer_aut[i], c(1,2,3,4,5,6,7,8,9,10,11,12,13))
                     
                     # store sum loglikelihood as parameter for WAIC calculation
                     LogLik[i] = log(dnorm(titer_pomona[i],true_titer_pomona[i],tau_pomona)) + log(dnorm(titer_aut[i],true_titer_aut[i],tau_aut))
              }
       }
       
       
       model.file = "jags_model.txt"
       write.model(model1.mod,model.file)
       
       
       model.jags = jags.model(model.file,
                               data=list('titer_pomona'=observed.data.for.fitting$titer.pomona,
                                         'titer_aut'=observed.data.for.fitting$titer.aut,
                                         'time'=observed.data.for.fitting$time,
                                         'id'=observed.data.for.fitting$id,
                                         'lab'=observed.data.for.fitting$lab,
                                         'neg.int'=neg.intervals,
                                         'mu_means' = c(peak.titer.mean.prior.mean.pomona,peak.titer.mean.prior.mean.aut),
                                         'tau_means' = diag(c((1/(peak.titer.mean.prior.sd.pomona^2)),(1/(peak.titer.mean.prior.sd.aut^2)))),
                                         'omega' = diag(c((1/(peak.titer.sd.prior.pomona^2)),(1/(peak.titer.sd.prior.aut^2)))),
                                         'wishdf' = 2,
                                         "decay.rate.mean.prior.mean.pomona" = decay.rate.mean.prior.mean.pomona,
                                         "decay.rate.mean.prior.sd.pomona" = decay.rate.mean.prior.sd.pomona,
                                         "decay.rate.sd.prior.shape.pomona" = decay.rate.sd.prior.shape.pomona,
                                         "decay.rate.sd.prior.rate.pomona" = decay.rate.sd.prior.rate.pomona,
                                         "decay.rate.mean.prior.mean.aut" = decay.rate.mean.prior.mean.aut,
                                         "decay.rate.mean.prior.sd.aut" = decay.rate.mean.prior.sd.aut,
                                         "decay.rate.sd.prior.shape.aut" = decay.rate.sd.prior.shape.aut,
                                         "decay.rate.sd.prior.rate.aut" = decay.rate.sd.prior.rate.aut
                                         
                               ),
                               #inits=list('beta0'=-1),
                               n.chains=6,
                               n.adapt = 2500)
       
       
       # burn in
       update(model.jags, n.iter = burn.in, by = 1)
       
       
       
       # draw samples
       post = coda.samples(model.jags, c("mu_overall_pomona","sigma_overall_pomona","decay_overall_pomona","decay_sigma_overall_pomona","decay_pomona","mu_overall_aut","sigma_overall_aut","decay_overall_aut","decay_sigma_overall_aut","decay_aut","theta","mu_pomona","mu_aut","LogLik","mu_pom_aut_mean","lab_effect"), n.iter = iterations, thin = 10)
       
       chains.burn.df = mcmclist.to.dataframe(post)
       
       # parnames = c(paste0("LogLik",1:nrow(observed.data.for.fitting)),paste0("decay.rate.aut.",uid),"decay.rate.overall.aut","decay.rate.overall.pomona",paste0("decay.rate.pomona.",uid),"decay.rate.sd.overall.aut","decay.rate.sd.overall.pomona",paste0("peak.titer.aut.",uid),"peak.titer.overall.aut","peak.titer.overall.pomona",paste0("mu_pom_aut_mean_pom_",1:2),paste0("mu_pom_aut_precision_",1:4),paste0("peak.titer.pomona.",uid),"peak.titer.sd.overall.aut","peak.titer.sd.overall.pomona",paste0("toi.",uid),"chain","iteration")
       # 
       # colnames(chains.burn.df) = parnames
       
       
       # save output, needs existing MCMC_runs folder in working directory
       filename = "MCMC_antibody_decay_single_exponential.RDS"
       print(filename)
       saveRDS(chains.burn.df,filename)
       
       
       
} else {
       # load previous output if not re-running model, speeds up markdown knitting
       chains.burn.df.1=readRDS("MCMC_antibody_decay_single_exponential.RDS")
}




```


## Power 

```{r}





if(run.mcmc==T){
       
       
       # set prior parameters
       
       peak.titer.mean.prior.mean.pomona = 7.5
       peak.titer.mean.prior.sd.pomona = 0.7
       
       peak.titer.sd.prior.pomona = 3  # for multivariate normal prior
       
       peak.titer.mean.prior.mean.aut = 7
       peak.titer.mean.prior.sd.aut = 0.7
       
       peak.titer.sd.prior.aut = 3  # for multivariate normal prior
       
       
       shape.sd.prior = 3
       scale.sd.prior = 0.003
       
       shape.mean.sd.prior = 1
       scale.mean.sd.prior = 0.0005
       
       
       log.mean.shape.prior.mean = log(0.5)
       log.mean.shape.prior.sd = 0.1
       log.mean.scale.prior.mean = log(0.0005)
       log.mean.scale.prior.sd = 1
       
       log.sd.shape.prior.shape = 2
       log.sd.shape.prior.rate = 0.75
       log.sd.scale.prior.shape = 2
       log.sd.scale.prior.rate = 0.5
       
       
       
       
       # parameters:
       # 1 = error.sd, individual (log) normal error
       # 2 : 1+N.inds = time of infection, individual, as time before first positive     
       # 2+N.inds : 2+N.inds+N.inds = peak titer individual
       
       N.inds = length(unique(observed.data.for.fitting$id))
       
       uid = unique(observed.data.for.fitting$id)
       
       burn.in = 40000
       iterations = 50000  # = after burn in
       
       
       
       model1.mod = function(){
              
              # priors
              for(j in 1:length(neg.int)){
                     
                     
                     # multivariate distribution for pom and aut peak titers
                     mu_pom_aut[j,1:2] ~ dmnorm(mu_pom_aut_mean,mu_pom_aut_precision)
                     
                     # extract mean peak levels for pom and aut
                     mu_pomona[j] <- mu_pom_aut[j,1]
                     exp.mu_pomona[j] <- 100*2^(mu_pomona[j]-1)
                     mu_aut[j] <- mu_pom_aut[j,2]
                     exp.mu_aut[j] <- 100*2^(mu_aut[j]-1)
                     
                     # decay parameters pom and aut
                     log_shape_scale_pomona[j,1:2] ~ dmnorm(shape_scale_pomona_mean,shape_scale_pomona_precision)
                     log.shape_pomona[j] <- log_shape_scale_pomona[j,1]
                     log.scale_pomona[j] <- log_shape_scale_pomona[j,2]
                     
                     shape_pomona[j] <- exp(log.shape_pomona[j]) + 1
                     scale_pomona[j] <- exp(log.scale_pomona[j])
                     
                     log_shape_scale_aut[j,1:2] ~ dmnorm(shape_scale_aut_mean,shape_scale_aut_precision)
                     log.shape_aut[j] <- log_shape_scale_aut[j,1]
                     log.scale_aut[j] <- log_shape_scale_aut[j,2]
                     
                     shape_aut[j] <- exp(log.shape_aut[j]) + 1
                     scale_aut[j] <- exp(log.scale_aut[j])
                     
                     
                     # time between peak level and first positive, shared between pom and aut
                     theta[j] ~ dunif(neg.int[j],0)
              }
              
              
              
              lab_effect ~ dnorm(0,0.01)
              
              sigma_pomona ~ dunif(0,50)
              tau_pomona <- 1/(sigma_pomona*sigma_pomona)
              
              sigma_aut ~ dunif(0,50)
              tau_aut <- 1/(sigma_aut*sigma_aut)
              
              
              #hyper priors
              
              # multivariate pom aut mean and sd
              mu_pom_aut_mean ~ dmnorm(mu_means,tau_means)
              mu_pom_aut_precision ~ dwish(omega,wishdf)
              
              # extract individual means peak level
              mu_overall_pomona <- mu_pom_aut_mean[1]
              mu_overall_aut <- mu_pom_aut_mean[2]
              
              # multivariate precision matrix
              inverse_mu_pom_aut_precision <- inverse(mu_pom_aut_precision)
              sigma_overall_pomona <- inverse_mu_pom_aut_precision[1,1]^(1/2)
              sigma_overall_aut <- inverse_mu_pom_aut_precision[2,2]^(1/2)
              
              
              
              # multivariate decay rate parameters pomona
              shape_scale_pomona_mean ~ dmnorm(mean_shape_scale_pomona_mean,mean_shape_scale_pomona_tau)
              shape_scale_pomona_precision ~ dwish(omega_shape_scale_pomona,wishdf_shape_scale_pomona)
              
              # extract individual means decay rate parameters pomona
              mu_overall_shape_pomona <- exp(shape_scale_pomona_mean[1])+1
              mu_overall_scale_pomona <- exp(shape_scale_pomona_mean[2])
              
              # multivariate precision matrix pomona
              inverse_mu_shape_scale_pomona_precision <- inverse(shape_scale_pomona_precision)
              sigma_overall_shape_pomona <- inverse_mu_shape_scale_pomona_precision[1,1]^(1/2)
              sigma_overall_scale_pomona <- inverse_mu_shape_scale_pomona_precision[2,2]^(1/2)
              
              
              
              # multivariate decay rate parameters aut
              shape_scale_aut_mean ~ dmnorm(mean_shape_scale_aut_mean,mean_shape_scale_aut_tau)
              shape_scale_aut_precision ~ dwish(omega_shape_scale_aut,wishdf_shape_scale_aut)
              
              # extract individual means decay rate parameters aut
              mu_overall_shape_aut <- exp(shape_scale_aut_mean[1])+1
              mu_overall_scale_aut <- exp(shape_scale_aut_mean[2])
              
              # multivariate precision matrix aut
              inverse_mu_shape_scale_aut_precision <- inverse(shape_scale_aut_precision)
              sigma_overall_shape_aut <- inverse_mu_shape_scale_aut_precision[1,1]^(1/2)
              sigma_overall_scale_aut <- inverse_mu_shape_scale_aut_precision[2,2]^(1/2)
              
              
              
              
              # likelihood
              for(i in 1:length(time)){
                     # predicted level pomona
                     titer_pred_pomona[i] <-  exp.mu_pomona[id[i]]*(1+(shape_pomona[id[i]]-1)*(exp.mu_pomona[id[i]]^(shape_pomona[id[i]]-1))*scale_pomona[id[i]]*(time[i]-theta[id[i]]))^(-1/(shape_pomona[id[i]]-1))
                     log2_titer_pred_pomona[i] <- 1+(log(titer_pred_pomona[i]/100)/log(2))
                     lab_effect_log2_titer_pred_pomona[i] <- lab_effect*lab[i] + log2_titer_pred_pomona[i]
                     true_titer_pomona[i] ~ dnorm(lab_effect_log2_titer_pred_pomona[i],tau_pomona)
                     # interval censoring
                     titer_pomona[i] ~ dinterval(true_titer_pomona[i], c(1,2,3,4,5,6,7,8,9,10,11,12,13))
                     
                     
                     titer_pred_aut[i] <-  exp.mu_aut[id[i]]*(1+(shape_aut[id[i]]-1)*(exp.mu_aut[id[i]]^(shape_aut[id[i]]-1))*scale_aut[id[i]]*(time[i]-theta[id[i]]))^(-1/(shape_aut[id[i]]-1))
                     log2_titer_pred_aut[i] <- 1+(log(titer_pred_aut[i]/100)/log(2))
                     lab_effect_log2_titer_pred_aut[i] <- lab_effect*lab[i] + log2_titer_pred_aut[i]
                     true_titer_aut[i] ~ dnorm(lab_effect_log2_titer_pred_aut[i],tau_aut)
                     # interval censoring
                     titer_aut[i] ~ dinterval(true_titer_aut[i], c(1,2,3,4,5,6,7,8,9,10,11,12,13))
                     
                     
                     # store sum loglikelihood as parameter for WAIC calculation
                     LogLik[i] = log(dnorm(titer_pomona[i],true_titer_pomona[i],tau_pomona)) + log(dnorm(titer_aut[i],true_titer_aut[i],tau_aut))
              }
       }
       
       
       
       model2.uncorrelated_shape_scale.mod = function(){
              
              # priors
              for(j in 1:length(neg.int)){
                     
                     
                     # multivariate distribution for pom and aut peak titers
                     mu_pom_aut[j,1:2] ~ dmnorm(mu_pom_aut_mean,mu_pom_aut_precision)
                     
                     # extract mean peak levels for pom and aut
                     mu_pomona[j] <- mu_pom_aut[j,1]
                     exp.mu_pomona[j] <- 100*2^(mu_pomona[j]-1)
                     mu_aut[j] <- mu_pom_aut[j,2]
                     exp.mu_aut[j] <- 100*2^(mu_aut[j]-1)
                     
                     # decay parameters pom and aut
                     log.shape_pomona[j] ~ dnorm(log_shape_pomona_overall_mean,log_shape_pomona_overall_tau)
                     log.scale_pomona[j] ~ dnorm(log_scale_pomona_overall_mean,log_scale_pomona_overall_tau)
                     
                     shape_pomona[j] <- exp(log.shape_pomona[j]) + 1
                     scale_pomona[j] <- exp(log.scale_pomona[j])
                     
                     log.shape_aut[j] ~ dnorm(log_shape_aut_overall_mean,log_shape_aut_overall_tau)
                     log.scale_aut[j] ~ dnorm(log_scale_aut_overall_mean,log_scale_aut_overall_tau)
                     
                     shape_aut[j] <- exp(log.shape_aut[j]) + 1
                     scale_aut[j] <- exp(log.scale_aut[j])
                     
                     
                     # time between peak level and first positive, shared between pom and aut
                     theta[j] ~ dunif(neg.int[j],0)
              }
              
              
              
              lab_effect ~ dnorm(0,0.01)
              
              sigma_pomona ~ dunif(0,50)
              tau_pomona <- 1/(sigma_pomona*sigma_pomona)
              
              sigma_aut ~ dunif(0,50)
              tau_aut <- 1/(sigma_aut*sigma_aut)
              
              
              #hyper priors
              
              # multivariate pom aut mean and sd
              mu_pom_aut_mean ~ dmnorm(mu_means,tau_means)
              mu_pom_aut_precision ~ dwish(omega,wishdf)
              
              # extract serovar peak level means
              mu_overall_pomona <- mu_pom_aut_mean[1]
              mu_overall_aut <- mu_pom_aut_mean[2]
              
              # multivariate precision matrix
              inverse_mu_pom_aut_precision <- inverse(mu_pom_aut_precision)
              sigma_overall_pomona <- inverse_mu_pom_aut_precision[1,1]^(1/2)
              sigma_overall_aut <- inverse_mu_pom_aut_precision[2,2]^(1/2)
              
              
              
              # decay rate parameters pomona
              log_shape_pomona_overall_mean ~ dnorm(log_shape_pomona_overall_mean_prior_mean,1/(log_shape_pomona_overall_mean_prior_sd*log_shape_pomona_overall_mean_prior_sd))
              
              log_shape_pomona_overall_sd ~ dgamma(log_shape_pomona_overall_sd_prior_shape,log_shape_pomona_overall_sd_prior_rate)
              log_shape_pomona_overall_tau <- 1/(log_shape_pomona_overall_sd*log_shape_pomona_overall_sd)
              
              shape_pomona_overall_mean <- exp(log_shape_pomona_overall_mean) + 1
              
              
              log_scale_pomona_overall_mean ~ dnorm(log_scale_pomona_overall_mean_prior_mean,1/(log_scale_pomona_overall_mean_prior_sd*log_scale_pomona_overall_mean_prior_sd))
              
              log_scale_pomona_overall_sd ~ dgamma(log_scale_pomona_overall_sd_prior_shape,log_scale_pomona_overall_sd_prior_rate)
              log_scale_pomona_overall_tau <- 1/(log_scale_pomona_overall_sd*log_scale_pomona_overall_sd)
              
              scale_pomona_overall_mean <- exp(log_scale_pomona_overall_mean)
              
              
              
              
              # decay rate parameters aut
              log_shape_aut_overall_mean ~ dnorm(log_shape_aut_overall_mean_prior_mean,1/(log_shape_aut_overall_mean_prior_sd*log_shape_aut_overall_mean_prior_sd))
              
              log_shape_aut_overall_sd ~ dgamma(log_shape_aut_overall_sd_prior_shape,log_shape_aut_overall_sd_prior_rate)
              log_shape_aut_overall_tau <- 1/(log_shape_aut_overall_sd*log_shape_aut_overall_sd)
              
              shape_aut_overall_mean <- exp(log_shape_aut_overall_mean) + 1
              
              
              log_scale_aut_overall_mean ~ dnorm(log_scale_aut_overall_mean_prior_mean,1/(log_scale_aut_overall_mean_prior_sd*log_scale_aut_overall_mean_prior_sd))
              
              log_scale_aut_overall_sd ~ dgamma(log_scale_aut_overall_sd_prior_shape,log_scale_aut_overall_sd_prior_rate)
              log_scale_aut_overall_tau <- 1/(log_scale_aut_overall_sd*log_scale_aut_overall_sd)
              
              scale_aut_overall_mean <- exp(log_scale_aut_overall_mean)
              
              
              
              
              
              
              # likelihood
              for(i in 1:length(time)){
                     
                     # predicted level pomona
                     titer_pred_pomona[i] <-  exp.mu_pomona[id[i]]*(1+(shape_pomona[id[i]]-1)*(exp.mu_pomona[id[i]]^(shape_pomona[id[i]]-1))*scale_pomona[id[i]]*(time[i]-theta[id[i]]))^(-1/(shape_pomona[id[i]]-1))
                     log2_titer_pred_pomona[i] <- 1+(log(titer_pred_pomona[i]/100)/log(2))
                     lab_effect_log2_titer_pred_pomona[i] <- lab_effect*lab[i] + log2_titer_pred_pomona[i]
                     true_titer_pomona[i] ~ dnorm(lab_effect_log2_titer_pred_pomona[i],tau_pomona)
                     # interval censoring
                     titer_pomona[i] ~ dinterval(true_titer_pomona[i], c(1,2,3,4,5,6,7,8,9,10,11,12,13))
                     
                     
                     titer_pred_aut[i] <-  exp.mu_aut[id[i]]*(1+(shape_aut[id[i]]-1)*(exp.mu_aut[id[i]]^(shape_aut[id[i]]-1))*scale_aut[id[i]]*(time[i]-theta[id[i]]))^(-1/(shape_aut[id[i]]-1))
                     log2_titer_pred_aut[i] <- 1+(log(titer_pred_aut[i]/100)/log(2))
                     lab_effect_log2_titer_pred_aut[i] <- lab_effect*lab[i] + log2_titer_pred_aut[i]
                     true_titer_aut[i] ~ dnorm(lab_effect_log2_titer_pred_aut[i],tau_aut)
                     # interval censoring
                     titer_aut[i] ~ dinterval(true_titer_aut[i], c(1,2,3,4,5,6,7,8,9,10,11,12,13))
                     
                     
                     # store sum loglikelihood as parameter for WAIC calculation
                     LogLik[i] = log(dnorm(titer_pomona[i],true_titer_pomona[i],tau_pomona)) + log(dnorm(titer_aut[i],true_titer_aut[i],tau_aut))
              }
       }
       
       
       
       
       model.file = "jags_model.txt"
       write.model(model2.uncorrelated_shape_scale.mod,model.file)
       
       
       model.jags = jags.model(model.file,
                               data=list('titer_pomona'=observed.data.for.fitting$titer.pomona,
                                         'titer_aut'=observed.data.for.fitting$titer.aut,
                                         'time'=observed.data.for.fitting$time,
                                         'id'=observed.data.for.fitting$id,
                                         'neg.int'=neg.intervals,
                                         'lab'=observed.data.for.fitting$lab,
                                         'mu_means' = c(peak.titer.mean.prior.mean.pomona,peak.titer.mean.prior.mean.aut),
                                         'tau_means' = diag(c((1/(peak.titer.mean.prior.sd.pomona^2)),(1/(peak.titer.mean.prior.sd.aut^2)))),
                                         'omega' = diag(c((1/(peak.titer.sd.prior.pomona^2)),(1/(peak.titer.sd.prior.aut^2)))),
                                         'wishdf' = 2,
                                         'log_shape_pomona_overall_mean_prior_mean' = log.mean.shape.prior.mean,
                                         'log_shape_pomona_overall_mean_prior_sd' = log.mean.shape.prior.sd,
                                         'log_scale_pomona_overall_mean_prior_mean' = log.mean.scale.prior.mean,
                                         'log_scale_pomona_overall_mean_prior_sd' = log.mean.scale.prior.sd,
                                         'log_shape_aut_overall_mean_prior_mean' = log.mean.shape.prior.mean,
                                         'log_shape_aut_overall_mean_prior_sd' = log.mean.shape.prior.sd,
                                         'log_scale_aut_overall_mean_prior_mean' = log.mean.scale.prior.mean,
                                         'log_scale_aut_overall_mean_prior_sd' = log.mean.scale.prior.sd,
                                         'log_shape_pomona_overall_sd_prior_shape' = log.sd.shape.prior.shape,
                                         'log_shape_pomona_overall_sd_prior_rate' = log.sd.shape.prior.rate,
                                         'log_scale_pomona_overall_sd_prior_shape' = log.sd.scale.prior.shape,
                                         'log_scale_pomona_overall_sd_prior_rate' = log.sd.scale.prior.rate,
                                         'log_shape_aut_overall_sd_prior_shape' = log.sd.shape.prior.shape,
                                         'log_shape_aut_overall_sd_prior_rate' = log.sd.shape.prior.rate,
                                         'log_scale_aut_overall_sd_prior_shape' = log.sd.scale.prior.shape,
                                         'log_scale_aut_overall_sd_prior_rate' = log.sd.scale.prior.rate
                               ),
                               #inits=list('beta0'=-1),
                               n.chains=6,
                               n.adapt = 5000)
       
       
       # burn in
       update(model.jags, n.iter = burn.in, by = 1)
       
       
       
       # draw samples
       
       post = coda.samples(model.jags, c("mu_overall_pomona","sigma_overall_pomona","mu_overall_aut","sigma_overall_aut","theta","LogLik","mu_pomona","mu_aut","mu_pom_aut_mean","shape_pomona_overall_mean","scale_pomona_overall_mean","shape_aut_overall_mean","scale_aut_overall_mean","shape_pomona","shape_aut","scale_pomona","scale_aut","log_shape_pomona_overall_sd","log_scale_pomona_overall_sd","log_shape_aut_overall_sd","log_scale_aut_overall_sd","lab_effect"), n.iter = iterations, thin = 10)
       
       
       
       chains.burn.df = mcmclist.to.dataframe(post)
       
       
       # save output, needs existing MCMC_runs folder in working directory
       filename = "MCMC_antibody_decay_power"
       print(filename)
       saveRDS(chains.burn.df,filename)
       
       
       
} else {
       # load previous output if not re-running model, speeds up markdown knitting
       chains.burn.df.3=readRDS("MCMC_antibody_decay_power.RDS")
}



```


## Gather output three functions    


```{r}


if(run.mcmc==T) {
       

       chains.burn.df.2 = chains.burn.df.original
       
       N.inds = length(grep("theta",names(chains.burn.df.1)))
       
       # get posterior estimates     
       
       
       post.overall = data.frame(model = 1:3,
                                 RMSE = NA,
                                 WAIC = NA,
                                 LOOIC = NA,
                                 peak.titer.mean = NA,
                                 peak.titer.aut.mean = NA,
                                 peak.titer.mean.95lo = NA,
                                 peak.titer.mean.95hi = NA,
                                 peak.titer.sd = NA,
                                 peak.titer.sd.95lo = NA,
                                 peak.titer.sd.95hi = NA,
                                 decay.mean = NA,
                                 decay.aut.mean = NA,
                                 decay.mean.95lo = NA,
                                 decay.mean.95hi = NA,
                                 shape.mean = NA,
                                 shape.mean.95lo = NA,
                                 shape.mean.95hi = NA,
                                 scale.mean = NA,
                                 scale.mean.95lo = NA,
                                 scale.mean.95hi = NA
       )
       
       
       
       
       
       
       
       
       post.individual = data.frame(model = rep(1:3,each = N.inds),
                                    id = rep(1:N.inds,3),
                                    toi.mean = NA,
                                    toi.mean.95lo = NA,
                                    toi.mean.95hi = NA,
                                    toi.95.information.gained = NA,
                                    toi.mean.50lo = NA,
                                    toi.mean.50hi = NA,
                                    toi.50.information.gained = NA,
                                    peak.titer.mean = NA,
                                    peak.titer.mean.95lo = NA,
                                    peak.titer.mean.95hi = NA,
                                    decay.rate.mean = NA,
                                    decay.rate.mean.95lo = NA,
                                    decay.rate.mean.95hi = NA,
                                    shape.mean = NA,
                                    shape.mean.95lo = NA,
                                    shape.mean.95hi = NA,
                                    scale.mean = NA,
                                    scale.mean.95lo = NA,
                                    scale.mean.95hi = NA
       )
       
       
       
       models = 1:3
       
       for(model in 1:length(models)){
              
              chains.burn.df.current = get(paste0("chains.burn.df.",model))
              
              
              # pop level parameters    
              
              chains.burn.df.loglik = chains.burn.df.current[,grep("LogLik",colnames(chains.burn.df.current))]
              
              chains.burn.df.loglik = chains.burn.df.loglik[is.finite(rowSums(chains.burn.df.loglik)),]
              
              loglik.all.matrix = as.matrix(chains.burn.df.loglik)
              rm(chains.burn.df.loglik)
              
              WAIC.val = waic(loglik.all.matrix)
              post.overall[model,"WAIC"] = round(WAIC.val$estimates["waic",][1],1)
              LOOIC.val = loo(loglik.all.matrix)
              post.overall[model,"LOOIC"] = round(LOOIC.val$estimates["looic",][1],1)
              
              
              dens = density(chains.burn.df.current$mu_overall_pomona)
              hpd.int.peak.titer = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
              peak.titer.overall.mean = mean(chains.burn.df.current$mu_overall_pomona)
              
              post.overall[model,"peak.titer.mean"] = peak.titer.overall.mean
              post.overall[model,"peak.titer.mean.95lo"] = hpd.int.peak.titer[1]
              post.overall[model,"peak.titer.mean.95hi"] = hpd.int.peak.titer[2]
              
              dens = density(chains.burn.df.current$mu_overall_aut)
              peak.titer.overall.mean = mean(chains.burn.df.current$mu_overall_aut)
              
              post.overall[model,"peak.titer.aut.mean"] = peak.titer.overall.mean
              
              
              dens = density(chains.burn.df.current$sigma_overall_pomona)
              hpd.int.peak.titer.sd = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
              peak.titer.sd.overall.mean = mean(chains.burn.df.current$sigma_overall_pomona)
              
              post.overall[model,"peak.titer.sd"] = peak.titer.sd.overall.mean
              post.overall[model,"peak.titer.sd.95lo"] = hpd.int.peak.titer.sd[1]
              post.overall[model,"peak.titer.sd.95hi"] = hpd.int.peak.titer.sd[2]
              
              if(model %in% c(1,2)) {
                     dens = density(chains.burn.df.current$decay_overall_pomona)
                     hpd.int.decay = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
                     decay.overall.mean = mean(chains.burn.df.current$decay_overall_pomona)
                     
                     post.overall[model,"decay.mean"] = decay.overall.mean
                     post.overall[model,"decay.mean.95lo"] = hpd.int.decay[1]
                     post.overall[model,"decay.mean.95hi"] = hpd.int.decay[2]
                     
                     dens = density(chains.burn.df.current$decay_overall_aut)
                     hpd.int.decay = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
                     decay.overall.mean = mean(chains.burn.df.current$decay_overall_aut)
                     
                     post.overall[model,"decay.aut.mean"] = decay.overall.mean
                     
              } else {
                     
                     dens = density(chains.burn.df.current$shape_pomona_overall_mean)
                     hpd.int.shape = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
                     shape.overall.mean = mean(chains.burn.df.current$shape_pomona_overall_mean)
                     
                     post.overall[model,"shape.mean"] = shape.overall.mean
                     post.overall[model,"shape.mean.95lo"] = hpd.int.shape[1]
                     post.overall[model,"shape.mean.95hi"] = hpd.int.shape[2]   
                     
                     
                     dens = density(chains.burn.df.current$scale_pomona_overall_mean)
                     hpd.int.scale = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
                     scale.overall.mean = mean(chains.burn.df.current$scale_pomona_overall_mean)
                     
                     post.overall[model,"scale.mean"] = scale.overall.mean
                     post.overall[model,"scale.mean.95lo"] = hpd.int.scale[1]
                     post.overall[model,"scale.mean.95hi"] = hpd.int.scale[2]   
                     
              }
              
              
              
              # individual level parameters   
              
              for(i in 1:N.inds){
                     
                     
                     post.individual[which(post.individual$id==i & post.individual$model==model),"toi.mean"] = max.dens.fun(chains.burn.df.current[,paste0("theta[",i,"]")])
                     
                     dens = density(chains.burn.df.current[,paste0("theta[",i,"]")])
                     hpd.int.toi = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
                     
                     post.individual[which(post.individual$id==i & post.individual$model==model),"toi.mean.95lo"] = hpd.int.toi[1]
                     post.individual[which(post.individual$id==i & post.individual$model==model),"toi.mean.95hi"] = hpd.int.toi[2]
                     post.individual[which(post.individual$id==i & post.individual$model==model),"toi.95.information.gained"] = round(1-(hpd.int.toi[2]-hpd.int.toi[1])/abs(neg.intervals[i]),3)
                     
                     
                     
                     hpd.int.toi = HDInterval::hdi(dens,credMass = 0.5,allowSplit=F)  
                     post.individual[which(post.individual$id==i & post.individual$model==model),"toi.mean.50lo"] = hpd.int.toi[1]
                     post.individual[which(post.individual$id==i & post.individual$model==model),"toi.mean.50hi"] = hpd.int.toi[2]
                     post.individual[which(post.individual$id==i & post.individual$model==model),"toi.50.information.gained"] = round(1-(hpd.int.toi[2]-hpd.int.toi[1])/abs(neg.intervals[i]),3)
                     
                     
                     post.individual[which(post.individual$id==i & post.individual$model==model),"peak.titer.mean"] = mean(chains.burn.df.current[,paste0("mu_pomona[",i,"]")])
                     
                     dens = density(chains.burn.df.current[,paste0("mu_pomona[",i,"]")])
                     hpd.int.peak.titer = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
                     
                     post.individual[which(post.individual$id==i & post.individual$model==model),"peak.titer.mean.95lo"] = hpd.int.peak.titer[1]
                     post.individual[which(post.individual$id==i & post.individual$model==model),"peak.titer.mean.95hi"] = hpd.int.peak.titer[2]
                     
                     
                     if(model %in% 1:2) {
                            post.individual[which(post.individual$id==i & post.individual$model==model),"decay.rate.mean"] = mean(chains.burn.df.current[,paste0("decay_pomona[",i,"]")])
                            
                            dens = density(chains.burn.df.current[,paste0("decay_pomona[",i,"]")])
                            hpd.int.peak.titer = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
                            
                            post.individual[which(post.individual$id==i & post.individual$model==model),"decay.rate.mean.95lo"] = hpd.int.peak.titer[1]
                            post.individual[which(post.individual$id==i & post.individual$model==model),"decay.rate.mean.95hi"] = hpd.int.peak.titer[2]
                     }
                     
                     
                     if(model == 3) {
                            post.individual[which(post.individual$id==i & post.individual$model==model),"shape.mean"] = mean(chains.burn.df.current[,paste0("shape_pomona[",i,"]")])
                            
                            dens = density(chains.burn.df.current[,paste0("shape_pomona[",i,"]")])
                            hpd.int.peak.titer = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
                            
                            post.individual[which(post.individual$id==i & post.individual$model==model),"shape.mean.95lo"] = hpd.int.peak.titer[1]
                            post.individual[which(post.individual$id==i & post.individual$model==model),"shape.mean.95hi"] = hpd.int.peak.titer[2]
                            
                            post.individual[which(post.individual$id==i & post.individual$model==model),"scale.mean"] = mean(chains.burn.df.current[,paste0("scale_pomona[",i,"]")])
                            
                            dens = density(chains.burn.df.current[,paste0("scale_pomona[",i,"]")])
                            hpd.int.peak.titer = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
                            
                            post.individual[which(post.individual$id==i & post.individual$model==model),"scale.mean.95lo"] = hpd.int.peak.titer[1]
                            post.individual[which(post.individual$id==i & post.individual$model==model),"scale.mean.95hi"] = hpd.int.peak.titer[2]
                            
                            
                     }
                     
                     
                     
                     
                     
                     
                     
              }  
              
              
              
              # calculate RMSE and adjust times of infection         
              if(model == 1) {
                     
                     observed.data.for.fitting.single = observed.data.for.fitting
                     observed.data.for.fitting.single$time.since.infection = NA
                     observed.data.for.fitting.single$log.titer = observed.data.for.fitting.single$titer.pomona
                     
                     for(i in 1:N.inds){
                            idx.current = which(observed.data.for.fitting.single$id == i)
                            observed.data.for.fitting.single$time.since.infection[idx.current] = observed.data.for.fitting.single$time[idx.current] - post.individual[which(post.individual$model==model & post.individual$id == i),"toi.mean"]
                     }
                     
                     
                     post.overall[model,"RMSE"] = round(RMSE.fun.linear.individual.decay(peak.titers = post.individual[which(post.individual$model==model),"peak.titer.mean"],slopes = post.individual[which(post.individual$model==model),"decay.rate.mean"], observed.data = observed.data.for.fitting.single) ,5)
                     
              }
              
              if(model == 2) {
                     
                     
                     observed.data.for.fitting.double = observed.data.for.fitting
                     observed.data.for.fitting.double$time.since.infection = NA
                     observed.data.for.fitting.double$titer = observed.data.for.fitting.double$titer.pomona
                     
                     for(i in 1:N.inds){
                            idx.current = which(observed.data.for.fitting.double$id == i)
                            observed.data.for.fitting.double$time.since.infection[idx.current] = observed.data.for.fitting.double$time[idx.current] - post.individual[which(post.individual$model==model & post.individual$id == i),"toi.mean"]
                     }
                     
                     
                     post.overall[model,"RMSE"] = round(RMSE.fun.double.exp.individual.decay(peak.titers = post.individual[which(post.individual$model==model),"peak.titer.mean"],decay.rate = -post.individual[which(post.individual$model==model),"decay.rate.mean"], observed.data = observed.data.for.fitting.double) ,5)
                     
                     
              }
              
              if(model == 3) {
                     observed.data.for.fitting.power = observed.data.for.fitting
                     observed.data.for.fitting.power$time.since.infection = NA
                     observed.data.for.fitting.power$titer = observed.data.for.fitting.power$titer.pomona
                     
                     for(i in 1:N.inds){
                            idx.current = which(observed.data.for.fitting.power$id == i)
                            observed.data.for.fitting.power$time.since.infection[idx.current] = observed.data.for.fitting.power$time[idx.current] - post.individual[which(post.individual$model==model & post.individual$id == i),"toi.mean"]
                     }
                     
                     
                     post.overall[model,"RMSE"] = round(RMSE.fun.power.individual.decay(peak.titers = post.individual[which(post.individual$model==model),"peak.titer.mean"],shape = post.individual[which(post.individual$model==model),"shape.mean"],scale = post.individual[which(post.individual$model==model),"scale.mean"], observed.data = observed.data.for.fitting.power),5) 
              }
              
       }
       
       post.overall$gain[which(post.overall$model==1)] = mean(post.individual$toi.95.information.gained[which(post.individual$model==1)])
       post.overall$gain[which(post.overall$model==2)] = mean(post.individual$toi.95.information.gained[which(post.individual$model==2)])
       post.overall$gain[which(post.overall$model==3)] = mean(post.individual$toi.95.information.gained[which(post.individual$model==3)])
       
       
       post.overall$model[1] = "Single exp"
       post.overall$model[2] = "Double exp"
       post.overall$model[3] = "Power"
       
       post.individual$model[which(post.individual$model==1)] = "Single exp"
       post.individual$model[which(post.individual$model==2)] = "Double exp"
       post.individual$model[which(post.individual$model==3)] = "Power"
       
       post.overall$model = factor(post.overall$model,levels = c("Single exp","Double exp","Power"))
       post.individual$model = factor(post.individual$model,levels = c("Single exp","Double exp","Power"))
       
       all.fun.post.overall = post.overall
       
       kable(all.fun.post.overall ,"html") %>%
              kable_styling(bootstrap_options  =  c("striped", "hover","condensed"),full_width = F)
       
       # export posterior estimates
       saveRDS(all.fun.post.overall,"Function_comparison_post_overall.RDS")
}
rm(chains.burn.df.1,chains.burn.df.2,chains.burn.df.3, chains.burn.df.current)
gc()
```

# Output

Double exponential function only.   


### Stats

```{r warning=F}

chains.burn.df.loglik = chains.burn.df[,grep("LogLik",colnames(chains.burn.df))]

chains.burn.df.loglik = chains.burn.df.loglik[is.finite(rowSums(chains.burn.df.loglik)),]

loglik.all.matrix = as.matrix(chains.burn.df.loglik)
rm(chains.burn.df.loglik)

LOOIC.val = loo(loglik.all.matrix)
LOOIC.val.est = LOOIC.val$estimates["looic",][1]

peak.titer.individual.means.pomona = apply(chains.burn.df[,paste0("peak.titer.pomona.",uid)],MARGIN = 2,mean)
decay.rate.individual.means.pomona = apply(chains.burn.df[,paste0("decay.rate.pomona.",uid)],MARGIN = 2,mean)

observed.data.for.fitting.temp = observed.data.for.fitting
colnames(observed.data.for.fitting.temp)[4] = "titer"
RMSE.val.pomona = round(RMSE.fun.double.exp.individual.decay(peak.titers = peak.titer.individual.means.pomona,decay.rates = -decay.rate.individual.means.pomona, observed.data = observed.data.for.fitting.temp),3)

peak.titer.individual.means.aut = apply(chains.burn.df[,paste0("peak.titer.aut.",uid)],MARGIN = 2,mean)
decay.rate.individual.means.aut = apply(chains.burn.df[,paste0("decay.rate.aut.",uid)],MARGIN = 2,mean)

observed.data.for.fitting.temp = observed.data.for.fitting
colnames(observed.data.for.fitting.temp)[4] = "titer"
RMSE.val.aut = round(RMSE.fun.double.exp.individual.decay(peak.titers = peak.titer.individual.means.aut,decay.rates = -decay.rate.individual.means.aut, observed.data = observed.data.for.fitting.temp),3)



```

------------------------------------------------------------------------
**LOOIC value: `r LOOIC.val.est`**\
**Root mean square error (pomona): `r  RMSE.val.pomona`.**\
**Root mean square error (aut): `r  RMSE.val.aut`.**

------------------------------------------------------------------------

### Lab effect    

CDC vs Ithaca    

```{r}
dens = density(chains.burn.df$lab.effect)
lab.effect.mean = mean(chains.burn.df$lab.effect)
hpd.int.lab.effect = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  

lab.fit = MASS::fitdistr(chains.burn.df$lab.effect,densfun = "normal")
```


Antibody levels for samples (Pomona or Autumnalis) *not* tested at CDC are on average `r lab.effect.mean` (95% CrI `r hpd.int.lab.effect[1]`-`r hpd.int.lab.effect[2]`; SD = `r  as.numeric(lab.fit$estimate[2])`) higher.    

This is taken into account when fitting all model parameters.  

<br>   

```{r fig.height = 4, fig.width = 4.5}

plot.lab.effect.1 = ggplot(data=chains.burn.df,aes(x=lab.effect)) +
       geom_density(color=brewer.pal(11,"Spectral")[10],fill=brewer.pal(11,"Spectral")[10],alpha=0.6,size=1) +
       geom_vline(xintercept=lab.effect.mean,col="black",size=0.8,alpha=0.6) +
       geom_vline(xintercept=hpd.int.lab.effect[1],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept=hpd.int.lab.effect[2],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       theme_light(base_family = "Avenir Next") +
       xlab("Lab effect") +
       ylab("Posterior density") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = "none"
       )


plot.lab.effect.2 = plot.MCMC.chains(input.data = chains.burn.df.original, column.to.plot = which(colnames(chains.burn.df)=="lab.effect"),y.axis.label = "Lab effect",thinning=10)
plot.lab.effect.1
plot.lab.effect.2

```


### Pomona

#### Posterior estimate mean peak titer:

<br>

```{r}

dens = density(chains.burn.df$peak.titer.overall.pomona)
hpd.int.peak.titer.pomona = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
peak.titer.overall.maxdens.pomona=round(dens$x[which.max(dens$y)],2)
peak.titer.overall.mean.pomona = mean(chains.burn.df$peak.titer.overall.pomona)
peak.titer.overall.median.pomona = median(chains.burn.df$peak.titer.overall.pomona)


dens = density(chains.burn.df$peak.titer.sd.overall.pomona)
hpd.int.peak.titer.sd.pomona = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
peak.titer.sd.overall.maxdens.pomona=round(dens$x[which.max(dens$y)],2)
peak.titer.sd.overall.mean.pomona = mean(chains.burn.df$peak.titer.sd.overall.pomona)
peak.titer.sd.overall.median.pomona = median(chains.burn.df$peak.titer.sd.overall.pomona)


```

<br>

```{r fig.height = 4, fig.width = 4.5}

plot1 = ggplot(data=chains.burn.df,aes(x=peak.titer.overall.pomona)) +
       geom_density(color=brewer.pal(11,"Spectral")[10],fill=brewer.pal(11,"Spectral")[10],alpha=0.6,size=1) +
       geom_vline(xintercept=peak.titer.overall.maxdens.pomona,col="black",size=0.8,alpha=0.6) +
       geom_vline(xintercept=hpd.int.peak.titer.pomona[1],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept=hpd.int.peak.titer.pomona[2],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       theme_light(base_family = "Avenir Next") +
       xlab("Peak antibody level mean (Pomona) \n(log2 dilution)") +
       ylab("Posterior density") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = "none"
       )


plot2 = plot.MCMC.chains(input.data = chains.burn.df.original, column.to.plot = which(colnames(chains.burn.df)=="peak.titer.overall.pomona"),y.axis.label = "Peak antibody level mean (Pomona) \n(log2 dilution)",thinning=10)
plot1
plot2

```

<br>

-   Posterior estimate (max dens):
`r  peak.titer.overall.maxdens.pomona`\
-   Posterior estimate (mean): `r  peak.titer.overall.mean.pomona`\
-   Posterior estimate (median): `r  peak.titer.overall.median.pomona`\
-   Highest density credible interval =
`r  hpd.int.peak.titer.pomona[1]` - `r hpd.int.peak.titer.pomona[2]`

#### Posterior estimate standard deviation of peak titer:

```{r fig.height = 4, fig.width = 4.5}

plot1 = ggplot(data=chains.burn.df,aes(x=peak.titer.sd.overall.pomona)) +
       geom_density(color=brewer.pal(11,"Spectral")[10],fill=brewer.pal(11,"Spectral")[10],alpha=0.6,size=1) +
       geom_vline(xintercept=peak.titer.sd.overall.maxdens.pomona,col="black",size=0.8,alpha=0.6) +
       geom_vline(xintercept=hpd.int.peak.titer.sd.pomona[1],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept=hpd.int.peak.titer.sd.pomona[2],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       theme_light(base_family = "Avenir Next") +
       xlab("Peak antibody level SD (Pomona) \n(log2 dilution)") +
       ylab("Posterior density") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = "none"
       )

plot2 = plot.MCMC.chains(input.data = chains.burn.df.original, column.to.plot = which(colnames(chains.burn.df)=="peak.titer.sd.overall.pomona"), y.axis.label = "Peak antibody level SD (Pomona) \n(log2 dilution)",thinning=10)
plot1
plot2


```

<br>

-   Posterior estimate (max dens):
`r  peak.titer.sd.overall.maxdens.pomona`\
-   Posterior estimate (mean): `r  peak.titer.sd.overall.mean.pomona`\
-   Posterior estimate (median):
`r  peak.titer.sd.overall.median.pomona`\
-   Highest density credible interval =
`r  hpd.int.peak.titer.sd.pomona[1]` -
`r hpd.int.peak.titer.sd.pomona[2]`

<br>

#### Peak titer distribution using the posterior mean estimates of peak titer mean and SD

Including 200 random draws from the posteriors:

```{r fig.height = 4, fig.width = 4.5}

Nsamp = 200  
means = sample(chains.burn.df$peak.titer.overall.pomona,Nsamp,replace = F)
sds = sample(chains.burn.df$peak.titer.sd.overall.pomona,Nsamp,replace = F)


ggplot(data = data.frame(x = 0:15),aes(x=x)) +
       scale_x_continuous(breaks=0:15) +
       mapply(function(mean,sd){
              stat_function(fun = dnorm, colour = brewer.pal(11,"Spectral")[10],alpha=0.5,args = list(mean = mean,sd = sd),size=0.3)
       },
       mean = means,
       sd = sds
       ) +
       stat_function(fun = dnorm, colour = brewer.pal(11,"Spectral")[1],args = list(mean = peak.titer.overall.mean.pomona,sd = peak.titer.sd.overall.mean.pomona),size=1.5) +
       xlab("Peak antibody level (Pomona) \n(log2 dilution)") +
       ylab("Posterior distribution") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             legend.position = "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       )

```

<br> <br>

------------------------------------------------------------------------

<br> <br>

#### Posterior estimate mean decay rate:

<br>

```{r}

dens = density(chains.burn.df$decay.rate.overall.pomona)
hpd.int.decay.rate.pomona = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
decay.rate.overall.maxdens.pomona=round(dens$x[which.max(dens$y)],6)
decay.rate.overall.mean.pomona = mean(chains.burn.df$decay.rate.overall.pomona)
decay.rate.overall.median.pomona = median(chains.burn.df$decay.rate.overall.pomona)


dens = density(chains.burn.df$decay.rate.sd.overall.pomona)
hpd.int.decay.rate.sd.pomona = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
decay.rate.sd.overall.maxdens.pomona=round(dens$x[which.max(dens$y)],6)
decay.rate.sd.overall.mean.pomona = mean(chains.burn.df$decay.rate.sd.overall.pomona)
decay.rate.sd.overall.median.pomona = median(chains.burn.df$decay.rate.sd.overall.pomona)


```

<br>

```{r fig.height = 4, fig.width = 4.5}


plot1 = ggplot(data=chains.burn.df,aes(x=decay.rate.overall.pomona)) +
       geom_density(color=brewer.pal(11,"Spectral")[10],fill=brewer.pal(11,"Spectral")[10],alpha=0.6,size=1) +
       geom_vline(xintercept=decay.rate.overall.mean.pomona,col="black",size=0.8,alpha=0.6) +
       geom_vline(xintercept=hpd.int.decay.rate.pomona[1],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept=hpd.int.decay.rate.pomona[2],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       theme_light(base_family = "Avenir Next") +
       xlab("Decay rate mean (Pomona) \n(1/day)") +
       ylab("Posterior density") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = "none"
       )

plot2 = plot.MCMC.chains(input.data = chains.burn.df.original, column.to.plot = which(colnames(chains.burn.df)=="decay.rate.overall.pomona"), y.axis.label = "Decay rate mean (Pomona) \n(1/day)",thinning=10)
plot1
plot2


```

<br>

-   Posterior estimate (max dens):
`r  decay.rate.overall.maxdens.pomona`\
-   Posterior estimate (mean): `r  decay.rate.overall.mean.pomona`\
-   Posterior estimate (median): `r  decay.rate.overall.median.pomona`\
-   Highest density credible interval =
`r  hpd.int.decay.rate.pomona[1]` - `r hpd.int.decay.rate.pomona[2]`

#### Posterior estimate standard deviation of decay rate:

```{r fig.height = 4, fig.width = 4.5}


plot1 = ggplot(data=chains.burn.df,aes(x=decay.rate.sd.overall.pomona)) +
       geom_density(color=brewer.pal(11,"Spectral")[10],fill=brewer.pal(11,"Spectral")[10],alpha=0.6,size=1) +
       geom_vline(xintercept=decay.rate.sd.overall.mean.pomona,col="black",size=0.8,alpha=0.6) +
       geom_vline(xintercept=hpd.int.decay.rate.sd.pomona[1],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept=hpd.int.decay.rate.sd.pomona[2],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       theme_light(base_family = "Avenir Next") +
       xlab("Decay rate SD (Pomona) \n(1/day)") +
       ylab("Posterior density") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = "none"
       )


plot2 = plot.MCMC.chains(input.data = chains.burn.df.original, column.to.plot = which(colnames(chains.burn.df)=="decay.rate.sd.overall.pomona"), y.axis.label = "Decay rate SD (Pomona) \n(1/day)",thinning=10)
plot1
plot2


```

<br>

-   Posterior estimate (max dens):
`r  decay.rate.sd.overall.maxdens.pomona`\
-   Posterior estimate (mean): `r  decay.rate.sd.overall.mean.pomona`\
-   Posterior estimate (median):
`r  decay.rate.sd.overall.median.pomona`\
-   Highest density credible interval =
`r  hpd.int.decay.rate.sd.pomona[1]` -
`r hpd.int.decay.rate.sd.pomona[2]`

<br>

#### Decay rate distribution using the posterior mean estimates of peak titer mean and SD

Including 200 random draws from the posteriors:

```{r fig.height = 4, fig.width = 4.5}

Nsamp = 200  
means = sample(chains.burn.df$decay.rate.overall.pomona,Nsamp,replace = F)
sds = sample(chains.burn.df$decay.rate.sd.overall.pomona,Nsamp,replace = F)


ggplot(data = data.frame(x = seq(-0.0002,0.0019,0.00001)),aes(x=x)) +
       mapply(function(mean,sd){
              stat_function(fun = dnorm, colour = brewer.pal(11,"Spectral")[10],alpha=0.5,args = list(mean = mean,sd = sd),size=0.3)
       },
       mean = means,
       sd = sds
       ) +
       stat_function(fun = dnorm, colour = brewer.pal(11,"Spectral")[1],args = list(mean = decay.rate.overall.mean.pomona,sd = decay.rate.sd.overall.mean.pomona),size=1.5) +
       xlab("Decay rate (Pomona) \n(1/day)") +
       ylab("Posterior distribution") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             legend.position = "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
       )

```

#### Joint posterior peak titer vs decay means

Population level means:

```{r fig.height = 4, fig.width = 6}

joint.dens = chains.burn.df[,c("decay.rate.overall.pomona","peak.titer.overall.pomona")]
joint.dens$dens = get_density(chains.burn.df$decay.rate.overall.pomona,chains.burn.df$peak.titer.overall.pomona,n = 80)


joint.plot = ggplot(joint.dens,aes(x = decay.rate.overall.pomona, y = peak.titer.overall.pomona,color=dens)) +
       geom_point(alpha = 0.4,size = 0.5) +
       scale_colour_gradientn(colors = rev(brewer.pal(n = 6,"Spectral")),name="Density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 14),
             text = element_text(size = 11),
             axis.text = element_text(size = 11),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")) +
       xlab("Decay rate posterior mean (Pomona) \n(1/day)") +
       ylab("Peak antibody level \n posterior mean (Pomona) \n(log2 dilution)")


joint.plot

```

<br>

Individual posterior means:

```{r fig.height = 4, fig.width = 6}
# 1200 posterior values per individual    
n.it.each = 200
ind.means = data.frame(id = rep(1:N.inds,each = n.it.each*6),
                       peak.titer.pomona = NA,
                       peak.titer.aut = NA,
                       decay.rate.pomona = NA,
                       decay.rate.aut = NA,
                       iteration = NA)
ind.means.2 = data.frame(id = 1:N.inds,
                         peak.titer.pomona = NA,
                         peak.titer.aut = NA,
                         decay.rate.pomona = NA,
                         decay.rate.aut = NA)


for(i in 1:N.inds){
       ind.means$peak.titer.pomona[which(ind.means$id == i)] = chains.burn.df[which(chains.burn.df$iteration == tail(chains.burn.df$iteration,n.it.each)),paste0("peak.titer.pomona.",i)]
       ind.means$peak.titer.aut[which(ind.means$id == i)] = chains.burn.df[which(chains.burn.df$iteration == tail(chains.burn.df$iteration,n.it.each)),paste0("peak.titer.aut.",i)]
       ind.means$decay.rate.pomona[which(ind.means$id == i)] = chains.burn.df[which(chains.burn.df$iteration == tail(chains.burn.df$iteration,n.it.each)),paste0("decay.rate.pomona.",i)]
       ind.means$decay.rate.aut[which(ind.means$id == i)] = chains.burn.df[which(chains.burn.df$iteration == tail(chains.burn.df$iteration,n.it.each)),paste0("decay.rate.aut.",i)]
       ind.means$iteration = chains.burn.df[which(chains.burn.df$iteration == tail(chains.burn.df$iteration,n.it.each)),"iteration"]
       
       
       ind.means.2$peak.titer.pomona[which(ind.means.2$id == i)] = mean(chains.burn.df[,paste0("peak.titer.pomona.",i)])
       ind.means.2$peak.titer.aut[which(ind.means.2$id == i)] = mean(chains.burn.df[,paste0("peak.titer.aut.",i)])
       ind.means.2$decay.rate.pomona[which(ind.means.2$id == i)] = mean(chains.burn.df[,paste0("decay.rate.pomona.",i)])
       ind.means.2$decay.rate.aut[which(ind.means.2$id == i)] = mean(chains.burn.df[,paste0("decay.rate.aut.",i)])
}





ind.means$dens = get_density(ind.means$peak.titer.pomona,ind.means$decay.rate.pomona,n = 80)



ggplot(ind.means,aes(x = decay.rate.pomona, y = peak.titer.pomona,color=dens)) +
       geom_point(alpha = 0.4,size = 0.5) +
       scale_colour_gradientn(colors = rev(brewer.pal(n = 6,"Spectral")),name="Density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 13),
             text=element_text(size=13),
             axis.text=element_text(size=13),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             #legend.position = c(0.78,0.85),
             legend.text = element_text(size=10),
             legend.title = element_text(size=11),
             #legend.position = "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.background = element_rect(colour = "transparent", fill = "transparent"),
             legend.key = element_rect(fill = NA)
       ) +
       xlab("Decay rate posterior samples \n(1/day)") +
       ylab("Peak antibody level posterior samples \n(log2 dilution)")

joint.plot.peak.decay = ggplot(ind.means,aes(x = decay.rate.pomona, y = peak.titer.pomona,color=dens)) +
       geom_point(alpha = 0.4,size = 0.5) +
       scale_colour_gradientn(colors = rev(brewer.pal(n = 6,"Spectral")),name="Density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 13),
             text=element_text(size=13),
             axis.text=element_text(size=13),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             #legend.position = c(0.78,0.85),
             #legend.position = "none",
             legend.text = element_text(size=10),
             legend.title = element_text(size=11),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.background = element_rect(colour = "transparent", fill = "transparent"),
             legend.key = element_rect(fill = NA)
       ) +
       xlab("Decay rate posterior samples \n(1/day)") +
       ylab("Peak antibody level \n posterior samples \n(log2 dilution)") +
       labs(tag="(C)")






```


Correlation:         


```{r warning=F,message=F}
n.it = 400

posterior.cor = data.frame(iteration = rep(tail(unique(chains.burn.df$iteration),n.it),6),
                           chain = rep(1:6,each = n.it),
                           slope = NA,
                           p.val = NA,
                           adj.r2 = NA)
for(i in 1:nrow(posterior.cor)){
       cur.dat = data.frame(peak.titer = reshape2::melt(chains.burn.df[which(chains.burn.df$iteration==posterior.cor$iteration[i] & chains.burn.df$chain == posterior.cor$chain[i]),paste0("peak.titer.pomona.",1:N.inds)])[,2],
                            decay.rate = reshape2::melt(chains.burn.df[which(chains.burn.df$iteration==posterior.cor$iteration[i] & chains.burn.df$chain == posterior.cor$chain[i]),paste0("decay.rate.pomona.",1:N.inds)])[,2]
       )
       
       cur.lm = summary(lm(peak.titer~decay.rate,data = cur.dat))
       posterior.cor$slope[i] = cur.lm$coefficients[2]
       posterior.cor$p.val[i] = round(cur.lm$coefficients[8],5)
       posterior.cor$adj.r2[i] = cur.lm$adj.r.squared
}


dens = density(posterior.cor$p.val)
hpd.int.p.val.pomona = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  

dens = density(posterior.cor$slope)
hpd.int.slope.pomona = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  

dens = density(posterior.cor$adj.r2)
hpd.int.adj.r2.pomona = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  

```


Median p value: `r  median(posterior.cor$p.val) ` (95% CrI `r hpd.int.p.val.pomona[1]`-`r hpd.int.p.val.pomona[2]`.    
Proportion of P values below 0.05:  `r   sum(posterior.cor$p.val)/nrow(posterior.cor) `     

Mean slope:  `r mean(posterior.cor$slope)` (95% CrI `r hpd.int.slope.pomona[1]`-`r hpd.int.slope.pomona[2]`.    

Median adjusted R^2:  `r median(posterior.cor$adj.r2)` (95% CrI `r hpd.int.adj.r2.pomona[1]`-`r hpd.int.adj.r2.pomona[2]`.    


```{r fig.height = 4, fig.width = 4.5}


ggplot(data=posterior.cor,aes(x=slope)) +
       geom_density(color=brewer.pal(11,"Spectral")[10],fill=brewer.pal(11,"Spectral")[10],alpha=0.6,size=1) +
       geom_vline(xintercept=hpd.int.slope.pomona[1],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept=hpd.int.slope.pomona[2],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       theme_light(base_family = "Avenir Next") +
       xlab("Slope decay rate vs peak antibody level") +
       ylab("Posterior density") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = "none"
       )

ggplot(data=posterior.cor,aes(x=p.val)) +
       geom_density(color=brewer.pal(11,"Spectral")[10],fill=brewer.pal(11,"Spectral")[10],alpha=0.6,size=1) +
       geom_vline(xintercept=hpd.int.p.val.pomona[1],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept=hpd.int.p.val.pomona[2],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       theme_light(base_family = "Avenir Next") +
       xlab("P value regression decay rate vs peak antibody level") +
       ylab("Posterior density") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = "none"
       )

ggplot(data=posterior.cor,aes(x=adj.r2)) +
       geom_density(color=brewer.pal(11,"Spectral")[10],fill=brewer.pal(11,"Spectral")[10],alpha=0.6,size=1) +
       geom_vline(xintercept=mean(posterior.cor$adj.r2),col="black",size=0.8,alpha=0.6) +
       geom_vline(xintercept=hpd.int.adj.r2.pomona[1],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept=hpd.int.adj.r2.pomona[2],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       theme_light(base_family = "Avenir Next") +
       xlab("Adj. R^2 decay rate vs peak antibody level") +
       ylab("Posterior density") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = "none"
       )


```



Using one posterior mean for each individual:

```{r fig.height = 4, fig.width = 5}
ggplot(ind.means.2,aes(x = decay.rate.pomona, y = peak.titer.pomona)) +
       geom_point(alpha = 1,size = 0.8,col = brewer.pal(n = 11,"Spectral")[10]) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 14),
             text = element_text(size = 11),
             axis.text = element_text(size = 11),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")) +
       xlab("Decay rate posterior \nindividual means (Pomona) \n(1/day)") +
       ylab("Peak antibody level \nposterior individual means (Pomona) \n(log2 dilution)")
```


Correlation using posterior means:        

```{r fig.height = 4, fig.width = 5}
lm1 = lm(peak.titer.pomona~decay.rate.pomona,data = ind.means.2)
# plot(lm1)
summary(lm1)
```

Two functions taken from the predicted values of the regression model:    

```{r fig.height = 4, fig.width = 5}
exp.dat.1 = data.frame(x = 1:3000,y = exp.fun(start.titer = 7.5,rate = -0.0004,time = 1:3000))
exp.dat.2 = data.frame(x = 1:3000,y = exp.fun(start.titer = 6.5,rate = -0.0011,time = 1:3000))

plot(1:3000,exp.dat.1$y,type="l",ylim = c(0,8))
lines(1:3000,exp.dat.2$y,col="red")
```



<br>

------------------------------------------------------------------------

<br> <br>

#### Fitted function

<br>

(red = estimated function)

```{r fig.height = 4,fig.width = 6}




fit.dat = exp.fun(start.titer = peak.titer.overall.mean.pomona, rate = -decay.rate.overall.mean.pomona, time = 0:max(observed.data.for.fitting$time))

fit.dat = data.frame(titer = fit.dat, time = 0:max(observed.data.for.fitting$time))


ggplot() +
       geom_line(data = observed.data.for.fitting,aes(x = time,y = titer.pomona,col = id,group = id),alpha = 0.4,size = 0.6) +
       geom_point(data = observed.data.for.fitting,aes(x = time,y = titer.pomona,col = id,group = id),size=1.2,alpha = 0.9) +
       geom_line(data=fit.dat,aes(x = time, y = titer),col=brewer.pal(11,"Spectral")[1],size=1.3) +
       scale_color_gradientn(colours  =  brewer.pal(4,"Spectral")) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 12),
             text = element_text(size = 11),
             axis.text = element_text(size = 11),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             legend.position  =  "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"))+
       xlab("Time since first positive sample (days)") +
       ylab("Antibody level (Pomona) \n(log2 dilution)")


```

<br>

Time = time since peak antibody level

```{r fig.height = 4,fig.width = 6}




fit.dat.pomona = exp.fun(start.titer = peak.titer.overall.mean.pomona, rate = -decay.rate.overall.mean.pomona, time = 0:max(observed.data.for.fitting$time.since.peak))

fit.dat.pomona = data.frame(titer = fit.dat.pomona, time = 0:max(observed.data.for.fitting$time.since.peak))


ggplot() +
       geom_line(data = observed.data.for.fitting,aes(x = time.since.peak,y = titer.pomona,col = id,group = id),alpha = 0.4,size = 0.6) +
       geom_point(data = observed.data.for.fitting,aes(x = time.since.peak,y = titer.pomona,col = id,group = id),size=1.2,alpha = 0.9) +
       geom_line(data=fit.dat.pomona,aes(x = time, y = titer),col=brewer.pal(11,"Spectral")[1],size=1.3) +
       scale_color_gradientn(colours  =  brewer.pal(4,"Spectral")) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 12),
             text = element_text(size = 11),
             axis.text = element_text(size = 11),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             legend.position  =  "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"))+
       xlab("Time since peak antibody level (days)") +
       ylab("Antibody level (Pomona) \n(log2 dilution)")


```

Including fitted functions for 200 random samples from the posterior
distribution (within 95% credible interval):

```{r fig.height = 4,fig.width = 6}

# sample N values from posterior distribution to get sense of error

N.samp = 200


set.seed(1234);sampled.iterations = sample(which(chains.burn.df$peak.titer.overall.pomona > hpd.int.peak.titer.pomona[1] & chains.burn.df$peak.titer.overall.pomona < hpd.int.peak.titer.pomona[2]), size = N.samp, replace = T)

peak.titer.samp.mean.pomona = chains.burn.df$peak.titer.overall.pomona[sampled.iterations]

peak.titer.samp.sd.pomona = chains.burn.df$peak.titer.sd.overall.pomona[sampled.iterations]


peak.titer.samp.df.pomona = data.frame(peak.titer.samp.mean.pomona,peak.titer.samp.sd.pomona)

peak.titer.samp.fun = function(x) rnorm(1,x[1],x[2])

peak.titer.samp.pomona = apply(peak.titer.samp.df.pomona,1,peak.titer.samp.fun)

decay.rate.samp.mean.pomona = chains.burn.df$decay.rate.overall.pomona[sampled.iterations]

decay.rate.samp.pomona = mean(chains.burn.df$decay.rate.overall.pomona)

plot.times = 0:max(observed.data.for.fitting$time.since.peak)

fit.dat.cloud.pomona = data.frame(time = rep(plot.times,N.samp), samp = rep(1:N.samp,each = length(plot.times)), titer = NA)

for(i in 1:N.samp){
       
       fit.dat.cloud.pomona$titer[which(fit.dat.cloud.pomona$samp == i)] = exp.fun(start.titer = peak.titer.samp.pomona[i], rate = -decay.rate.samp.pomona, time = plot.times)
       
}



ggplot() +
       geom_line(data=fit.dat.cloud.pomona, aes(x = time, y = titer, group = samp), col = brewer.pal(11,"Spectral")[10],alpha=0.4,size=0.3) +
       geom_line(data=fit.dat.pomona,aes(x = time, y = titer),col=brewer.pal(11,"Spectral")[1],size=1.5) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 12),
             text = element_text(size = 11),
             axis.text = element_text(size = 11),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             legend.position  =  "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"))+
       xlab("Time since peak antibody level (days)") +
       ylab("Antibody level (Pomona) \n(log2 dilution)")




```

### Autumnalis

#### Posterior estimate mean peak titer:

<br>

```{r}

dens = density(chains.burn.df$peak.titer.overall.aut)
hpd.int.peak.titer.aut = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
peak.titer.overall.maxdens.aut=round(dens$x[which.max(dens$y)],2)
peak.titer.overall.mean.aut = mean(chains.burn.df$peak.titer.overall.aut)
peak.titer.overall.median.aut = median(chains.burn.df$peak.titer.overall.aut)


dens = density(chains.burn.df$peak.titer.sd.overall.aut)
hpd.int.peak.titer.sd.aut = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
peak.titer.sd.overall.maxdens.aut=round(dens$x[which.max(dens$y)],2)
peak.titer.sd.overall.mean.aut = mean(chains.burn.df$peak.titer.sd.overall.aut)
peak.titer.sd.overall.median.aut = median(chains.burn.df$peak.titer.sd.overall.aut)


```

<br>

```{r fig.height = 4, fig.width = 4.5}

plot1 = ggplot(data=chains.burn.df,aes(x=peak.titer.overall.aut)) +
       geom_density(color=brewer.pal(11,"Spectral")[10],fill=brewer.pal(11,"Spectral")[10],alpha=0.6,size=1) +
       geom_vline(xintercept=peak.titer.overall.maxdens.aut,col="black",size=0.8,alpha=0.6) +
       geom_vline(xintercept=hpd.int.peak.titer.aut[1],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept=hpd.int.peak.titer.aut[2],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       theme_light(base_family = "Avenir Next") +
       xlab("Peak antibody level mean (Autumnalis) \n(log2 dilution)") +
       ylab("Posterior density") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = "none"
       )

plot2 = plot.MCMC.chains(input.data = chains.burn.df, column.to.plot = which(colnames(chains.burn.df)=="peak.titer.overall.aut"),y.axis.label = "Peak antibody level mean (Autumnalis) \n(log2 dilution)",thinning=10)
plot1
plot2

```

<br>

-   Posterior estimate (max dens): `r  peak.titer.overall.maxdens.aut`\
-   Posterior estimate (mean): `r  peak.titer.overall.mean.aut`\
-   Posterior estimate (median): `r  peak.titer.overall.median.aut`\
-   Highest density credible interval = `r  hpd.int.peak.titer.aut[1]` -
`r hpd.int.peak.titer.aut[2]`

#### Posterior estimate standard deviation of peak titer:

```{r fig.height = 4, fig.width = 4.5}
plot1 = ggplot(data=chains.burn.df,aes(x=peak.titer.sd.overall.aut)) +
       geom_density(color=brewer.pal(11,"Spectral")[10],fill=brewer.pal(11,"Spectral")[10],alpha=0.6,size=1) +
       geom_vline(xintercept=peak.titer.sd.overall.maxdens.aut,col="black",size=0.8,alpha=0.6) +
       geom_vline(xintercept=hpd.int.peak.titer.sd.aut[1],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept=hpd.int.peak.titer.sd.aut[2],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       theme_light(base_family = "Avenir Next") +
       xlab("Peak antibody level SD (Autumnalis) \n(log2 dilution)") +
       ylab("Posterior density") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = "none"
       )
plot2 = plot.MCMC.chains(input.data = chains.burn.df, column.to.plot = which(colnames(chains.burn.df)=="peak.titer.sd.overall.aut"), y.axis.label = "Peak antibody level SD (Autumnalis) \n(log2 dilution)",thinning=10)
plot1
plot2


```

<br>

-   Posterior estimate (max dens):
`r  peak.titer.sd.overall.maxdens.aut`\
-   Posterior estimate (mean): `r  peak.titer.sd.overall.mean.aut`\
-   Posterior estimate (median): `r  peak.titer.sd.overall.median.aut`\
-   Highest density credible interval =
`r  hpd.int.peak.titer.sd.aut[1]` - `r hpd.int.peak.titer.sd.aut[2]`

<br>

#### Peak titer distribution using the posterior mean estimates of peak titer mean and SD

Including 200 random draws from the posteriors:

```{r fig.height = 4, fig.width = 4.5}

Nsamp = 200  
means = sample(chains.burn.df$peak.titer.overall.aut,Nsamp,replace = F)
sds = sample(chains.burn.df$peak.titer.sd.overall.aut,Nsamp,replace = F)


ggplot(data = data.frame(x = 0:15),aes(x=x)) +
       scale_x_continuous(breaks=0:15) +
       mapply(function(mean,sd){
              stat_function(fun = dnorm, colour = brewer.pal(11,"Spectral")[10],alpha=0.5,args = list(mean = mean,sd = sd),size=0.3)
       },
       mean = means,
       sd = sds
       ) +
       stat_function(fun = dnorm, colour = brewer.pal(11,"Spectral")[1],args = list(mean = peak.titer.overall.mean.aut,sd = peak.titer.sd.overall.mean.aut),size=1.5) +
       xlab("Peak antibody level (Autumnalis) \n(log2 dilution)") +
       ylab("Posterior distribution") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             legend.position = "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       )

```

<br> <br>

------------------------------------------------------------------------

<br> <br>

#### Posterior estimate mean decay rate:

<br>

```{r}

dens = density(chains.burn.df$decay.rate.overall.aut)
hpd.int.decay.rate.aut = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
decay.rate.overall.maxdens.aut=round(dens$x[which.max(dens$y)],6)
decay.rate.overall.mean.aut = mean(chains.burn.df$decay.rate.overall.aut)
decay.rate.overall.median.aut = median(chains.burn.df$decay.rate.overall.aut)


dens = density(chains.burn.df$decay.rate.sd.overall.aut)
hpd.int.decay.rate.sd.aut = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
decay.rate.sd.overall.maxdens.aut=round(dens$x[which.max(dens$y)],6)
decay.rate.sd.overall.mean.aut = mean(chains.burn.df$decay.rate.sd.overall.aut)
decay.rate.sd.overall.median.aut = median(chains.burn.df$decay.rate.sd.overall.aut)


```

<br>

```{r fig.height = 4, fig.width = 4.5}

plot1 = ggplot(data=chains.burn.df,aes(x=decay.rate.overall.aut)) +
       geom_density(color=brewer.pal(11,"Spectral")[10],fill=brewer.pal(11,"Spectral")[10],alpha=0.6,size=1) +
       geom_vline(xintercept=decay.rate.overall.mean.aut,col="black",size=0.8,alpha=0.6) +
       geom_vline(xintercept=hpd.int.decay.rate.aut[1],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept=hpd.int.decay.rate.aut[2],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       theme_light(base_family = "Avenir Next") +
       xlab("Decay rate mean (Autumnalis) \n(1/day)") +
       ylab("Posterior density") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = "none"
       )
plot2 = plot.MCMC.chains(input.data = chains.burn.df, column.to.plot = which(colnames(chains.burn.df)=="decay.rate.overall.aut"), y.axis.label = "Decay rate mean (Autumnalis) \n(1/day)",thinning=10)
plot1
plot2


```

<br>

-   Posterior estimate (max dens): `r  decay.rate.overall.maxdens.aut`\
-   Posterior estimate (mean): `r  decay.rate.overall.mean.aut`\
-   Posterior estimate (median): `r  decay.rate.overall.median.aut`\
-   Highest density credible interval = `r  hpd.int.decay.rate.aut[1]` -
`r hpd.int.decay.rate.aut[2]`

#### Posterior estimate standard deviation of decay rate:

```{r fig.height = 4, fig.width = 4.5}

plot1 = ggplot(data=chains.burn.df,aes(x=decay.rate.sd.overall.aut)) +
       geom_density(color=brewer.pal(11,"Spectral")[10],fill=brewer.pal(11,"Spectral")[10],alpha=0.6,size=1) +
       geom_vline(xintercept=decay.rate.sd.overall.mean.aut,col="black",size=0.8,alpha=0.6) +
       geom_vline(xintercept=hpd.int.decay.rate.sd.aut[1],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept=hpd.int.decay.rate.sd.aut[2],col="black",size=0.8,linetype="dotted",alpha=0.6) +
       theme_light(base_family = "Avenir Next") +
       xlab("Decay rate SD (Autumnalis) \n(1/day)") +
       ylab("Posterior density") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = "none"
       )


plot2 = plot.MCMC.chains(input.data = chains.burn.df, column.to.plot = which(colnames(chains.burn.df)=="decay.rate.sd.overall.aut"), y.axis.label = "Decay rate SD (Autumnalis) \n(1/day)",thinning=10)
plot1
plot2


```

<br>

-   Posterior estimate (max dens):
`r  decay.rate.sd.overall.maxdens.aut`\
-   Posterior estimate (mean): `r  decay.rate.sd.overall.mean.aut`\
-   Posterior estimate (median): `r  decay.rate.sd.overall.median.aut`\
-   Highest density credible interval =
`r  hpd.int.decay.rate.sd.aut[1]` - `r hpd.int.decay.rate.sd.aut[2]`

<br>

#### Decay rate distribution using the posterior mean estimates of peak titer mean and SD

Including 200 random draws from the posteriors:

```{r fig.height = 4, fig.width = 4.5}

Nsamp = 200  
means = sample(chains.burn.df$decay.rate.overall.aut,Nsamp,replace = F)
sds = sample(chains.burn.df$decay.rate.sd.overall.aut,Nsamp,replace = F)


ggplot(data = data.frame(x = seq(-0.0002,0.0016,0.00001)),aes(x=x)) +
       mapply(function(mean,sd){
              stat_function(fun = dnorm, colour = brewer.pal(11,"Spectral")[10],alpha=0.5,args = list(mean = mean,sd = sd),size=0.3)
       },
       mean = means,
       sd = sds
       ) +
       stat_function(fun = dnorm, colour = brewer.pal(11,"Spectral")[1],args = list(mean = decay.rate.overall.mean.aut,sd = decay.rate.sd.overall.mean.aut),size=1.5) +
       xlab("Decay rate (Autumnalis) \n(1/day)") +
       ylab("Posterior distribution") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             legend.position = "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
       )

```

#### Joint posterior peak titer vs decay means

```{r fig.height = 4, fig.width = 6}
joint.dens = chains.burn.df[,c("decay.rate.overall.aut","peak.titer.overall.aut")]
joint.dens$dens = get_density(chains.burn.df$decay.rate.overall.aut,chains.burn.df$peak.titer.overall.aut,n = 80)


joint.plot = ggplot(joint.dens,aes(x = decay.rate.overall.aut, y = peak.titer.overall.aut,color=dens)) +
       geom_point(alpha = 0.4,size = 0.5) +
       scale_colour_gradientn(colors = rev(brewer.pal(n = 6,"Spectral")),name="Density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 14),
             text = element_text(size = 11),
             axis.text = element_text(size = 11),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")) +
       xlab("Decay rate posterior mean (Autumnalis) \n(1/day)") +
       ylab("Peak titer posterior mean (Autumnalis) \n(log2 dilution)")


joint.plot
```

<br>

Individual posterior means:

```{r fig.height = 4, fig.width = 6}
ind.means$dens = get_density(ind.means$peak.titer.aut,ind.means$decay.rate.aut,n = 80)


joint.plot = ggplot(ind.means,aes(x = decay.rate.aut, y = peak.titer.aut,color=dens)) +
       geom_point(alpha = 0.4,size = 0.5) +
       scale_colour_gradientn(colors = rev(brewer.pal(n = 6,"Spectral")),name="Density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 14),
             text = element_text(size = 11),
             axis.text = element_text(size = 11),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")) +
       xlab("Decay rate posterior individual means (Autumnalis) \n(1/day)") +
       ylab("Peak antibody level \n posterior individual means (Autumnalis) \n(log2 dilution)")


joint.plot


```

```{r fig.height = 4, fig.width = 5}
ggplot(ind.means.2,aes(x = decay.rate.aut, y = peak.titer.aut)) +
       geom_point(alpha = 1,size = 0.8,col = brewer.pal(n = 11,"Spectral")[10]) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 14),
             text = element_text(size = 11),
             axis.text = element_text(size = 11),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")) +
       xlab("Decay rate posterior individual means (Autumnalis) \n(1/day)") +
       ylab("Peak antibody level \n posterior individual means (Autumnalis) \n(log2 dilution)")


```

(points on one line = no Autumnalis sample available, so sampling from
the prior.\
variation along peak titer axis is due to the correlation between Pomona
and Autumnalis peak level)

<br>

------------------------------------------------------------------------

<br> <br>

#### Fitted function

<br>

(red = estimated function)

```{r fig.height = 4,fig.width = 6}




fit.dat.aut = exp.fun(start.titer = peak.titer.overall.mean.aut, rate = -decay.rate.overall.mean.aut, time = 0:max(observed.data.for.fitting$time))

fit.dat.aut = data.frame(titer = fit.dat.aut, time = 0:max(observed.data.for.fitting$time))


ggplot() +
       geom_line(data = observed.data.for.fitting,aes(x = time,y = titer.aut,col = id,group = id),alpha = 0.4,size = 0.6) +
       geom_point(data = observed.data.for.fitting,aes(x = time,y = titer.aut,col = id,group = id),size=1.2,alpha = 0.9) +
       geom_line(data=fit.dat.aut,aes(x = time, y = titer),col=brewer.pal(11,"Spectral")[1],size=1.3) +
       scale_color_gradientn(colours  =  brewer.pal(4,"Spectral")) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 12),
             text = element_text(size = 11),
             axis.text = element_text(size = 11),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             legend.position  =  "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"))+
       xlab("Time since first positive sample (days)") +
       ylab("Antibody level (Autumnalis) \n(log2 dilution)")


```

<br>

Time = time since peak antibody level

```{r fig.height = 4,fig.width = 6}




fit.dat.aut = exp.fun(start.titer = peak.titer.overall.mean.aut, rate = -decay.rate.overall.mean.aut, time = 0:max(observed.data.for.fitting$time.since.peak))

fit.dat.aut = data.frame(titer = fit.dat.aut, time = 0:max(observed.data.for.fitting$time.since.peak))


ggplot() +
       geom_line(data = observed.data.for.fitting,aes(x = time.since.peak,y = titer.aut,col = id,group = id),alpha = 0.4,size = 0.6) +
       geom_point(data = observed.data.for.fitting,aes(x = time.since.peak,y = titer.aut,col = id,group = id),size=1.2,alpha = 0.9) +
       geom_line(data=fit.dat.aut,aes(x = time, y = titer),col=brewer.pal(11,"Spectral")[1],size=1.3) +
       scale_color_gradientn(colours  =  brewer.pal(4,"Spectral")) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 12),
             text = element_text(size = 11),
             axis.text = element_text(size = 11),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             legend.position  =  "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"))+
       xlab("Time since peak antibody level (days)") +
       ylab("Antibody level (Autumnalis) \n(log2 dilution)")


```

Including fitted functions for 200 random samples from the posterior
distribution (within 95% credible interval):

```{r fig.height = 4,fig.width = 6}

# sample N values from posterior distribution to get sense of error

N.samp = 200


set.seed(1234);sampled.iterations = sample(which(chains.burn.df$peak.titer.overall.aut > hpd.int.peak.titer.aut[1] & chains.burn.df$peak.titer.overall.aut < hpd.int.peak.titer.aut[2]), size = N.samp, replace = T)

peak.titer.samp.mean.aut = chains.burn.df$peak.titer.overall.aut[sampled.iterations]

peak.titer.samp.sd.aut = chains.burn.df$peak.titer.sd.overall.aut[sampled.iterations]


peak.titer.samp.df.aut = data.frame(peak.titer.samp.mean.aut,peak.titer.samp.sd.aut)

peak.titer.samp.fun = function(x) rnorm(1,x[1],x[2])

peak.titer.samp.aut = apply(peak.titer.samp.df.aut,1,peak.titer.samp.fun)

decay.rate.samp.mean.aut = chains.burn.df$decay.rate.overall.aut[sampled.iterations]

decay.rate.samp.aut = mean(chains.burn.df$decay.rate.overall.aut)

plot.times = 0:max(observed.data.for.fitting$time.since.peak)

fit.dat.cloud.aut = data.frame(time = rep(plot.times,N.samp), samp = rep(1:N.samp,each = length(plot.times)), titer = NA)

for(i in 1:N.samp){
       
       fit.dat.cloud.aut$titer[which(fit.dat.cloud.aut$samp == i)] = exp.fun(start.titer = peak.titer.samp.aut[i], rate = -decay.rate.samp.aut, time = plot.times)
       
}



ggplot() +
       geom_line(data=fit.dat.cloud.aut, aes(x = time, y = titer, group = samp), col = brewer.pal(11,"Spectral")[10],alpha=0.4,size=0.3) +
       geom_line(data=fit.dat.aut,aes(x = time, y = titer),col=brewer.pal(11,"Spectral")[1],size=1.5) +
       scale_color_gradientn(colours  =  brewer.pal(4,"Spectral")) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 12),
             text = element_text(size = 11),
             axis.text = element_text(size = 11),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             legend.position  =  "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"))+
       xlab("Time since peak antibody level (days)") +
       ylab("Antibody level (Autumnalis) \n(log2 dilution)")




```

## Pomona and Autumnalis

### Peak antibody level

Correlation between Pomona and Autumnalis peak antibody levels

```{r}

r2.fun = function(x) {
       summary(lm(as.numeric(x[1:(length(x)/2)])~as.numeric(x[((length(x)/2)+1):length(x)])))$r.squared
}

id.aut.not.all.na = unique(observed.data.for.fitting$id[which(!is.na(observed.data.for.fitting$titer.aut))])

r2s = apply(chains.burn.df[which(chains.burn.df$iteration %in% tail(chains.burn.df$iteration,1000)),c(paste0("peak.titer.aut.",id.aut.not.all.na),paste0("peak.titer.pomona.",id.aut.not.all.na))],1,r2.fun)

dens = density(r2s)
hpd.int.r2s = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
maxdens.r2s=round(dens$x[which.max(dens$y)],2)



intercept.fun = function(x) {
       summary(lm(as.numeric(x[1:(length(x)/2)])~as.numeric(x[((length(x)/2)+1):length(x)])))$coefficients[1]
}

intercepts = apply(chains.burn.df[which(chains.burn.df$iteration %in% tail(chains.burn.df$iteration,1000)),c(paste0("peak.titer.aut.",id.aut.not.all.na),paste0("peak.titer.pomona.",id.aut.not.all.na))],1,intercept.fun)

dens = density(intercepts)
hpd.int.intercepts = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
maxdens.intercepts=round(dens$x[which.max(dens$y)],2)


slope.fun = function(x) {
       summary(lm(as.numeric(x[1:(length(x)/2)])~as.numeric(x[((length(x)/2)+1):length(x)])))$coefficients[2]
}

slopes = apply(chains.burn.df[which(chains.burn.df$iteration %in% tail(chains.burn.df$iteration,1000)),c(paste0("peak.titer.aut.",id.aut.not.all.na),paste0("peak.titer.pomona.",id.aut.not.all.na))],1,slope.fun)

dens = density(slopes)
hpd.int.slopes = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)  
maxdens.slopes=round(dens$x[which.max(dens$y)],2)



```

R\^2 = `r  maxdens.r2s`, 95% CrI = `r hpd.int.r2s[1]` -
`r hpd.int.r2s[2]`.\
Intercept = `r  maxdens.intercepts`, 95% CrI = `r hpd.int.intercepts[1]`
- `r hpd.int.intercepts[2]`.\
(= Aut peak level - Pom peak level)\
Effect estimate = `r  maxdens.slopes`, 95% CrI = `r hpd.int.slopes[1]` -
`r hpd.int.slopes[2]`.\
(= slope)

```{r fig.height = 4, fig.width = 4.5}

Nsamp = 200
means.pomona = sample(chains.burn.df$peak.titer.overall.pomona,Nsamp,replace = F)
sds.pomona = sample(chains.burn.df$peak.titer.sd.overall.pomona,Nsamp,replace = F)
means.aut = sample(chains.burn.df$peak.titer.overall.aut,Nsamp,replace = F)
sds.aut = sample(chains.burn.df$peak.titer.sd.overall.aut,Nsamp,replace = F)


ggplot(data = data.frame(x = 0:15),aes(x=x)) +
       scale_x_continuous(breaks=0:15) +
       
       mapply(function(mean,sd){
              stat_function(fun = dnorm, args = list(mean = mean,sd = sd),aes(color="Autumnalis"),size=0.4)
       },
       mean = means.aut,
       sd = sds.aut
       ) +
       stat_function(fun = dnorm, args = list(mean = peak.titer.overall.mean.aut,sd = peak.titer.sd.overall.mean.aut),color =  brewer.pal(11,"Spectral")[1],size=1.5) +
       geom_vline(xintercept=peak.titer.overall.mean.aut,col=brewer.pal(11,"Spectral")[1],size=0.8,alpha=0.6) +
       mapply(function(mean,sd){
              stat_function(fun = dnorm,args = list(mean = mean,sd = sd),aes(color="Pomona"),size=0.4)
       },
       mean = means.pomona,
       sd = sds.pomona
       ) +
       stat_function(fun = dnorm, args = list(mean = peak.titer.overall.mean.pomona,sd = peak.titer.sd.overall.mean.pomona),color =  brewer.pal(11,"Spectral")[10],size=1.5) +
       geom_vline(xintercept=peak.titer.overall.mean.pomona,col=brewer.pal(11,"Spectral")[10],size=0.8,alpha=0.6) +
       scale_color_manual("Serovar",values = alpha(c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1]),0.3)) +
       xlab("Peak antibody level \n(log2 dilution)") +
       ylab("Density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             legend.position = c(0.85,0.75),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.background = element_rect(colour = "transparent", fill = "transparent")
       )




plot1 = ggplot(data = data.frame(x = 0:15),aes(x=x)) +
       scale_x_continuous(breaks=seq(0,15,2),limits = c(0,16)) +
       mapply(function(mean,sd){
              stat_function(fun = dnorm, args = list(mean = mean,sd = sd),aes(color="Autumnalis"),size=0.2,alpha=0.1)
       },
       mean = means.aut,
       sd = sds.aut
       ) +
       mapply(function(mean,sd){
              stat_function(fun = dnorm,args = list(mean = mean,sd = sd),aes(color="Pomona"),size=0.2,alpha=0.1)
       },
       mean = means.pomona,
       sd = sds.pomona
       ) +
       stat_function(fun = dnorm, args = list(mean = peak.titer.overall.mean.aut,sd = peak.titer.sd.overall.mean.aut),color =  brewer.pal(11,"Spectral")[1],size=1.5) +
       stat_function(fun = dnorm, args = list(mean = peak.titer.overall.mean.pomona,sd = peak.titer.sd.overall.mean.pomona),color =  brewer.pal(11,"Spectral")[10],size=1.5) +
       #geom_vline(xintercept=peak.titer.overall.mean.aut,col=brewer.pal(11,"Spectral")[1],size=1,alpha=1) +
       #geom_vline(xintercept=peak.titer.overall.mean.pomona,col=brewer.pal(11,"Spectral")[10],size=1,alpha=1) +
       scale_color_manual("Serovar",values = alpha(c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1]),0.3)) +
       xlab("Peak antibody level \n(log2 dilution)") +
       ylab("Density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 13),
             text=element_text(size=13),
             axis.text=element_text(size=13),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             legend.title = element_text(size = 10),
             legend.text = element_text(size = 9),
             #legend.position = c(0.78,0.85),
             legend.position = "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.background = element_rect(colour = "transparent", fill = "transparent"),
             legend.key = element_rect(fill = NA)
       ) +
       labs(tag = "(A)")

```

Individual level means:

```{r fig.height = 4, fig.width = 4.5}
cor.plot.individual = ggplot(ind.means.2,aes(x = peak.titer.pomona, y = peak.titer.aut)) +
       geom_point(alpha = 1,size = 0.8,col = brewer.pal(n = 11,"Spectral")[10]) +
       theme_light(base_family = "Avenir Next") +
       scale_x_continuous(breaks = seq(0,15,2)) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme(plot.title  =  element_text(size  = 13),
             text = element_text(size = 13),
             axis.text = element_text(size = 13),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")) +
       xlab("Peak antibody level (log2 dilution) \n posterior individual means \n (Pomona)") +
       ylab("Peak antibody level (log2 dilution) \n posterior individual means \n (Autumnalis)") +
       labs(tag = "(A)")

cor.plot.individual

```


```{r fig.height = 4, fig.width = 6}
joint.dens = chains.burn.df[,c("peak.titer.overall.pomona","peak.titer.overall.aut")]
joint.dens$dens = get_density(chains.burn.df$peak.titer.overall.pomona,chains.burn.df$peak.titer.overall.aut,n = 80)


joint.plot.peak.correlation = ggplot(joint.dens,aes(x = peak.titer.overall.pomona, y = peak.titer.overall.aut,color=dens)) +
       geom_point(alpha = 0.4,size = 0.5) +
       scale_colour_gradientn(colors = rev(brewer.pal(n = 6,"Spectral")),name="Density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 13),
             text = element_text(size = 13),
             axis.text = element_text(size = 13),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")) +
       xlab("Peak antibody level (log2 dilution) \n  posterior overall mean \n (Pomona)") +
       ylab("Peak antibody level (log2 dilution) \n  posterior overall mean \n (Autumnalis)") +
       labs(tag = "(B)")


joint.plot.peak.correlation


```

Combined plot peak titer correlations for manuscript    

```{r fig.height = 4, fig.width = 11}

comb.plot.correlation = cor.plot.individual + joint.plot.peak.correlation


comb.plot.correlation

```


### Decay rate

```{r fig.height = 4, fig.width = 4.5}

Nsamp = 200
means.pomona = sample(chains.burn.df$decay.rate.overall.pomona,Nsamp,replace = F)
sds.pomona = sample(chains.burn.df$decay.rate.sd.overall.pomona,Nsamp,replace = F)
means.aut = sample(chains.burn.df$decay.rate.overall.aut,Nsamp,replace = F)
sds.aut = sample(chains.burn.df$decay.rate.sd.overall.aut,Nsamp,replace = F)


ggplot(data = data.frame(x = seq(0,0.0016,0.0001)),aes(x=x)) +
       #scale_x_continuous(breaks=0:15) +
       
       mapply(function(mean,sd){
              stat_function(fun = dnorm, args = list(mean = mean,sd = sd),aes(color="Autumnalis"),size=0.4)
       },
       mean = means.aut,
       sd = sds.aut
       ) +
       stat_function(fun = dnorm, args = list(mean = decay.rate.overall.mean.aut,sd = decay.rate.sd.overall.mean.aut),color =  brewer.pal(11,"Spectral")[1],size=1.5) +
       geom_vline(xintercept=decay.rate.overall.mean.aut,col=brewer.pal(11,"Spectral")[1],size=0.8,alpha=0.6) +
       mapply(function(mean,sd){
              stat_function(fun = dnorm,args = list(mean = mean,sd = sd),aes(color="Pomona"),size=0.4)
       },
       mean = means.pomona,
       sd = sds.pomona
       ) +
       stat_function(fun = dnorm, args = list(mean = decay.rate.overall.mean.pomona,sd = decay.rate.sd.overall.mean.pomona),color =  brewer.pal(11,"Spectral")[10],size=1.5) +
       geom_vline(xintercept=decay.rate.overall.mean.pomona,col=brewer.pal(11,"Spectral")[10],size=0.8,alpha=0.6) +
       scale_color_manual("Serovar",values = alpha(c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1]),0.3)) +
       xlab("Decay rate (1/day)") +
       ylab("Density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             legend.position = c(0.85,0.75),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.background = element_rect(colour = "transparent", fill = "transparent")
       )

plot2 = ggplot(data = data.frame(x = seq(0,0.0017,0.0001)),aes(x=x)) +
       #scale_x_continuous(breaks=0:15) +
       
       mapply(function(mean,sd){
              stat_function(fun = dnorm, args = list(mean = mean,sd = sd),aes(color="Autumnalis"),size=0.2,alpha=0.1)
       },
       mean = means.aut,
       sd = sds.aut
       ) +
       
       #geom_vline(xintercept=decay.rate.overall.mean.aut,col=brewer.pal(11,"Spectral")[1],size=0.8,alpha=0.6) +
       mapply(function(mean,sd){
              stat_function(fun = dnorm,args = list(mean = mean,sd = sd),aes(color="Pomona"),size=0.2,alpha=0.1)
       },
       mean = means.pomona,
       sd = sds.pomona
       ) +
       stat_function(fun = dnorm, args = list(mean = decay.rate.overall.mean.aut,sd = decay.rate.sd.overall.mean.aut),color =  brewer.pal(11,"Spectral")[1],size=1.5) +
       stat_function(fun = dnorm, args = list(mean = decay.rate.overall.mean.pomona,sd = decay.rate.sd.overall.mean.pomona),color =  brewer.pal(11,"Spectral")[10],size=1.5) +
       #geom_vline(xintercept=decay.rate.overall.mean.pomona,col=brewer.pal(11,"Spectral")[10],size=0.8,alpha=0.6) +
       scale_color_manual("Serovar",values = alpha(c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1]),0.3)) +
       scale_x_continuous(breaks = c(0,0.00075,0.0015),labels = c("0","0.00075","0.0015")) +
       xlab("Decay rate \n(1/day)") +
       ylab("Density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 13),
             text=element_text(size=13),
             axis.text=element_text(size=13),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             legend.title = element_text(size = 12),
             legend.text = element_text(size = 11),
             #legend.position = "none",
             legend.position = c(0.75,0.85),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.background = element_rect(colour = "transparent", fill = "transparent"),
             legend.key = element_rect(fill = NA)
       ) +
       labs(tag = "(B)")

```

### Fitted function

```{r fig.height = 4, fig.width = 6}

ggplot() +
       #geom_line(data=fit.dat.cloud.aut, aes(x = time, y = titer, group = samp), col = brewer.pal(11,"Spectral")[1],alpha=0.5,size=0.3) +
       geom_line(data=fit.dat.aut,aes(x = time, y = titer,col="Autumnalis"),size=1.5) +
       #geom_line(data=fit.dat.cloud.pomona, aes(x = time, y = titer, group = samp), col = brewer.pal(11,"Spectral")[10],alpha=0.5,size=0.3) +
       geom_line(data=fit.dat.pomona,aes(x = time, y = titer,col="Pomona"),size=1.5) +
       scale_color_manual("Serovar",values = c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1])) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 12),
             text = element_text(size = 11),
             axis.text = element_text(size = 11),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             #legend.position  =  "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"))+
       xlab("Time since peak antibody level (days)") +
       ylab("Antibody level (log2 dilution)")


ggplot() +
       geom_line(data=fit.dat.cloud.aut, aes(x = time, y = titer, group = samp, col = "Autumnalis"),alpha=0.5,size=0.3) +
       #geom_line(data=fit.dat.aut,aes(x = time, y = titer,col="Autumnalis"),size=1.5) +
       geom_line(data=fit.dat.cloud.pomona, aes(x = time, y = titer, group = samp, col = "Pomona"),alpha=0.5,size=0.3) +
       #geom_line(data=fit.dat.pomona,aes(x = time, y = titer,col="Pomona"),size=1.5) +
       scale_color_manual("Serovar",values = c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1])) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 12),
             text = element_text(size = 11),
             axis.text = element_text(size = 11),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             #legend.position  =  "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"))+
       xlab("Time since peak antibody level (days)") +
       ylab("Antibody level (log2 dilution)")

plot3 = ggplot() +
       geom_line(data=fit.dat.cloud.aut, aes(x = time, y = titer, group = samp, col = "Autumnalis"),alpha=0.1,size=0.2) +
       geom_line(data=fit.dat.cloud.pomona, aes(x = time, y = titer, group = samp, col = "Pomona"),alpha=0.1,size=0.2) +
       geom_line(data=fit.dat.aut,aes(x = time, y = titer,col="Autumnalis"),size=1.5) +
       geom_line(data=fit.dat.pomona,aes(x = time, y = titer,col="Pomona"),size=1.5) +
       scale_color_manual("Serovar",values = c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1])) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title  =  element_text(size  = 12),
             text = element_text(size = 11),
             axis.text = element_text(size = 11),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)),
             legend.position  =  c(0.85,0.75),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"))+
       xlab("Time since peak antibody level (days)") +
       ylab("Antibody level (log2 dilution)")
labs(tag = "(C)")

```

## Combined figures peak antibody level, decay rate, fitted functions

```{r fig.height = 4, fig.width = 12}

plot1 + plot2 + plot3 + 
       plot_layout(widths = c(1,1,2))
```

```{r fig.height = 4, fig.width = 9}

plot1 + plot2
```


joint.plot.peak.decay

```{r fig.height = 4, fig.width = 13}

comb.plot = plot1 + plot2 + joint.plot.peak.decay +
       plot_layout(widths = c(4,4,4))


comb.plot


```



## Combined figure function comparison and fitted Pom and Aut    


```{r fig.height = 4, fig.width = 9}

# import posterior estimates for the three functions

all.fun.post.overall = readRDS("Function_comparison_post_overall.RDS")

fit.dat.single = linear.fun(peak.titer = all.fun.post.overall$peak.titer.mean[1], slope = -all.fun.post.overall$decay.mean[1], time = 0:4000)
fit.dat.single = data.frame(titer = fit.dat.single, time = 0:4000)
fit.dat.single$model = "Single exp"
fit.dat.single = fit.dat.single[-which(fit.dat.single$titer<0),]


fit.dat.double = exp.fun(start.titer = all.fun.post.overall$peak.titer.mean[2], rate = -all.fun.post.overall$decay.mean[2], time = 0:4000)

fit.dat.double = data.frame(titer = fit.dat.double, time = 0:4000)

fit.dat.double$model = "Double exp"


fit.dat.double.aut = exp.fun(start.titer = all.fun.post.overall$peak.titer.aut.mean[2], rate = -all.fun.post.overall$decay.aut.mean[2], time = 0:4000)

fit.dat.double.aut = data.frame(titer = fit.dat.double.aut, time = 0:4000)

fit.dat.double.aut$model = "Double exp (Autumnalis)"



fit.dat.power = power.fun(peak.titer = all.fun.post.overall$peak.titer.mean[3], shape = all.fun.post.overall$shape.mean[3],scale = all.fun.post.overall$scale.mean[3], time = 0:4000)

fit.dat.power = data.frame(titer = fit.dat.power, time = 0:4000)

fit.dat.power$model = "Power"


fit.dat = rbind(fit.dat.single,fit.dat.double,fit.dat.power)

fit.dat$model = factor(fit.dat$model,levels = c("Single exp","Double exp","Power"))


plot.1.functions = ggplot(data=fit.dat,aes(x = time, y = titer,color=model,group=model)) +
       geom_line(size=1.2) +
       scale_color_manual("Model",values  =  brewer.pal(4,"Spectral"),labels = c("Single exponential","Double exponential","Power")) +
       scale_y_continuous(limits = c(0,8),breaks = 0:8) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 13),
             text=element_text(size=13),
             axis.text=element_text(size=13),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = c(0.65,0.75),
             legend.background = element_rect(colour = "transparent", fill = "transparent"),
             legend.key = element_rect(colour = "transparent", fill = "transparent")
       ) +
       xlab("Time since peak \nantibody level (days)") +
       ylab("Antibody level (log2 dilution)") +
       labs(tag="(A)")



plot2.with.aut = ggplot() +
       #geom_line(data = observed.data.for.fitting,aes(x = time.since.peak,y = titer.pomona,col = id,group = id),alpha = 0.2,size = 0.2,color=brewer.pal(11,"Spectral")[10]) +
       geom_point(data = observed.data.for.fitting,aes(x = time.since.peak,y = titer.pomona-0.1,col = id,group = id),size=1,alpha = 0.4,color=brewer.pal(11,"Spectral")[10]) +
       #geom_line(data = observed.data.for.fitting,aes(x = time.since.peak,y = titer.aut,col = id,group = id),alpha = 0.2,size = 0.2,color=brewer.pal(11,"Spectral")[1]) +
       geom_point(data = observed.data.for.fitting,aes(x = time.since.peak,y = titer.aut+0.1,col = id,group = id),size=1,alpha = 0.4,color=brewer.pal(11,"Spectral")[1]) +
       geom_line(data=fit.dat.double,aes(x = time, y = titer,col="Pomona"),size=1.6) +
       geom_line(data=fit.dat.double.aut,aes(x = time, y = titer,col="Autumnalis"),size=1.6) +
       #scale_color_gradientn(colours  =  brewer.pal(4,"Spectral")) +
       scale_color_manual("Serovar",values = alpha(c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1]),1)) +
       scale_y_continuous(limits = c(0,12),breaks = 0:12) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 13),
             text=element_text(size=13),
             axis.text=element_text(size=13),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = c(0.7,0.8),
             legend.background = element_rect(colour = "transparent", fill = "transparent"),
             legend.key = element_rect(colour = "transparent", fill = "transparent")
       ) +
       #ggtitle("Double exponential") +
       xlab("Time since peak \nantibody level (days)") +
       ylab("Antibody level (log2 dilution)") +
       labs(tag = "(B)")


plotA = plot.1.functions + plot2.with.aut
plotA

```



```{r fig.height=4,fig.width=6}

# dataframe to store estimated parameters

model.outputs = data.frame(id = 1:N.inds,
                           pittag = unique(observed.data.for.fitting$Pittag),
                           toi.mid.interval = round(neg.intervals[1:N.inds]/2),
                           toi.estimated.mean = NA,
                           toi.estimated.median = NA,
                           toi.estimated.maxdens = NA,
                           toi.estimated.mean.95ci.low = NA,
                           toi.estimated.mean.95ci.high = NA,
                           toi.estimated.maxdens.95hdi.low = NA,
                           toi.estimated.maxdens.95hdi.high = NA,
                           toi.information.gained.95cri.perc = NA,
                           toi.information.gained.80cri.perc = NA,
                           toi.information.gained.50cri.perc = NA,
                           kl.divergence = NA,
                           peak.titer.estimated.mean.pomona = NA,
                           peak.titer.estimated.median.pomona = NA,
                           peak.titer.estimated.maxdens.pomona = NA,
                           peak.titer.estimated.mean.95ci.low.pomona = NA,
                           peak.titer.estimated.mean.95ci.high.pomona = NA,
                           peak.titer.estimated.maxdens.95hdi.low.pomona = NA,
                           peak.titer.estimated.maxdens.95hdi.high.pomona = NA,
                           decay.rate.estimated.mean.pomona = NA,
                           decay.rate.estimated.median.pomona = NA,
                           decay.rate.estimated.maxdens.pomona = NA,
                           decay.rate.estimated.mean.95ci.low.pomona = NA,
                           decay.rate.estimated.mean.95ci.high.pomona = NA,
                           decay.rate.estimated.maxdens.95hdi.low.pomona = NA,
                           decay.rate.estimated.maxdens.95hdi.high.pomona = NA,
                           peak.titer.estimated.mean.aut = NA,
                           peak.titer.estimated.median.aut = NA,
                           peak.titer.estimated.maxdens.aut = NA,
                           peak.titer.estimated.mean.95ci.low.aut = NA,
                           peak.titer.estimated.mean.95ci.high.aut = NA,
                           peak.titer.estimated.maxdens.95hdi.low.aut = NA,
                           peak.titer.estimated.maxdens.95hdi.high.aut = NA,
                           decay.rate.estimated.mean.aut = NA,
                           decay.rate.estimated.median.aut = NA,
                           decay.rate.estimated.maxdens.aut = NA,
                           decay.rate.estimated.mean.95ci.low.aut = NA,
                           decay.rate.estimated.mean.95ci.high.aut = NA,
                           decay.rate.estimated.maxdens.95hdi.low.aut = NA,
                           decay.rate.estimated.maxdens.95hdi.high.aut = NA
)




# matrix for plotting individual posteriors of time of infection
# nrow = number of iterations to store
theta.all = matrix(data = NA, ncol = N.inds, nrow = 6000)  



# print figures?  

plot.figs = F

teller = 1
for(i in 1:N.inds){
       
       
       
       chains.current.individual.df = chains.burn.df[,c(paste0("peak.titer.pomona.",i),paste0("peak.titer.aut.",i),paste0("decay.rate.pomona.",i),paste0("decay.rate.aut.",i),paste0("toi.",i),"iteration","chain")]
       
       colnames(chains.current.individual.df) = c("peak.titer.pomona","peak.titer.aut","decay.rate.pomona","decay.rate.aut","toi","iteration","chain")
       
       theta.all[,i] = chains.current.individual.df[which(chains.current.individual.df$iteration %in% (max(chains.current.individual.df$iteration)-999):max(chains.current.individual.df$iteration)),"toi"]
       
       model.outputs[teller,"toi.estimated.mean"] = round(mean(chains.current.individual.df[,"toi"]))
       model.outputs[teller,"peak.titer.estimated.mean.pomona"] = round(mean(chains.current.individual.df[,"peak.titer.pomona"]),1)
       model.outputs[teller,"decay.rate.estimated.mean.pomona"] = round(mean(chains.current.individual.df[,"decay.rate.pomona"]),6)
       model.outputs[teller,"peak.titer.estimated.mean.aut"] = round(mean(chains.current.individual.df[,"peak.titer.aut"]),1)
       model.outputs[teller,"decay.rate.estimated.mean.aut"] = round(mean(chains.current.individual.df[,"decay.rate.aut"]),6)
       
       model.outputs[teller,"toi.estimated.median"] = median(round(chains.current.individual.df[,"toi"]))
       model.outputs[teller,"peak.titer.estimated.median.pomona"] = median(round(chains.current.individual.df[,"peak.titer.pomona"],1))
       model.outputs[teller,"decay.rate.estimated.median.pomona"] = median(round(chains.current.individual.df[,"decay.rate.pomona"],6))
       model.outputs[teller,"peak.titer.estimated.median.aut"] = median(round(chains.current.individual.df[,"peak.titer.aut"],1))
       model.outputs[teller,"decay.rate.estimated.median.aut"] = median(round(chains.current.individual.df[,"decay.rate.aut"],6))
       
       
       
       dens = density(chains.current.individual.df[,"toi"],bw = 5,from = neg.intervals[i],to=0)
       model.outputs[teller,"toi.estimated.maxdens"] = round(dens$x[which.max(dens$y)])
       hpd.int.toi = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)    # highest posterior density credible intervals
       # quantile(chains.current.individual.df[which(chains.current.individual.df$iteration > burn.in),2],c(0.025,0.975))
       model.outputs[teller,"toi.estimated.maxdens.95hdi.low"] = round(hpd.int.toi[1])
       model.outputs[teller,"toi.estimated.maxdens.95hdi.high"] = round(hpd.int.toi[2])
       
       model.outputs[teller,"toi.information.gained.95cri.perc"] = 1-abs((as.numeric(hpd.int.toi[2]-hpd.int.toi[1])/(0.95*neg.intervals[i])))
       
       hpd.int.toi.80 = HDInterval::hdi(dens,credMass = 0.80,allowSplit=F)    # highest posterior density credible intervals
       model.outputs[teller,"toi.information.gained.80cri.perc"] = 1-abs((as.numeric(hpd.int.toi.80[2]-hpd.int.toi.80[1])/(0.8*neg.intervals[i])))
       
       hpd.int.toi.50 = HDInterval::hdi(dens,credMass = 0.50,allowSplit=F)    # highest posterior density credible intervals
       model.outputs[teller,"toi.information.gained.50cri.perc"] = 1-abs((as.numeric(hpd.int.toi.50[2]-hpd.int.toi.50[1])/(0.5*neg.intervals[i])))
       
       ### Relative entropy / Kullback-Leibler divergence
       prior.values = neg.intervals[i]:0
       posterior.values = chains.current.individual.df[,"toi"]
       model.outputs[teller,"kl.divergence"] = kl.divergence(prior.values,posterior.values)
       
       
       
       
       
       mean.eti.toi = mean.eti(chains.current.individual.df[,"toi"])
       model.outputs[teller,"toi.estimated.mean.95ci.low"] = round(mean.eti.toi[1])
       model.outputs[teller,"toi.estimated.mean.95ci.high"] = round(mean.eti.toi[2])
       
       
       
       dens = density(chains.current.individual.df[,"peak.titer.pomona"])
       model.outputs[teller,"peak.titer.estimated.maxdens.pomona"] = round(dens$x[which.max(dens$y)],1)
       hpd.int.peak.titer.pomona = HDInterval::hdi(dens,allowSplit=F)
       
       mean.eti.peak.titer.pomona = mean.eti(chains.current.individual.df[,"peak.titer.pomona"])
       model.outputs[teller,"peak.titer.estimated.maxdens.95hdi.low.pomona"] = round(hpd.int.peak.titer.pomona[1],1)
       model.outputs[teller,"peak.titer.estimated.maxdens.95hdi.high.pomona"] = round(hpd.int.peak.titer.pomona[2],1)
       model.outputs[teller,"peak.titer.estimated.mean.95ci.low.pomona"] = round(mean.eti.peak.titer.pomona[1],1)
       model.outputs[teller,"peak.titer.estimated.mean.95ci.high.pomona"] = round(mean.eti.peak.titer.pomona[2],1)
       
       
       dens = density(chains.current.individual.df[,"peak.titer.aut"])
       model.outputs[teller,"peak.titer.estimated.maxdens.aut"] = round(dens$x[which.max(dens$y)],1)
       hpd.int.peak.titer.aut = HDInterval::hdi(dens,allowSplit=F)
       
       mean.eti.peak.titer.aut = mean.eti(chains.current.individual.df[,"peak.titer.aut"])
       model.outputs[teller,"peak.titer.estimated.maxdens.95hdi.low.aut"] = round(hpd.int.peak.titer.aut[1],1)
       model.outputs[teller,"peak.titer.estimated.maxdens.95hdi.high.aut"] = round(hpd.int.peak.titer.aut[2],1)
       model.outputs[teller,"peak.titer.estimated.mean.95ci.low.aut"] = round(mean.eti.peak.titer.aut[1],1)
       model.outputs[teller,"peak.titer.estimated.mean.95ci.high.aut"] = round(mean.eti.peak.titer.aut[2],1)
       
       
       
       dens = density(chains.current.individual.df[,"decay.rate.pomona"])
       model.outputs[teller,"decay.rate.estimated.maxdens.pomona"] = round(dens$x[which.max(dens$y)],6)
       hpd.int.decay.rate.pomona = HDInterval::hdi(dens,allowSplit=F)
       
       mean.eti.decay.rate.pomona = mean.eti(chains.current.individual.df[,"decay.rate.pomona"])
       model.outputs[teller,"decay.rate.estimated.maxdens.95hdi.low.pomona"] = round(hpd.int.decay.rate.pomona[1],6)
       model.outputs[teller,"decay.rate.estimated.maxdens.95hdi.high.pomona"] = round(hpd.int.decay.rate.pomona[2],6)
       model.outputs[teller,"decay.rate.estimated.mean.95ci.low.pomona"] = round(mean.eti.decay.rate.pomona[1],6)
       model.outputs[teller,"decay.rate.estimated.mean.95ci.high.pomona"] = round(mean.eti.decay.rate.pomona[2],6)
       
       
       dens = density(chains.current.individual.df[,"decay.rate.aut"])
       model.outputs[teller,"decay.rate.estimated.maxdens.aut"] = round(dens$x[which.max(dens$y)],6)
       hpd.int.decay.rate.aut = HDInterval::hdi(dens,allowSplit=F)
       
       mean.eti.decay.rate.aut = mean.eti(chains.current.individual.df[,"decay.rate.aut"])
       model.outputs[teller,"decay.rate.estimated.maxdens.95hdi.low.aut"] = round(hpd.int.decay.rate.aut[1],6)
       model.outputs[teller,"decay.rate.estimated.maxdens.95hdi.high.aut"] = round(hpd.int.decay.rate.aut[2],6)
       model.outputs[teller,"decay.rate.estimated.mean.95ci.low.aut"] = round(mean.eti.decay.rate.aut[1],6)
       model.outputs[teller,"decay.rate.estimated.mean.95ci.high.aut"] = round(mean.eti.decay.rate.aut[2],6)
       
       
       
       
       
       plot1 = ggplot(data=chains.current.individual.df,aes(x=toi)) +
              geom_density(color=brewer.pal(11,"Spectral")[10],fill=brewer.pal(11,"Spectral")[10],alpha=0.6,size=1) +
              geom_vline(xintercept = model.outputs[teller,"toi.estimated.maxdens"],col="black",size=0.8,alpha=0.6) +
              geom_vline(xintercept = model.outputs[teller,"toi.estimated.maxdens.95hdi.low"],col="black",size=0.8,linetype="dotted",alpha=0.6) +
              geom_vline(xintercept = model.outputs[teller,"toi.estimated.maxdens.95hdi.high"],col="black",size=0.8,linetype="dotted",alpha=0.6) +
              theme_light(base_family = "Avenir Next") +
              ggtitle(paste0("Individual ",model.outputs[i,"pittag"])) +
              xlab("\u03B8 (days)") +
              ylab("Posterior density") +
              theme(plot.title = element_text(size = 11),
                    text=element_text(size=11),
                    axis.text=element_text(size=10),
                    axis.title.y = element_text(margin = ggplot2::margin(r=10)),
                    plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
                    legend.position = "none"
              )
       
       
       
       #plot2 = plot.MCMC.chains(input.data = chains.current.individual.df, column.to.plot = which(colnames(chains.current.individual.df)=="toi"), y.axis.label = "Theta",thinning = 20, title = paste0("Individual ",model.outputs[i,"pittag"]))
       
       if(plot.figs==T) print(plot1)
       
       
       
       
       plot1 = ggplot(data = data.frame(x = 0:15),aes(x=x)) +
              stat_function(fun = dnorm, args = list(mean = model.outputs[teller,"peak.titer.estimated.maxdens.pomona"],sd = sd(chains.current.individual.df$peak.titer.pomona)),aes(col="Pomona"),size=1.5) +
              geom_vline(xintercept = model.outputs[teller,"peak.titer.estimated.maxdens.pomona"],col=brewer.pal(11,"Spectral")[10]) +
              stat_function(fun = dnorm, args = list(mean = model.outputs[teller,"peak.titer.estimated.maxdens.aut"],sd = sd(chains.current.individual.df$peak.titer.aut)),aes(col="Autumnalis"),size=1.5) +
              geom_vline(xintercept = model.outputs[teller,"peak.titer.estimated.maxdens.aut"],col=brewer.pal(11,"Spectral")[1]) +
              scale_color_manual("Serovar",values = c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1])) +
              theme_light(base_family = "Avenir Next") +
              ggtitle(paste0("Individual ",model.outputs[i,"pittag"])) +
              xlab("Peak antibody level (log2 dilution)") +
              ylab("Posterior density") +
              theme(plot.title = element_text(size = 11),
                    text=element_text(size=11),
                    axis.text=element_text(size=10),
                    axis.title.y = element_text(margin = ggplot2::margin(r=10)),
                    plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
              )
       
       
       
       
       
       
       plot2 = ggplot(data = data.frame(x = seq(-0.00015,0.002,0.0001)),aes(x=x)) +
              stat_function(fun = dnorm, args = list(mean = model.outputs[teller,"decay.rate.estimated.maxdens.pomona"],sd = sd(chains.current.individual.df$decay.rate.pomona)),aes(col="Pomona"),size=1.5) +
              geom_vline(xintercept = model.outputs[teller,"decay.rate.estimated.maxdens.pomona"],col=brewer.pal(11,"Spectral")[10]) +
              stat_function(fun = dnorm, args = list(mean = model.outputs[teller,"decay.rate.estimated.maxdens.aut"],sd = sd(chains.current.individual.df$decay.rate.aut)),aes(col="Autumnalis"),size=1.5) +
              geom_vline(xintercept = model.outputs[teller,"decay.rate.estimated.maxdens.aut"],col=brewer.pal(11,"Spectral")[1]) +
              scale_color_manual("Serovar",values = c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1])) +
              ggtitle(paste0("Individual ",model.outputs[i,"pittag"])) +
              xlab("Decay rate (1/day)") +
              ylab("Posterior density") +
              theme_light(base_family = "Avenir Next") +
              theme(plot.title = element_text(size = 11),
                    text=element_text(size=11),
                    axis.text=element_text(size=10),
                    axis.title.y = element_text(margin = ggplot2::margin(r=10)),
                    plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
              )
       
       
       
       if(plot.figs==T) print(plot1)
       if(plot.figs==T) print(plot2)
       
       
       
       
       
       
       # pomona
       # sample N values from posterior distribution to get sense of error
       
       N.samp = 200
       
       
       set.seed(1234);peak.titer.samp = sample(chains.current.individual.df$peak.titer.pomona[which(chains.current.individual.df$peak.titer.pomona > hpd.int.peak.titer.pomona[1] & chains.current.individual.df$peak.titer.pomona < hpd.int.peak.titer.pomona[2])], size = N.samp, replace = T)
       
       set.seed(1234);decay.rate.samp = sample(chains.current.individual.df$decay.rate.pomona[which(chains.current.individual.df$decay.rate.pomona > hpd.int.decay.rate.pomona[1] & chains.current.individual.df$decay.rate.pomona < hpd.int.decay.rate.pomona[2])], size = N.samp, replace = T)
       
       plot.times = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)])
       
       fit.dat.cloud.pomona = data.frame(time = rep(plot.times,N.samp), samp = rep(1:N.samp,each = length(plot.times)), titer = NA)
       
       for(ii in 1:N.samp){
              
              fit.dat.cloud.pomona$titer[which(fit.dat.cloud.pomona$samp == ii)] = exp.fun(start.titer = peak.titer.samp[ii], rate = -decay.rate.samp[ii], time = plot.times)
              
       }
       
       
       fit.dat.pomona = exp.fun(start.titer = model.outputs[teller,"peak.titer.estimated.mean.pomona"], rate = -model.outputs[teller,"decay.rate.estimated.mean.pomona"], time = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)]))
       
       fit.dat.pomona = data.frame(titer = fit.dat.pomona, time = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)]))
       
       
       plot3 = ggplot() +
              #geom_line(data = observed.data.for.fitting[which(observed.data.for.fitting$id==i),],aes(x = time.since.peak,y = titer),alpha = 0.8,size = 1.5,color="#F46D43") +
              geom_line(data=fit.dat.cloud.pomona, aes(x = time, y = titer, group = samp), col = brewer.pal(11,"Spectral")[10],alpha=0.2,size=0.4) +
              geom_line(data=fit.dat.pomona,aes(x = time, y = titer),col=brewer.pal(11,"Spectral")[10],size=1.5,alpha=1) +
              geom_point(data = observed.data.for.fitting[which(observed.data.for.fitting$id==i),],aes(x = time.since.peak,y = titer.pomona),size=3,alpha = 1,color="black") +
              #scale_color_gradientn(colours  =  brewer.pal(11,"Spectral")) +
              scale_y_continuous(limits = c(0,13),breaks=0:13) +
              ggtitle(paste0("Individual ",model.outputs[i,"pittag"])) +
              theme_light(base_family = "Avenir Next") +
              theme(plot.title = element_text(size = 11),
                    text=element_text(size=11),
                    axis.text=element_text(size=10),
                    axis.title.y = element_text(margin = ggplot2::margin(r=10)),
                    plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
              ) +
              xlab("Time since peak antibody level (days)") +
              ylab("Antibody level (Pomona) (log2 dilution)")
       
       
       if(plot.figs==T) print(plot3)
       
       
       # aut
       # sample N values from posterior distribution to get sense of error
       
       N.samp = 200
       
       
       set.seed(1234);peak.titer.samp = sample(chains.current.individual.df$peak.titer.aut[which(chains.current.individual.df$peak.titer.aut > hpd.int.peak.titer.aut[1] & chains.current.individual.df$peak.titer.aut < hpd.int.peak.titer.aut[2])], size = N.samp, replace = T)
       
       set.seed(1234);decay.rate.samp = sample(chains.current.individual.df$decay.rate.aut[which(chains.current.individual.df$decay.rate.aut > hpd.int.decay.rate.aut[1] & chains.current.individual.df$decay.rate.aut < hpd.int.decay.rate.aut[2])], size = N.samp, replace = T)
       
       plot.times = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)])
       
       fit.dat.cloud.aut = data.frame(time = rep(plot.times,N.samp), samp = rep(1:N.samp,each = length(plot.times)), titer = NA)
       
       for(ii in 1:N.samp){
              
              fit.dat.cloud.aut$titer[which(fit.dat.cloud.aut$samp == ii)] = exp.fun(start.titer = peak.titer.samp[ii], rate = -decay.rate.samp[ii], time = plot.times)
              
       }
       
       
       if(is.finite(observed.data.for.fitting$titer.aut[which(observed.data.for.fitting$id==i)][1])){
              fit.dat.aut = exp.fun(start.titer = model.outputs[teller,"peak.titer.estimated.mean.aut"], rate = -model.outputs[teller,"decay.rate.estimated.mean.aut"], time = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)]))
              
              fit.dat.aut = data.frame(titer = fit.dat.aut, time = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)]))
              
              
              plot4 = ggplot() +
                     #geom_line(data = observed.data.for.fitting[which(observed.data.for.fitting$id==i),],aes(x = time.since.peak,y = titer),alpha = 0.8,size = 1.5,color="#F46D43") +
                     geom_line(data=fit.dat.cloud.aut, aes(x = time, y = titer, group = samp), col = brewer.pal(11,"Spectral")[1],alpha=0.2,size=0.4) +
                     geom_line(data=fit.dat.aut,aes(x = time, y = titer),col=brewer.pal(11,"Spectral")[1],size=1.5,alpha=1) +
                     geom_point(data = observed.data.for.fitting[which(observed.data.for.fitting$id==i),],aes(x = time.since.peak,y = titer.aut),size=3,alpha = 1,color="black") +
                     #scale_color_gradientn(colours  =  brewer.pal(11,"Spectral")) +
                     scale_y_continuous(limits = c(0,13),breaks=0:13) +
                     ggtitle(paste0("Individual ",model.outputs[i,"pittag"])) +
                     theme_light(base_family = "Avenir Next") +
                     theme(plot.title = element_text(size = 11),
                           text=element_text(size=11),
                           axis.text=element_text(size=10),
                           axis.title.y = element_text(margin = ggplot2::margin(r=10)),
                           plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
                     )+
                     xlab("Time since peak antibody level (days)") +
                     ylab("Antibody level (Autumnalis) (log2 dilution)")
              if(plot.figs==T) print(plot4)
       }
       
       # print(paste0("% seroconversion interval reduction: ",round(model.outputs$toi.information.gained.95cri.perc[teller],4)))
       # print(paste0("KL-divergence: ",round(model.outputs$kl.divergence[teller],4)))
       # print(paste0("Individual ",i," of ",N.inds))
       # print("----------------------------------------------")
       # print("----------------------------------------------")
       # print("----------------------------------------------")
       
       teller = teller + 1
}



```

<br> <br>


## Individual posteriors and chains

<br>

Posterior densities are shown after removing burn-in iterations.\
Solid red line = estimated posterior maximum density\
Weaker red line = estimated posterior mean\

<br> <br>



Figure for main text:     

```{r fig.height = 7, fig.width = 13}


# model.outputs$pittag[which(model.outputs$toi.information.gained.95cri.perc %in% head(sort(model.outputs$toi.information.gained.95cri.perc)))]
# model.outputs$pittag[which(model.outputs$toi.information.gained.95cri.perc %in% tail(sort(model.outputs$toi.information.gained.95cri.perc)))]

# observed.data.for.fitting[which(observed.data.for.fitting$Pittag=="B6069"),]

pittag.to.plot = c("12672","B6069")



# individual 1
i = observed.data.for.fitting$id[which(observed.data.for.fitting$Pittag==pittag.to.plot[1])][1]
chains.current.individual.df = chains.burn.df[,c(paste0("peak.titer.pomona.",i),paste0("peak.titer.aut.",i),paste0("decay.rate.pomona.",i),paste0("decay.rate.aut.",i),paste0("toi.",i),"iteration","chain")]
colnames(chains.current.individual.df) = c("peak.titer.pomona","peak.titer.aut","decay.rate.pomona","decay.rate.aut","toi","iteration","chain")

cur.peak.titer.pomona = round(mean(chains.current.individual.df[,"peak.titer.pomona"]),1)
dens = density(chains.current.individual.df[,"peak.titer.pomona"])
hpd.int.peak.pomona = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)    
cur.95.peak.pomona.low = round(hpd.int.peak.pomona[1])
cur.95.peak.pomona.high = round(hpd.int.peak.pomona[2])
hpd.int.peak.pomona = HDInterval::hdi(dens,credMass = 0.5,allowSplit=F)    
cur.50.peak.pomona.low = round(hpd.int.peak.pomona[1])
cur.50.peak.pomona.high = round(hpd.int.peak.pomona[2])


cur.decay.pomona = round(mean(chains.current.individual.df[,"decay.rate.pomona"]),6)
dens = density(chains.current.individual.df[,"decay.rate.pomona"])
hpd.int.decay.pomona = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)    
cur.95.decay.pomona.low = hpd.int.decay.pomona[1]
cur.95.decay.pomona.high = hpd.int.decay.pomona[2]
hpd.int.decay.pomona = HDInterval::hdi(dens,credMass = 0.50,allowSplit=F)    
cur.50.decay.pomona.low = hpd.int.decay.pomona[1]
cur.50.decay.pomona.high = hpd.int.decay.pomona[2]

cur.peak.titer.aut = round(mean(chains.current.individual.df[,"peak.titer.aut"]),1)
dens = density(chains.current.individual.df[,"peak.titer.aut"])
hpd.int.peak.aut = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)    
cur.95.peak.aut.low = round(hpd.int.peak.aut[1])
cur.95.peak.aut.high = round(hpd.int.peak.aut[2])
hpd.int.peak.aut = HDInterval::hdi(dens,credMass = 0.50,allowSplit=F)    
cur.50.peak.aut.low = round(hpd.int.peak.aut[1])
cur.50.peak.aut.high = round(hpd.int.peak.aut[2])


cur.decay.aut = round(mean(chains.current.individual.df[,"decay.rate.aut"]),6)
dens = density(chains.current.individual.df[,"decay.rate.aut"])
hpd.int.decay.aut = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)    
cur.95.decay.aut.low = hpd.int.decay.aut[1]
cur.95.decay.aut.high = hpd.int.decay.aut[2]
hpd.int.decay.aut = HDInterval::hdi(dens,credMass = 0.50,allowSplit=F)    
cur.50.decay.aut.low = hpd.int.decay.aut[1]
cur.50.decay.aut.high = hpd.int.decay.aut[2]

dens = density(chains.current.individual.df[,"toi"],bw = 5,from = neg.intervals[i],to=0)
cur.toi = round(dens$x[which.max(dens$y)])
hpd.int.toi = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)    
cur.95.low = round(hpd.int.toi[1])
cur.95.high = round(hpd.int.toi[2])
hpd.int.toi = HDInterval::hdi(dens,credMass = 0.50,allowSplit=F)    
cur.50.low = round(hpd.int.toi[1])
cur.50.high = round(hpd.int.toi[2])


plot1a = ggplot(data=chains.current.individual.df,aes(x=toi)) +
       geom_density(color=brewer.pal(4,"Spectral")[2],fill=brewer.pal(4,"Spectral")[2],alpha=0.6,size=1) +
       geom_vline(xintercept = cur.toi,col="black",size=0.8,alpha=0.6) +
       geom_vline(xintercept = cur.95.low,col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept = cur.95.high,col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept = cur.50.low,col="black",size=0.8,linetype=2,alpha=0.6) +
       geom_vline(xintercept = cur.50.high,col="black",size=0.8,linetype=2,alpha=0.6) +
       theme_light(base_family = "Avenir Next") +
       #ggtitle(paste0("Individual ",model.outputs[i,"pittag"])) +
       xlab("\u03B8 (days)") +
       ylab("Posterior density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 13),
             text=element_text(size=13),
             axis.text=element_text(size=13),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             #legend.position = c(0.78,0.85),
             legend.position = "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.background = element_rect(colour = "transparent", fill = "transparent"),
             legend.key = element_rect(fill = NA)
       )+
       labs(tag = "(A)")



plot1b = ggplot(data = data.frame(x = 0:15),aes(x=x)) +
       stat_function(fun = dnorm, args = list(mean = cur.peak.titer.pomona,sd = sd(chains.current.individual.df$peak.titer.pomona)),aes(col="Pomona"),size=1.5) +
       #geom_vline(xintercept = cur.peak.titer.pomona,col=brewer.pal(11,"Spectral")[10]) +
       stat_function(fun = dnorm, args = list(mean = cur.peak.titer.aut,sd = sd(chains.current.individual.df$peak.titer.aut)),aes(col="Autumnalis"),size=1.5) +
       #geom_vline(xintercept = cur.peak.titer.aut,col=brewer.pal(11,"Spectral")[1]) +
       scale_color_manual("Serovar",values = c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1])) +
       theme_light(base_family = "Avenir Next") +
       #ggtitle(paste0("Individual ",model.outputs[i,"pittag"])) +
       xlab("Peak antibody level (log2 dilution)") +
       ylab("Posterior density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 13),
             text=element_text(size=13),
             axis.text=element_text(size=13),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             legend.position = c(0.2,0.8),
             #legend.position = "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.background = element_rect(colour = "transparent", fill = "transparent"),
             legend.key = element_rect(fill = NA)
       )

plot1c = ggplot(data = data.frame(x = seq(-0.00015,0.002,0.0001)),aes(x=x)) +
       stat_function(fun = dnorm, args = list(mean = cur.decay.pomona,sd = sd(chains.current.individual.df$decay.rate.pomona)),aes(col="Pomona"),size=1.5) +
       #geom_vline(xintercept = cur.decay.pomona,col=brewer.pal(11,"Spectral")[10]) +
       stat_function(fun = dnorm, args = list(mean = cur.decay.aut,sd = sd(chains.current.individual.df$decay.rate.aut)),aes(col="Autumnalis"),size=1.5) +
       #geom_vline(xintercept = cur.peak.titer.aut,col=brewer.pal(11,"Spectral")[1]) +
       scale_color_manual("Serovar",values = c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1])) +
       theme_light(base_family = "Avenir Next") +
       #ggtitle(paste0("Individual ",model.outputs[i,"pittag"])) +
       xlab("Decay rate (1/day)") +
       ylab("Posterior density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 13),
             text=element_text(size=13),
             axis.text=element_text(size=13),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             legend.position = c(0.15,0.8),
             #legend.position = "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.background = element_rect(colour = "transparent", fill = "transparent"),
             legend.key = element_rect(fill = NA)
       )




# pomona
# sample N values from posterior distribution to get sense of error

N.samp = 200


set.seed(1234);peak.titer.samp.pomona = sample(chains.current.individual.df$peak.titer.pomona[which(chains.current.individual.df$peak.titer.pomona > cur.95.peak.pomona.low & chains.current.individual.df$peak.titer.pomona < cur.95.peak.pomona.high)], size = N.samp, replace = T)

set.seed(1234);decay.rate.samp.pomona = sample(chains.current.individual.df$decay.rate.pomona[which(chains.current.individual.df$decay.rate.pomona > cur.95.decay.pomona.low & chains.current.individual.df$decay.rate.pomona < cur.95.decay.pomona.high)], size = N.samp, replace = T)

set.seed(1234);peak.titer.samp.aut = sample(chains.current.individual.df$peak.titer.aut[which(chains.current.individual.df$peak.titer.aut > cur.95.peak.aut.low & chains.current.individual.df$peak.titer.aut < cur.95.peak.aut.high)], size = N.samp, replace = T)

set.seed(1234);decay.rate.samp.aut = sample(chains.current.individual.df$decay.rate.aut[which(chains.current.individual.df$decay.rate.aut > cur.95.decay.aut.low & chains.current.individual.df$decay.rate.aut < cur.95.decay.aut.high)], size = N.samp, replace = T)


plot.times = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)])

fit.dat.cloud.pomona = data.frame(time = rep(plot.times,N.samp), samp = rep(1:N.samp,each = length(plot.times)), titer = NA,Serovar = "Pomona")

fit.dat.cloud.aut = data.frame(time = rep(plot.times,N.samp), samp = rep(1:N.samp,each = length(plot.times)), titer = NA,Serovar = "Autumnalis")


for(ii in 1:N.samp){
       
       fit.dat.cloud.pomona$titer[which(fit.dat.cloud.pomona$samp == ii)] = exp.fun(start.titer = peak.titer.samp.pomona[ii], rate = -decay.rate.samp.pomona[ii], time = plot.times)
       
       fit.dat.cloud.aut$titer[which(fit.dat.cloud.aut$samp == ii)] = exp.fun(start.titer = peak.titer.samp.aut[ii], rate = -decay.rate.samp.aut[ii], time = plot.times)
       
}

fit.dat.cloud.both = rbind(fit.dat.cloud.pomona,fit.dat.cloud.aut)
fit.dat.cloud.both$samp = paste(fit.dat.cloud.both$Serovar,fit.dat.cloud.both$samp)
fit.dat.cloud.both$Serovar = factor(fit.dat.cloud.both$Serovar,levels = c("Autumnalis","Pomona"))

fit.dat.pomona = exp.fun(start.titer = cur.peak.titer.pomona, rate = -cur.decay.pomona, time = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)]))

fit.dat.aut = exp.fun(start.titer = cur.peak.titer.aut, rate = -cur.decay.aut, time = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)]))


fit.dat.pomona = data.frame(titer = fit.dat.pomona, time = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)]),Serovar = "Pomona")


fit.dat.aut = data.frame(titer = fit.dat.aut, time = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)]),Serovar = "Autumnalis")

fit.dat.both = rbind(fit.dat.pomona,fit.dat.aut)

cur.observed.data.for.fitting = gather(observed.data.for.fitting,Serovar,titer,c("titer.pomona","titer.aut"))

cur.observed.data.for.fitting$Serovar[which(cur.observed.data.for.fitting$Serovar=="titer.pomona")] = "Pomona"
cur.observed.data.for.fitting$Serovar[which(cur.observed.data.for.fitting$Serovar=="titer.aut")] = "Autumnalis"

# cur.observed.data.for.fitting$Serovar = factor(cur.observed.data.for.fitting$Serovar,levels = c("Pomona","Autumnalis"))

plot1d = ggplot() +
       #geom_line(data = observed.data.for.fitting[which(observed.data.for.fitting$id==i),],aes(x = time.since.peak,y = titer),alpha = 0.8,size = 1.5,color="#F46D43") +
       geom_line(data=fit.dat.cloud.both, aes(x = time, y = titer, group = samp, col = Serovar ),alpha=0.1,size=0.3) +
       geom_line(data=fit.dat.both,aes(x = time, y = titer,col=Serovar),size=1.75,alpha=1) +
       geom_point(data = cur.observed.data.for.fitting[which(cur.observed.data.for.fitting$id==i),],aes(x = time.since.peak,y = titer,shape=Serovar),size=3,alpha = 0.65,color="black") +
       scale_color_manual(name = "Serovar",labels = c("Pomona","Autumnalis"),values = c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1])) +
       scale_shape_manual(name = "Serovar",labels = c("Pomona","Autumnalis"),values = c("Pomona" = 16,"Autumnalis" = 17)) +
       scale_y_continuous(limits = c(0,13),breaks=0:13) +
       #ggtitle(paste0("Individual ",model.outputs[i,"pittag"])) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 13),
             text=element_text(size=13),
             axis.text=element_text(size=13),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             legend.position = c(0.75,0.82),
             #legend.position = "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.background = element_rect(colour = "transparent", fill = "transparent"),
             legend.key = element_rect(fill = NA)
       ) +
       xlab("Time since peak antibody level (days)") +
       ylab("Antibody level (log2 dilution)")





# individual 2
i = observed.data.for.fitting$id[which(observed.data.for.fitting$Pittag==pittag.to.plot[2])][1]
chains.current.individual.df = chains.burn.df[,c(paste0("peak.titer.pomona.",i),paste0("peak.titer.aut.",i),paste0("decay.rate.pomona.",i),paste0("decay.rate.aut.",i),paste0("toi.",i),"iteration","chain")]
colnames(chains.current.individual.df) = c("peak.titer.pomona","peak.titer.aut","decay.rate.pomona","decay.rate.aut","toi","iteration","chain")

cur.peak.titer.pomona = round(mean(chains.current.individual.df[,"peak.titer.pomona"]),1)
dens = density(chains.current.individual.df[,"peak.titer.pomona"])
hpd.int.peak.pomona = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)    
cur.95.peak.pomona.low = round(hpd.int.peak.pomona[1])
cur.95.peak.pomona.high = round(hpd.int.peak.pomona[2])
hpd.int.peak.pomona = HDInterval::hdi(dens,credMass = 0.5,allowSplit=F)    
cur.50.peak.pomona.low = round(hpd.int.peak.pomona[1])
cur.50.peak.pomona.high = round(hpd.int.peak.pomona[2])


cur.decay.pomona = round(mean(chains.current.individual.df[,"decay.rate.pomona"]),6)
dens = density(chains.current.individual.df[,"decay.rate.pomona"])
hpd.int.decay.pomona = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)    
cur.95.decay.pomona.low = hpd.int.decay.pomona[1]
cur.95.decay.pomona.high = hpd.int.decay.pomona[2]
hpd.int.decay.pomona = HDInterval::hdi(dens,credMass = 0.50,allowSplit=F)    
cur.50.decay.pomona.low = hpd.int.decay.pomona[1]
cur.50.decay.pomona.high = hpd.int.decay.pomona[2]

cur.peak.titer.aut = round(mean(chains.current.individual.df[,"peak.titer.aut"]),1)
dens = density(chains.current.individual.df[,"peak.titer.aut"])
hpd.int.peak.aut = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)    
cur.95.peak.aut.low = round(hpd.int.peak.aut[1])
cur.95.peak.aut.high = round(hpd.int.peak.aut[2])
hpd.int.peak.aut = HDInterval::hdi(dens,credMass = 0.50,allowSplit=F)    
cur.50.peak.aut.low = round(hpd.int.peak.aut[1])
cur.50.peak.aut.high = round(hpd.int.peak.aut[2])


cur.decay.aut = round(mean(chains.current.individual.df[,"decay.rate.aut"]),6)
dens = density(chains.current.individual.df[,"decay.rate.aut"])
hpd.int.decay.aut = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)    
cur.95.decay.aut.low = hpd.int.decay.aut[1]
cur.95.decay.aut.high = hpd.int.decay.aut[2]
hpd.int.decay.aut = HDInterval::hdi(dens,credMass = 0.50,allowSplit=F)    
cur.50.decay.aut.low = hpd.int.decay.aut[1]
cur.50.decay.aut.high = hpd.int.decay.aut[2]

dens = density(chains.current.individual.df[,"toi"],bw = 5,from = neg.intervals[i],to=0)
cur.toi = round(dens$x[which.max(dens$y)])
hpd.int.toi = HDInterval::hdi(dens,credMass = 0.95,allowSplit=F)    
cur.95.low = round(hpd.int.toi[1])
cur.95.high = round(hpd.int.toi[2])
hpd.int.toi = HDInterval::hdi(dens,credMass = 0.50,allowSplit=F)    
cur.50.low = round(hpd.int.toi[1])
cur.50.high = round(hpd.int.toi[2])


plot2a = ggplot(data=chains.current.individual.df,aes(x=toi)) +
       geom_density(color=brewer.pal(4,"Spectral")[2],fill=brewer.pal(4,"Spectral")[2],alpha=0.6,size=1) +
       geom_vline(xintercept = cur.toi,col="black",size=0.8,alpha=0.6) +
       geom_vline(xintercept = cur.95.low,col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept = cur.95.high,col="black",size=0.8,linetype="dotted",alpha=0.6) +
       geom_vline(xintercept = cur.50.low,col="black",size=0.8,linetype=2,alpha=0.6) +
       geom_vline(xintercept = cur.50.high,col="black",size=0.8,linetype=2,alpha=0.6) +
       theme_light(base_family = "Avenir Next") +
       #ggtitle(paste0("Individual ",model.outputs[i,"pittag"])) +
       xlab("\u03B8 (days)") +
       ylab("Posterior density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 13),
             text=element_text(size=13),
             axis.text=element_text(size=13),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             #legend.position = c(0.78,0.85),
             legend.position = "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.background = element_rect(colour = "transparent", fill = "transparent"),
             legend.key = element_rect(fill = NA)
       ) +
       labs(tag = "(B)")



plot2b = ggplot(data = data.frame(x = 0:15),aes(x=x)) +
       stat_function(fun = dnorm, args = list(mean = cur.peak.titer.pomona,sd = sd(chains.current.individual.df$peak.titer.pomona)),aes(col="Pomona"),size=1.5) +
       #geom_vline(xintercept = cur.peak.titer.pomona,col=brewer.pal(11,"Spectral")[10]) +
       stat_function(fun = dnorm, args = list(mean = cur.peak.titer.aut,sd = sd(chains.current.individual.df$peak.titer.aut)),aes(col="Autumnalis"),size=1.5) +
       #geom_vline(xintercept = cur.peak.titer.aut,col=brewer.pal(11,"Spectral")[1]) +
       scale_color_manual("Serovar",values = c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1])) +
       theme_light(base_family = "Avenir Next") +
       #ggtitle(paste0("Individual ",model.outputs[i,"pittag"])) +
       xlab("Peak antibody level (log2 dilution)") +
       ylab("Posterior density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 13),
             text=element_text(size=13),
             axis.text=element_text(size=13),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             legend.position = c(0.2,0.8),
             #legend.position = "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.background = element_rect(colour = "transparent", fill = "transparent"),
             legend.key = element_rect(fill = NA)
       )

plot2c = ggplot(data = data.frame(x = seq(-0.00015,0.002,0.0001)),aes(x=x)) +
       stat_function(fun = dnorm, args = list(mean = cur.decay.pomona,sd = sd(chains.current.individual.df$decay.rate.pomona)),aes(col="Pomona"),size=1.5) +
       #geom_vline(xintercept = cur.decay.pomona,col=brewer.pal(11,"Spectral")[10]) +
       stat_function(fun = dnorm, args = list(mean = cur.decay.aut,sd = sd(chains.current.individual.df$decay.rate.aut)),aes(col="Autumnalis"),size=1.5) +
       #geom_vline(xintercept = cur.peak.titer.aut,col=brewer.pal(11,"Spectral")[1]) +
       scale_color_manual("Serovar",values = c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1])) +
       theme_light(base_family = "Avenir Next") +
       #ggtitle(paste0("Individual ",model.outputs[i,"pittag"])) +
       xlab("Decay rate (1/day)") +
       ylab("Posterior density") +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 13),
             text=element_text(size=13),
             axis.text=element_text(size=13),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             legend.position = c(0.15,0.8),
             #legend.position = "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.background = element_rect(colour = "transparent", fill = "transparent"),
             legend.key = element_rect(fill = NA)
       )




# pomona
# sample N values from posterior distribution to get sense of error

N.samp = 200


set.seed(1234);peak.titer.samp.pomona = sample(chains.current.individual.df$peak.titer.pomona[which(chains.current.individual.df$peak.titer.pomona > cur.95.peak.pomona.low & chains.current.individual.df$peak.titer.pomona < cur.95.peak.pomona.high)], size = N.samp, replace = T)

set.seed(1234);decay.rate.samp.pomona = sample(chains.current.individual.df$decay.rate.pomona[which(chains.current.individual.df$decay.rate.pomona > cur.95.decay.pomona.low & chains.current.individual.df$decay.rate.pomona < cur.95.decay.pomona.high)], size = N.samp, replace = T)

set.seed(1234);peak.titer.samp.aut = sample(chains.current.individual.df$peak.titer.aut[which(chains.current.individual.df$peak.titer.aut > cur.95.peak.aut.low & chains.current.individual.df$peak.titer.aut < cur.95.peak.aut.high)], size = N.samp, replace = T)

set.seed(1234);decay.rate.samp.aut = sample(chains.current.individual.df$decay.rate.aut[which(chains.current.individual.df$decay.rate.aut > cur.95.decay.aut.low & chains.current.individual.df$decay.rate.aut < cur.95.decay.aut.high)], size = N.samp, replace = T)


plot.times = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)])

fit.dat.cloud.pomona = data.frame(time = rep(plot.times,N.samp), samp = rep(1:N.samp,each = length(plot.times)), titer = NA,Serovar = "Pomona")

fit.dat.cloud.aut = data.frame(time = rep(plot.times,N.samp), samp = rep(1:N.samp,each = length(plot.times)), titer = NA,Serovar = "Autumnalis")


for(ii in 1:N.samp){
       
       fit.dat.cloud.pomona$titer[which(fit.dat.cloud.pomona$samp == ii)] = exp.fun(start.titer = peak.titer.samp.pomona[ii], rate = -decay.rate.samp.pomona[ii], time = plot.times)
       
       fit.dat.cloud.aut$titer[which(fit.dat.cloud.aut$samp == ii)] = exp.fun(start.titer = peak.titer.samp.aut[ii], rate = -decay.rate.samp.aut[ii], time = plot.times)
       
}

fit.dat.cloud.both = rbind(fit.dat.cloud.pomona,fit.dat.cloud.aut)
fit.dat.cloud.both$samp = paste(fit.dat.cloud.both$Serovar,fit.dat.cloud.both$samp)
fit.dat.cloud.both$Serovar = factor(fit.dat.cloud.both$Serovar,levels = c("Autumnalis","Pomona"))

fit.dat.pomona = exp.fun(start.titer = cur.peak.titer.pomona, rate = -cur.decay.pomona, time = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)]))

fit.dat.aut = exp.fun(start.titer = cur.peak.titer.aut, rate = -cur.decay.aut, time = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)]))


fit.dat.pomona = data.frame(titer = fit.dat.pomona, time = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)]),Serovar = "Pomona")


fit.dat.aut = data.frame(titer = fit.dat.aut, time = 0:max(observed.data.for.fitting$time.since.peak[which(observed.data.for.fitting$id==i)]),Serovar = "Autumnalis")

fit.dat.both = rbind(fit.dat.pomona,fit.dat.aut)

cur.observed.data.for.fitting = gather(observed.data.for.fitting,Serovar,titer,c("titer.pomona","titer.aut"))

cur.observed.data.for.fitting$Serovar[which(cur.observed.data.for.fitting$Serovar=="titer.pomona")] = "Pomona"
cur.observed.data.for.fitting$Serovar[which(cur.observed.data.for.fitting$Serovar=="titer.aut")] = "Autumnalis"

# cur.observed.data.for.fitting$Serovar = factor(cur.observed.data.for.fitting$Serovar,levels = c("Pomona","Autumnalis"))

plot2d = ggplot() +
       #geom_line(data = observed.data.for.fitting[which(observed.data.for.fitting$id==i),],aes(x = time.since.peak,y = titer),alpha = 0.8,size = 1.5,color="#F46D43") +
       geom_line(data=fit.dat.cloud.both, aes(x = time, y = titer, group = samp, col = Serovar ),alpha=0.1,size=0.3) +
       geom_line(data=fit.dat.both,aes(x = time, y = titer,col=Serovar),size=1.75,alpha=1) +
       geom_point(data = cur.observed.data.for.fitting[which(cur.observed.data.for.fitting$id==i),],aes(x = time.since.peak,y = titer,shape=Serovar),size=3,alpha = 0.65,color="black") +
       scale_color_manual(name = "Serovar",labels = c("Pomona","Autumnalis"),values = c("Pomona" = brewer.pal(11,"Spectral")[10],"Autumnalis" = brewer.pal(11,"Spectral")[1])) +
       scale_shape_manual(name = "Serovar",labels = c("Pomona","Autumnalis"),values = c("Pomona" = 16,"Autumnalis" = 17)) +
       scale_y_continuous(limits = c(0,13),breaks=0:13) +
       #ggtitle(paste0("Individual ",model.outputs[i,"pittag"])) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 13),
             text=element_text(size=13),
             axis.text=element_text(size=13),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             legend.position = c(0.3,0.2),
             #legend.position = "none",
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.background = element_rect(colour = "transparent", fill = "transparent"),
             legend.key = element_rect(fill = NA)
       ) +
       xlab("Time since peak antibody level (days)") +
       ylab("Antibody level (log2 dilution)")



plot_fig4 = plot1a + plot1b + plot1d + 
       plot2a + plot2b + plot2d

plot_fig4



```




## Individual posteriors for seroconversion time       

Using full posterior density, 80% CrI and 50% CrI:   

```{r fig.height = 16, fig.width = 8}

#plot.order = rev(order(model.outputs$toi.estimated.maxdens))  # order by maxdens
plot.order = rev(order(neg.intervals))


theta.all.ordered = as.data.frame(theta.all[,plot.order]) %>%
       gather

theta.all.ordered$key = rep(1:N.inds, each = 6000)
colnames(theta.all.ordered) = c("id","toi")

theta.all.ordered$toi50 = theta.all.ordered$toi
theta.all.ordered$toi80 = theta.all.ordered$toi
theta.all.ordered$toi95 = theta.all.ordered$toi

for(i in 1:N.inds){
       toi.sorted = sort(theta.all.ordered$toi[which(theta.all.ordered$id==unique(theta.all.ordered$id)[i])])
       
       toi.50ci.low = toi.sorted[floor(0.25 * length(toi.sorted))]
       toi.50ci.hi = toi.sorted[floor(0.75 * length(toi.sorted))]
       theta.all.ordered$toi50[which(theta.all.ordered$id==unique(theta.all.ordered$id)[i] & (theta.all.ordered$toi < toi.50ci.low | theta.all.ordered$toi > toi.50ci.hi))] = NA
       
       toi.80ci.low = toi.sorted[floor(0.1 * length(toi.sorted))]
       toi.80ci.hi = toi.sorted[floor(0.9 * length(toi.sorted))]
       theta.all.ordered$toi80[which(theta.all.ordered$id==unique(theta.all.ordered$id)[i] & (theta.all.ordered$toi < toi.80ci.low | theta.all.ordered$toi > toi.80ci.hi))] = NA
       
       toi.95ci.low = toi.sorted[floor(0.025 * length(toi.sorted))]
       toi.95ci.hi = toi.sorted[floor(0.975 * length(toi.sorted))]
       theta.all.ordered$toi95[which(theta.all.ordered$id==unique(theta.all.ordered$id)[i] & (theta.all.ordered$toi < toi.95ci.low | theta.all.ordered$toi > toi.95ci.hi))] = NA
}

# divide into 4 parts for plotting
theta.all.ordered.part1 = theta.all.ordered[which(theta.all.ordered$id %in% 1:floor(N.inds/4)),]
theta.all.ordered.part2 = theta.all.ordered[which(theta.all.ordered$id %in% (floor(N.inds/4)+1):(floor(N.inds/4)*2)),]
theta.all.ordered.part3 = theta.all.ordered[which(theta.all.ordered$id %in% ((floor(N.inds/4)*2)+1):(floor(N.inds/4)*3)),]
theta.all.ordered.part4 = theta.all.ordered[which(theta.all.ordered$id %in% ((floor(N.inds/4)*3)+1):N.inds),]


individual.theta.plots.1 = ggplot() +
       geom_density_ridges(data = theta.all.ordered.part1,aes(x = toi,y = factor(id),height=..density..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[10],alpha=0.8) +
       geom_density_ridges(data = theta.all.ordered.part1,aes(x = toi80,y = factor(id),height=..density..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[2],alpha=0.8) +
       geom_density_ridges(data = theta.all.ordered.part1,aes(x = toi50,y = factor(id),height=..density..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[5],alpha=0.8) +
       coord_flip() +
       ylab("ID") +
       xlab("\u03B8 (days)") +
       #ggtitle("1/4") +
       theme_light(base_family = "Avenir Next") +        
       theme(plot.title  =  element_text(size  = 11),              
             text = element_text(size = 11),              
             axis.text.y = element_text(size = 11),
             axis.text.x = element_blank(),        
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)))

individual.theta.plots.2 = ggplot() +
       geom_density_ridges(data = theta.all.ordered.part2,aes(x = toi,y = factor(id),height=..density..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[10],alpha=0.8) +
       geom_density_ridges(data = theta.all.ordered.part2,aes(x = toi80,y = factor(id),height=..density..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[2],alpha=0.8) +
       geom_density_ridges(data = theta.all.ordered.part2,aes(x = toi50,y = factor(id),height=..density..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[5],alpha=0.8) +
       coord_flip() +
       ylab("ID") +
       xlab("\u03B8 (days)") +
       #ggtitle("Peak titer time (2/4)") +
       theme_light(base_family = "Avenir Next") +        
       theme(plot.title  =  element_text(size  = 11),              
             text = element_text(size = 11),              
             axis.text.y = element_text(size = 11),
             axis.text.x = element_blank(),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10))              )

individual.theta.plots.3 = ggplot() +
       geom_density_ridges(data = theta.all.ordered.part3,aes(x = toi,y = factor(id),height=..density..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[10],alpha=0.8) +
       geom_density_ridges(data = theta.all.ordered.part3,aes(x = toi80,y = factor(id),height=..density..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[2],alpha=0.8) +
       geom_density_ridges(data = theta.all.ordered.part3,aes(x = toi50,y = factor(id),height=..density..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[5],alpha=0.8) +
       coord_flip() +
       ylab("ID") +
       xlab("\u03B8 (days)") +
       #ggtitle("Peak titer time (3/4)") +
       theme_light(base_family = "Avenir Next") +        
       theme(plot.title  =  element_text(size  = 11),              
             text = element_text(size = 11),              
             axis.text.y = element_text(size = 11),
             axis.text.x = element_blank(),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10))              )

individual.theta.plots.4 = ggplot() +
       geom_density_ridges(data = theta.all.ordered.part4,aes(x = toi,y = factor(id),height=..density..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[10],alpha=0.8) +
       geom_density_ridges(data = theta.all.ordered.part4,aes(x = toi80,y = factor(id),height=..density..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[2],alpha=0.8) +
       geom_density_ridges(data = theta.all.ordered.part4,aes(x = toi50,y = factor(id),height=..density..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[5],alpha=0.8) +
       coord_flip() +
       ylab("ID") +
       xlab("\u03B8 (days)") +
       #ggtitle("Peak titer time (4/4)") +
       theme_light(base_family = "Avenir Next") +        
       theme(plot.title  =  element_text(size  = 11),              
             text = element_text(size = 11),              
             axis.text.y = element_text(size = 11),
             axis.text.x = element_blank(),          
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10))              )

individual.theta.plots.all = individual.theta.plots.1 / 
       individual.theta.plots.2 / 
       individual.theta.plots.3 /
       individual.theta.plots.4

individual.theta.plots.all


```



Using full posterior density, 95% CrI and 50% CrI:   

```{r fig.height = 16, fig.width = 8}


individual.theta.plots.1 = ggplot() +
       geom_density_ridges(data = theta.all.ordered.part1,aes(x = toi,y = factor(id),height=..scaled..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[10],alpha=0.8, scale = 0.8) +
       geom_density_ridges(data = theta.all.ordered.part1,aes(x = toi95,y = factor(id),height=..scaled..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[2],alpha=0.8, scale = 0.8) +
       geom_density_ridges(data = theta.all.ordered.part1,aes(x = toi50,y = factor(id),height=..scaled..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[5],alpha=0.8, scale = 0.8) +
       coord_flip() +
       ylab("ID") +
       xlab("\u03B8 (days)") +
       #ggtitle("1/4") +
       theme_light(base_family = "Avenir Next") +        
       theme(plot.title  =  element_text(size  = 11),              
             text = element_text(size = 11),              
             axis.text.y = element_text(size = 11),
             axis.text.x = element_blank(),        
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10)))

individual.theta.plots.2 = ggplot() +
       geom_density_ridges(data = theta.all.ordered.part2,aes(x = toi,y = factor(id),height=..scaled..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[10],alpha=0.8, scale = 0.8) +
       geom_density_ridges(data = theta.all.ordered.part2,aes(x = toi95,y = factor(id),height=..scaled..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[2],alpha=0.8, scale = 0.8) +
       geom_density_ridges(data = theta.all.ordered.part2,aes(x = toi50,y = factor(id),height=..scaled..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[5],alpha=0.8, scale = 0.8) +
       coord_flip() +
       ylab("ID") +
       xlab("\u03B8 (days)") +
       #ggtitle("Peak titer time (2/4)") +
       theme_light(base_family = "Avenir Next") +        
       theme(plot.title  =  element_text(size  = 11),              
             text = element_text(size = 11),              
             axis.text.y = element_text(size = 11),
             axis.text.x = element_blank(),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10))              )

individual.theta.plots.3 = ggplot() +
       geom_density_ridges(data = theta.all.ordered.part3,aes(x = toi,y = factor(id),height=..scaled..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[10],alpha=0.8, scale = 0.8) +
       geom_density_ridges(data = theta.all.ordered.part3,aes(x = toi95,y = factor(id),height=..scaled..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[2],alpha=0.8, scale = 0.8) +
       geom_density_ridges(data = theta.all.ordered.part3,aes(x = toi50,y = factor(id),height=..scaled..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[5],alpha=0.8, scale = 0.8) +
       coord_flip() +
       ylab("ID") +
       xlab("\u03B8 (days)") +
       #ggtitle("Peak titer time (3/4)") +
       theme_light(base_family = "Avenir Next") +        
       theme(plot.title  =  element_text(size  = 11),              
             text = element_text(size = 11),              
             axis.text.y = element_text(size = 11),
             axis.text.x = element_blank(),
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10))              )

individual.theta.plots.4 = ggplot() +
       geom_density_ridges(data = theta.all.ordered.part4,aes(x = toi,y = factor(id),height=..scaled..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[10],alpha=0.8, scale = 0.8) +
       geom_density_ridges(data = theta.all.ordered.part4,aes(x = toi95,y = factor(id),height=..scaled..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[2],alpha=0.8, scale = 0.8) +
       geom_density_ridges(data = theta.all.ordered.part4,aes(x = toi50,y = factor(id),height=..scaled..), stat = "density",size=0.1,trim=T,fill = brewer.pal(11,"Spectral")[5],alpha=0.8, scale = 0.8) +
       coord_flip() +
       ylab("ID") +
       xlab("\u03B8 (days)") +
       #ggtitle("Peak titer time (4/4)") +
       theme_light(base_family = "Avenir Next") +        
       theme(plot.title  =  element_text(size  = 11),              
             text = element_text(size = 11),              
             axis.text.y = element_text(size = 11),
             axis.text.x = element_blank(),          
             axis.title.y  =  element_text(margin  =  ggplot2::margin(r = 10))              )

individual.theta.plots.all = individual.theta.plots.1 / 
       individual.theta.plots.2 / 
       individual.theta.plots.3 /
       individual.theta.plots.4

individual.theta.plots.all

# ggsave(plot = individual.theta.plots.all,filename = "/Users/bennyborremans/Documents/Werk/Manuscripten/Eerste auteur/ongoing/Fox titer kinetics/Figures/Figure_posterior_toi_all_individuals_incl95_50cri.png",width = 9, height = 12, dpi=600)

```



<br>

------------------------------------------------------------------------

<br>

## Mean information gained

### Using only individuals for which there is at least one Autumnalis
result     

```{r}

# exclude individuals without any Aut samples     

model.outputs.aut.not.all.na = model.outputs[id.aut.not.all.na,]

```


Mean amount of information gained (% reduction of seroconversion
interval):\

95% CrI:   

`r  mean(model.outputs.aut.not.all.na$toi.information.gained.95cri.perc)`\
(standard error =
`r sd(model.outputs.aut.not.all.na$toi.information.gained.95cri.perc)/(sqrt(nrow(model.outputs.aut.not.all.na)))`)\
Range:
`r range(model.outputs.aut.not.all.na$toi.information.gained.95cri.perc)`

Median:   
`r  median(model.outputs.aut.not.all.na$toi.information.gained.95cri.perc)`\

\vspace{20pt}
80% CrI:
`r  mean(model.outputs.aut.not.all.na$toi.information.gained.80cri.perc)`\
(standard error =
`r sd(model.outputs.aut.not.all.na$toi.information.gained.80cri.perc)/(sqrt(nrow(model.outputs.aut.not.all.na)))`)\
Range:
`r range(model.outputs.aut.not.all.na$toi.information.gained.80cri.perc)`
Median:    
`r  median(model.outputs.aut.not.all.na$toi.information.gained.80cri.perc)`\

\vspace{20pt}
50% CrI:
`r  mean(model.outputs.aut.not.all.na$toi.information.gained.50cri.perc)`\
(standard error =
`r sd(model.outputs.aut.not.all.na$toi.information.gained.50cri.perc)/(sqrt(nrow(model.outputs.aut.not.all.na)))`)\
Range:
`r range(model.outputs.aut.not.all.na$toi.information.gained.50cri.perc)`
Median:    
`r  median(model.outputs.aut.not.all.na$toi.information.gained.50cri.perc)`\
## KL-divergence

### Using only individuals for which there is at least one Autumnalis
result     

Mean amount of information gained (KL-divergence):\
`r  mean(model.outputs.aut.not.all.na$kl.divergence)`\
(standard error =
`r sd(model.outputs.aut.not.all.na$kl.divergence)/(sqrt(nrow(model.outputs.aut.not.all.na)))`)\
Range: `r range(model.outputs.aut.not.all.na$kl.divergence)`

Median: `r  mean(model.outputs.aut.not.all.na$kl.divergence)`\


Histogram:   

```{r fig.height=4,fig.width=6}
plot.seroconv.red = ggplot(data = model.outputs.aut.not.all.na, aes(x = toi.information.gained.95cri.perc)) +
       geom_histogram(bins=12,binwidth = 0.01,fill="#9E0142",col="black",aes(y = ..density..)) +
       theme_classic(base_family = "Avenir Next") +
       scale_x_continuous(limits = c(0,0.6)) +
       scale_color_manual("Distribution",values = c("N(6,2.2)" = "#66C2A5","N(7,3)" = "#FDAE61")) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Seroconversion interval reduction (%)") +
       ylab("Density")

plot.seroconv.red

# ggsave(plot = plot.seroconv.red,filename = "/Users/bennyborremans/Documents/Werk/Manuscripten/Eerste auteur/ongoing/Fox titer kinetics/Figures/SI_figure_seroconversion_interval_reduction_at_least_one_aut_pos_histogram.png",width = 4, height = 4, dpi=600)

```


## Mean information gained

### Using all individuals    


Mean amount of information gained (% reduction of seroconversion
interval):\

95% CrI:
`r  mean(model.outputs$toi.information.gained.95cri.perc)`\
(standard error =
`r sd(model.outputs$toi.information.gained.95cri.perc)/(sqrt(nrow(model.outputs)))`)\
Range:
`r range(model.outputs$toi.information.gained.95cri.perc)`
Median:    
`r  median(model.outputs$toi.information.gained.95cri.perc)`\

\vspace{20pt}
80% CrI:
`r  mean(model.outputs$toi.information.gained.80cri.perc)`\
(standard error =
`r sd(model.outputs$toi.information.gained.80cri.perc)/(sqrt(nrow(model.outputs)))`)\
Range:
`r range(model.outputs$toi.information.gained.80cri.perc)`
Median:    
`r  median(model.outputs$toi.information.gained.80cri.perc)`\

\vspace{20pt}
50% CrI:
`r  mean(model.outputs$toi.information.gained.50cri.perc)`\
(standard error =
`r sd(model.outputs$toi.information.gained.50cri.perc)/(sqrt(nrow(model.outputs)))`)\
Range:
`r range(model.outputs$toi.information.gained.50cri.perc)`
Median:    
`r  median(model.outputs$toi.information.gained.50cri.perc)`\


## KL-divergence

### Using all individuals 

Mean amount of information gained (KL-divergence):\
`r  mean(model.outputs$kl.divergence)`\
(standard error =
`r sd(model.outputs$kl.divergence)/(sqrt(nrow(model.outputs)))`)\
Range: `r range(model.outputs$kl.divergence)`

Median:    
`r  mean(model.outputs$kl.divergence)`\


Histogram:   

\vspace{20pt}
95% CrI:    

```{r fig.height=4,fig.width=6}
plot.seroconv.red = ggplot(data = model.outputs, aes(x = toi.information.gained.95cri.perc)) +
       geom_histogram(bins=12,binwidth = 0.01,fill="#9E0142",col="black",aes(y = ..density..)) +
       theme_classic(base_family = "Avenir Next") +
       scale_x_continuous(breaks = seq(0,1,0.1)) +
       scale_color_manual("Distribution",values = c("N(6,2.2)" = "#66C2A5","N(7,3)" = "#FDAE61")) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Seroconversion interval reduction (%)") +
       ylab("Density")

plot.seroconv.red

# ggsave(plot = plot.seroconv.red,filename = "/Users/bennyborremans/Documents/Werk/Manuscripten/Eerste auteur/ongoing/Fox titer kinetics/Figures/SI_figure_seroconversion_interval_reduction_95cri_all_samples_histogram.png",width = 4, height = 4, dpi=600)

```


\vspace{20pt}
80% CrI:    

```{r fig.height=4,fig.width=6}
plot.seroconv.red = ggplot(data = model.outputs, aes(x = toi.information.gained.80cri.perc)) +
       geom_histogram(bins=12,binwidth = 0.01,fill="#9E0142",col="black",aes(y = ..density..)) +
       theme_classic(base_family = "Avenir Next") +
       scale_x_continuous(breaks = seq(0,1,0.1)) +
       scale_color_manual("Distribution",values = c("N(6,2.2)" = "#66C2A5","N(7,3)" = "#FDAE61")) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Seroconversion interval reduction (%)") +
       ylab("Density")

plot.seroconv.red

# ggsave(plot = plot.seroconv.red,filename = "/Users/bennyborremans/Documents/Werk/Manuscripten/Eerste auteur/ongoing/Fox titer kinetics/Figures/SI_figure_seroconversion_interval_reduction_80cri_all_samples_histogram.png",width = 4, height = 4, dpi=600)

```

\vspace{20pt}
50% CrI:    

```{r fig.height=4,fig.width=6}
plot.seroconv.red = ggplot(data = model.outputs, aes(x = toi.information.gained.50cri.perc)) +
       geom_histogram(bins=12,binwidth = 0.01,fill="#9E0142",col="black",aes(y = ..density..)) +
       theme_classic(base_family = "Avenir Next") +
       scale_x_continuous(breaks = seq(0,1,0.1)) +
       scale_color_manual("Distribution",values = c("N(6,2.2)" = "#66C2A5","N(7,3)" = "#FDAE61")) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Seroconversion interval reduction (%)") +
       ylab("Density")

plot.seroconv.red

# ggsave(plot = plot.seroconv.red,filename = "/Users/bennyborremans/Documents/Werk/Manuscripten/Eerste auteur/ongoing/Fox titer kinetics/Figures/SI_figure_seroconversion_interval_reduction_50cri_all_samples_histogram.png",width = 4, height = 4, dpi=600)

```


\vspace{50pt}   


## Correlation between interval size reduction and KL-divergence    


\vspace{20pt}
95% CrI:   

```{r fig.height = 4, fig.width = 4}
ggplot(model.outputs,aes(x = toi.information.gained.95cri.perc, y = kl.divergence)) +
       geom_point(color = brewer.pal(11,"Spectral")[2],size = 0.5) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Seroconversion interval reduction (%)") +
       ylab("Relative entropy (bits)")
```


\vspace{20pt}
80% CrI:   

```{r fig.height = 4, fig.width = 4}
ggplot(model.outputs,aes(x = toi.information.gained.80cri.perc, y = kl.divergence)) +
       geom_point(color = brewer.pal(11,"Spectral")[2],size = 0.5) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Seroconversion interval reduction (%)") +
       ylab("Relative entropy (bits)")
```

\vspace{20pt}
50% CrI:   

```{r fig.height = 4, fig.width = 4}
ggplot(model.outputs,aes(x = toi.information.gained.50cri.perc, y = kl.divergence)) +
       geom_point(color = brewer.pal(11,"Spectral")[2],size = 0.5) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Seroconversion interval reduction (%)") +
       ylab("Relative entropy (bits)")
```


\vspace{50pt}   

## Correlates of model performance     

Why does the model result in better estimates of seroconversion time for some individuals than for others?    



### Seroconversion interval size    

All for 95% CrI    


```{r fig.height = 4, fig.width = 4, results = 'hide', message=FALSE, warning=FALSE}

model.outputs$interval.size = abs(neg.intervals)

ggplot(model.outputs,aes(x = interval.size, y = 100*toi.information.gained.95cri.perc)) +
       geom_point(color = brewer.pal(11,"Spectral")[2],size = 0.7) +
       scale_y_continuous(limits=c(0,65)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       )+
       xlab("Seroconversion interval size (days)") +
       ylab("Interval reduction (%)")

# lm.interval.size = lm(log(toi.information.gained.95cri.perc) ~ scale(interval.size),data = model.outputs)

lm.interval.size = brm(log(toi.information.gained.95cri.perc) ~ scale(interval.size),data = model.outputs)


```


### Range of time covered by datapoints   

```{r fig.height = 4, fig.width = 4, results = 'hide', message=FALSE, warning=FALSE}

model.outputs$datarange = NA

for(i in 1:nrow(model.outputs)){
       model.outputs$datarange[i] = max(observed.data.for.fitting$time[which(observed.data.for.fitting$id == i)])
}

ggplot(model.outputs,aes(x = datarange, y = 100*toi.information.gained.95cri.perc)) +
       geom_point(color = brewer.pal(11,"Spectral")[2],size = 0.5) +
       scale_y_continuous(limits=c(0,65)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Range of datapoints (days)") +
       ylab("Interval reduction (%)")

# lm.datarange = lm(log(toi.information.gained.95cri.perc) ~ scale(datarange),data = model.outputs)
lm.datarange = brm(log(toi.information.gained.95cri.perc) ~ scale(datarange),data = model.outputs)



```



### Number of datapoints     

```{r fig.height = 4, fig.width = 4, results = 'hide', message=FALSE, warning=FALSE}


model.outputs$number.of.datapoints = NA

for(i in 1:nrow(model.outputs)){
       model.outputs$number.of.datapoints[i] = sum(observed.data.for.fitting$id == i)
}

ggplot(model.outputs,aes(x = number.of.datapoints, y = 100*toi.information.gained.95cri.perc)) +
       geom_point(color = brewer.pal(11,"Spectral")[2],size = 0.5) +
       scale_y_continuous(limits = c(0,65)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Number of datapoints") +
       ylab("Interval reduction (%)")

#lm.number.of.datapoints = lm(log(toi.information.gained.95cri.perc) ~ scale(number.of.datapoints),data = model.outputs)
lm.number.of.datapoints = brm(log(toi.information.gained.95cri.perc) ~ scale(number.of.datapoints),data = model.outputs)




```






### Estimated peak level    

```{r fig.height = 4, fig.width = 4, results = 'hide', message=FALSE, warning=FALSE}

ggplot(model.outputs,aes(x = peak.titer.estimated.mean.pomona, y = 100*toi.information.gained.95cri.perc)) +
       geom_point(color = brewer.pal(11,"Spectral")[2],size = 0.5) +
       scale_y_continuous(limits = c(0,65)) +
       scale_x_continuous(breaks = seq(0,15,2)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Estimated peak antibody level \n(log2 dilution)") +
       ylab("Interval reduction (%)")

#lm.estimated.peak.level = lm(log(toi.information.gained.95cri.perc) ~ scale(peak.titer.estimated.mean.pomona),data = model.outputs)
lm.estimated.peak.level = brm(log(toi.information.gained.95cri.perc) ~ scale(peak.titer.estimated.mean.pomona),data = model.outputs)


```



### Antibody level of the first positive sample     

```{r fig.height = 4, fig.width = 4, results = 'hide', message=FALSE, warning=FALSE}

model.outputs$first.pos.level = observed.data.for.fitting$titer.pomona[which(observed.data.for.fitting$time==0)]

# unique(observed.data.for.fitting$Pittag) %in% model.outputs$pittag

ggplot(model.outputs,aes(x = first.pos.level, y = 100*toi.information.gained.95cri.perc)) +
       geom_jitter(color = brewer.pal(11,"Spectral")[2],size = 0.7,width=0.1) +
       scale_x_continuous(breaks=seq(0,15,2)) +
       scale_y_continuous(limits=c(0,65)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       )+
       xlab("Pomona level first positive sample \n(log2 dilutions)") +
       ylab("Interval reduction (%)")


#lm.first.pos.level = lm(log(toi.information.gained.95cri.perc) ~ scale(first.pos.level),data = model.outputs)
lm.first.pos.level = brm(log(toi.information.gained.95cri.perc) ~ scale(first.pos.level),data = model.outputs)


```




### Estimated decay rate    

```{r fig.height = 4, fig.width = 4, results = 'hide', message=FALSE, warning=FALSE}

ggplot(model.outputs,aes(x = decay.rate.estimated.mean.pomona, y = 100*toi.information.gained.95cri.perc)) +
       geom_point(color = brewer.pal(11,"Spectral")[2],size = 0.5) +
       scale_y_continuous(limits = c(0,65)) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Estimated decay rate") +
       ylab("Interval reduction (%)")


#lm.decay.rate = lm(log(toi.information.gained.95cri.perc) ~ scale(decay.rate.estimated.mean.pomona),data = model.outputs)
lm.decay.rate = brm(log(toi.information.gained.95cri.perc) ~ scale(decay.rate.estimated.mean.pomona),data = model.outputs)




```


### Estimated decay rate and estimate peak antibody level     


```{r fig.height = 4, fig.width = 4, results = 'hide', message=FALSE, warning=FALSE}

ggplot(model.outputs,aes(x = decay.rate.estimated.mean.pomona, y = peak.titer.estimated.mean.pomona,color = 100*toi.information.gained.95cri.perc)) +
       geom_point(size = 1) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       scale_color_gradientn(name = "Interval \nreduction \n(%)",colors =  rev(brewer.pal(11,"Spectral")[c(1,2,3,5,8,10,11)])) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Estimated decay rate") +
       ylab("Estimated peak level")


#lm.decay.rate.and.estimated.peak.level = lm(log(toi.information.gained.95cri.perc) ~ scale(decay.rate.estimated.mean.pomona) + scale(peak.titer.estimated.mean.pomona),data = model.outputs)
lm.decay.rate.and.estimated.peak.level = brm(log(toi.information.gained.95cri.perc) ~ scale(decay.rate.estimated.mean.pomona) + scale(peak.titer.estimated.mean.pomona),data = model.outputs)





```



### Estimated decay rate and first positive level     


```{r fig.height = 4, fig.width = 4, results = 'hide', message=FALSE, warning=FALSE}

ggplot(model.outputs,aes(x = decay.rate.estimated.mean.pomona, y = first.pos.level,color = 100*toi.information.gained.95cri.perc)) +
       geom_point(size = 1) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       scale_color_gradientn(name = "Interval \nreduction \n(%)",colors =  rev(brewer.pal(11,"Spectral")[c(1,2,3,5,8,10,11)])) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Estimated decay rate") +
       ylab("First positive sample level")

#lm.decay.rate.and.first.positive.level = lm(log(toi.information.gained.95cri.perc) ~ scale(decay.rate.estimated.mean.pomona) + scale(first.pos.level),data = model.outputs)
lm.decay.rate.and.first.positive.level = brm(log(toi.information.gained.95cri.perc) ~ scale(decay.rate.estimated.mean.pomona) + scale(first.pos.level),data = model.outputs)




```


### Interval size and decay rate     


```{r fig.height = 4, fig.width = 4, results = 'hide', message=FALSE, warning=FALSE}

ggplot(model.outputs,aes(x = decay.rate.estimated.mean.pomona, y = interval.size,color = 100*toi.information.gained.95cri.perc)) +
       geom_point(size = 1) +
       #scale_y_continuous(breaks = seq(0,15,2)) +
       scale_color_gradientn(name = "Interval \nreduction \n(%)",colors =  rev(brewer.pal(11,"Spectral")[c(1,2,3,5,8,10,11)])) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Estimated decay rate (1/day)") +
       ylab("Seroconversion interval size (days)")


lm.decay.rate.and.interval.size = brm(log(toi.information.gained.95cri.perc) ~ scale(decay.rate.estimated.mean.pomona) + scale(interval.size),data = model.outputs)




```


### Interval size and peak level     


```{r fig.height = 4, fig.width = 4, results = 'hide', message=FALSE, warning=FALSE}

ggplot(model.outputs,aes(x = interval.size, y = peak.titer.estimated.mean.pomona,color = 100*toi.information.gained.95cri.perc)) +
       geom_point(size = 1) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       scale_color_gradientn(name = "Interval \nreduction \n(%)",colors =  rev(brewer.pal(11,"Spectral")[c(1,2,3,5,8,10,11)])) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Seroconversion interval size (days)") +
       ylab("Estimated peak level (log2 dilution)")

lm.peaklevel.and.interval.size = brm(log(toi.information.gained.95cri.perc) ~ scale(peak.titer.estimated.mean.pomona) + scale(interval.size),data = model.outputs)



```


### Estimated decay, estimated peak, interval size    


```{r fig.height = 4, fig.width = 12}

plot.interval.decay = ggplot(model.outputs,aes(x = interval.size, y = decay.rate.estimated.mean.pomona,color = 100*toi.information.gained.95cri.perc)) +
       geom_point(size = 1) +
       #scale_y_continuous(breaks = seq(0,15,2)) +
       scale_color_gradientn(name = "Interval \nreduction \n(%)",colors =  rev(brewer.pal(11,"Spectral")[c(1,2,3,5,8,10,11)])) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = 'none'
       ) +
       ylab("Estimated decay rate (1/day)") +
       xlab("Infection window (days)")

plot.interval.peak = ggplot(model.outputs,aes(x = interval.size, y = peak.titer.estimated.mean.pomona,color = 100*toi.information.gained.95cri.perc)) +
       geom_point(size = 1) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       scale_color_gradientn(name = "Interval \nreduction \n(%)",colors =  rev(brewer.pal(11,"Spectral")[c(1,2,3,5,8,10,11)])) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = 'none'
       ) +
       xlab("Infection window (days)") +
       ylab("Estimated peak level \n(log2 dilution)")

plot.interval.firstpos = ggplot(model.outputs,aes(x = interval.size, y = first.pos.level,color = 100*toi.information.gained.95cri.perc)) +
       geom_point(size = 1) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       scale_color_gradientn(name = "Interval \nreduction \n(%)",colors =  rev(brewer.pal(11,"Spectral")[c(1,2,3,5,8,10,11)])) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm"),
             legend.position = 'none'
       ) +
       xlab("Infection window (days)") +
       ylab("First positive Pomona sample \nlevel (log2 dilution)")



plot.firstpos.decay = ggplot(model.outputs,aes(x = decay.rate.estimated.mean.pomona, y = first.pos.level,color = 100*toi.information.gained.95cri.perc)) +
       geom_point(size = 1) +
       scale_y_continuous(breaks = seq(0,15,2)) +
       scale_color_gradientn(name = "Interval \nreduction \n(%)",colors =  rev(brewer.pal(11,"Spectral")[c(1,2,3,5,8,10,11)])) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Estimated decay rate (1/day)") +
       ylab("First positive Pomona sample \nlevel (log2 dilution)")


plot.covariates.reduction = plot.interval.decay + plot.interval.firstpos + plot.firstpos.decay

plot.covariates.reduction


```


### Number of data points and first positive level     


```{r fig.height = 4, fig.width = 4, results = 'hide', message=FALSE, warning=FALSE}

ggplot(model.outputs,aes(x = number.of.datapoints, y = first.pos.level,color = 100*toi.information.gained.95cri.perc)) +
       geom_jitter(size = 1,width=0.1) +
       scale_x_continuous(breaks = 0:10) +
       scale_y_continuous(breaks = 0:15) +
       scale_color_gradientn(name = "Interval \nreduction \n(%)",colors =  rev(brewer.pal(11,"Spectral")[c(1,2,3,5,8,10,11)])) +
       theme_light(base_family = "Avenir Next") +
       theme(plot.title = element_text(size = 11),
             text=element_text(size=11),
             axis.text=element_text(size=10),
             axis.title.y = element_text(margin = ggplot2::margin(r=10)),
             plot.margin = unit(c(0.5,0.75,0.5,0.5),"cm")
       ) +
       xlab("Number of positive datapoints") +
       ylab("First positive sample level \n(log2 dilution)")


#lm.number.of.datapoints.and.first.positive.level = lm(log(toi.information.gained.95cri.perc) ~ scale(number.of.datapoints) + scale(first.pos.level),data = model.outputs)
lm.number.of.datapoints.and.first.positive.level = brm(log(toi.information.gained.95cri.perc) ~ scale(number.of.datapoints) + scale(first.pos.level),data = model.outputs)



```


# All covariates    

```{r results = 'hide', message=FALSE, warning=FALSE}
lm.all = brm(log(toi.information.gained.95cri.perc) ~ scale(first.pos.level) + scale(decay.rate.estimated.mean.pomona) + scale(peak.titer.estimated.mean.pomona) + scale(interval.size) + scale(datarange) + scale(number.of.datapoints), data = model.outputs)
```


### Model comparison

#### Univariate models P values    

```{r results = 'hide', message=FALSE, warning=FALSE}
# frequentist:    

# lm.interval.size
# lm.datarange
# lm.number.of.datapoints
# lm.estimated.peak.level
# lm.first.pos.level
# lm.decay.rate
# lm.decay.rate.and.estimated.peak.level
# lm.decay.rate.and.first.positive.level
# lm.number.of.datapoints.and.first.positive.level


# model.stats = data.frame(
#        variables = c("interval size","datarange","number of datapoints","estimated peak","first pos level","decay rate"),
#        Pval = c(anova(lm.interval.size)$Pr[1],anova(lm.datarange)$Pr[1],anova(lm.number.of.datapoints)$Pr[1],anova(lm.estimated.peak.level)$Pr[1],anova(lm.first.pos.level)$Pr[1],anova(lm.decay.rate)$Pr[1]),
#        Fval = round(c(anova(lm.interval.size)$F[1],anova(lm.datarange)$F[1],anova(lm.number.of.datapoints)$F[1],anova(lm.estimated.peak.level)$F[1],anova(lm.first.pos.level)$F[1],anova(lm.decay.rate)$F[1]),2),
#        df = c(anova(lm.interval.size)$Df[2],anova(lm.datarange)$Df[2],anova(lm.number.of.datapoints)$Df[2],anova(lm.estimated.peak.level)$Df[2],anova(lm.first.pos.level)$Df[2],anova(lm.decay.rate)$Df[2]),
#        Effect.estimate.exp = exp(round(c(lm.interval.size$coefficients[2],lm.datarange$coefficients[2],lm.number.of.datapoints$coefficients[2],lm.estimated.peak.level$coefficients[2],lm.first.pos.level$coefficients[2],lm.decay.rate$coefficients[2]),4)),
#        AIC = round(AIC(lm.interval.size,lm.datarange,lm.number.of.datapoints,lm.estimated.peak.level,lm.first.pos.level,lm.decay.rate),1))
# 
# model.stats$Pval = round(model.stats$Pval,6)



# bayesian models:

model.stats = data.frame(
       variables = c("interval size","datarange","number of datapoints","estimated peak","first pos level","decay rate"),
       LOOIC.est = round(c(loo(lm.interval.size)$estimates[3,1],
                           loo(lm.datarange)$estimates[3,1],
                           loo(lm.number.of.datapoints)$estimates[3,1],
                           loo(lm.estimated.peak.level)$estimates[3,1],
                           loo(lm.first.pos.level)$estimates[3,1],
                           loo(lm.decay.rate)$estimates[3,1]),1),
       LOOIC.se = round(c(loo(lm.interval.size)$estimates[3,2],
                          loo(lm.datarange)$estimates[3,2],
                          loo(lm.number.of.datapoints)$estimates[3,2],
                          loo(lm.estimated.peak.level)$estimates[3,2],
                          loo(lm.first.pos.level)$estimates[3,2],
                          loo(lm.decay.rate)$estimates[3,2]),1),
       Effect.estimate.exp = round(c(exp(summary(lm.interval.size)$fixed[2,1]),
                                     exp(summary(lm.datarange)$fixed[2,1]),
                                     exp(summary(lm.number.of.datapoints)$fixed[2,1]),
                                     exp(summary(lm.estimated.peak.level)$fixed[2,1]),
                                     exp(summary(lm.first.pos.level)$fixed[2,1]),
                                     exp(summary(lm.decay.rate)$fixed[2,1])),2),
       Effect.estimate.95lo.exp = round(c(exp(summary(lm.interval.size)$fixed[2,3]),
                                          exp(summary(lm.datarange)$fixed[2,3]),
                                          exp(summary(lm.number.of.datapoints)$fixed[2,3]),
                                          exp(summary(lm.estimated.peak.level)$fixed[2,3]),
                                          exp(summary(lm.first.pos.level)$fixed[2,3]),
                                          exp(summary(lm.decay.rate)$fixed[2,3])),2),
       Effect.estimate.95hi.exp = round(c(exp(summary(lm.interval.size)$fixed[2,4]),
                                          exp(summary(lm.datarange)$fixed[2,4]),
                                          exp(summary(lm.number.of.datapoints)$fixed[2,4]),
                                          exp(summary(lm.estimated.peak.level)$fixed[2,4]),
                                          exp(summary(lm.first.pos.level)$fixed[2,4]),
                                          exp(summary(lm.decay.rate)$fixed[2,4])),2))
```


```{r}
kbl(model.stats) %>%
       kable_classic(bootstrap_options  =  c("striped", "hover","condensed"), full_width=F,html_font="Cambria",fixed_thead=T)



```


#### LOOIC values     

All for 95% CrI   




```{r results = 'hide', message=FALSE, warning=FALSE}
lm.interval.size.and.decay = brm(log(toi.information.gained.95cri.perc) ~ scale(interval.size) + scale(decay.rate.estimated.mean.pomona),data = model.outputs)

lm.interval.size.and.peak = brm(log(toi.information.gained.95cri.perc) ~ scale(interval.size) + scale(peak.titer.estimated.mean.pomona),data = model.outputs)

lm.interval.size.and.peak.and.decay = brm(log(toi.information.gained.95cri.perc) ~ scale(interval.size) + scale(peak.titer.estimated.mean.pomona) + scale(decay.rate.estimated.mean.pomona),data = model.outputs)

lm.number.of.datapoints.and.peak.and.decay = brm(log(toi.information.gained.95cri.perc) ~ scale(number.of.datapoints) + scale(peak.titer.estimated.mean.pomona) + scale(decay.rate.estimated.mean.pomona),data = model.outputs)

lm.number.of.datapoints.and.peak = brm(log(toi.information.gained.95cri.perc) ~ scale(number.of.datapoints) + scale(peak.titer.estimated.mean.pomona),data = model.outputs)


model.stats = data.frame(
       variables = c("interval size",
                     "datarange",
                     "number of datapoints",
                     "estimated peak",
                     "first pos level",
                     "decay rate",
                     "decay rate + estimated peak",
                     "decay rate + first pos",
                     "N datapoints + peak",
                     "N datapoints + decay + peak",
                     "interval size + decay rate",
                     "interval size + estimated peak",
                     "interval size + decay + peak",
                     "all variables"),
       LOOIC.est = round(c(loo(lm.interval.size)$estimates[3,1],
                           loo(lm.datarange)$estimates[3,1],
                           loo(lm.number.of.datapoints)$estimates[3,1],
                           loo(lm.estimated.peak.level)$estimates[3,1],
                           loo(lm.first.pos.level)$estimates[3,1],
                           loo(lm.decay.rate)$estimates[3,1],
                           loo(lm.decay.rate.and.estimated.peak.level)$estimates[3,1],
                           loo(lm.decay.rate.and.first.positive.level)$estimates[3,1],
                           loo(lm.number.of.datapoints.and.peak)$estimates[3,1],
                           loo(lm.number.of.datapoints.and.peak.and.decay)$estimates[3,1],
                           loo(lm.interval.size.and.decay)$estimates[3,1],
                           loo(lm.interval.size.and.peak)$estimates[3,1],
                           loo(lm.interval.size.and.peak.and.decay)$estimates[3,1],
                           loo(lm.all)$estimates[3,1]),1),
       LOOIC.se = round(c(loo(lm.interval.size)$estimates[3,2],
                          loo(lm.datarange)$estimates[3,2],
                          loo(lm.number.of.datapoints)$estimates[3,2],
                          loo(lm.estimated.peak.level)$estimates[3,2],
                          loo(lm.first.pos.level)$estimates[3,2],
                          loo(lm.decay.rate)$estimates[3,2],
                          loo(lm.decay.rate.and.estimated.peak.level)$estimates[3,2],
                          loo(lm.decay.rate.and.first.positive.level)$estimates[3,2],
                          loo(lm.number.of.datapoints.and.peak)$estimates[3,2],
                          loo(lm.number.of.datapoints.and.peak.and.decay)$estimates[3,2],
                          loo(lm.interval.size.and.decay)$estimates[3,2],
                          loo(lm.interval.size.and.peak)$estimates[3,2],
                          loo(lm.interval.size.and.peak.and.decay)$estimates[3,2],
                          loo(lm.all)$estimates[3,2]),1))

model.stats.ordered = model.stats %>%
       arrange(LOOIC.est)
```


```{r}
kbl(model.stats.ordered) %>%
       kable_classic(bootstrap_options  =  c("striped", "hover","condensed"), full_width=F,html_font="Cambria",fixed_thead=T)



```


## Model output table

<br>

```{r}


kbl(model.outputs) %>%
       kable_classic(bootstrap_options  =  c("striped", "hover","condensed"), full_width=F,html_font="Cambria",fixed_thead=T)

```

<br> <br> <br> <br>

------------------------------------------------------------------------

------------------------------------------------------------------------

------------------------------------------------------------------------

<br> <br> <br> <br>
